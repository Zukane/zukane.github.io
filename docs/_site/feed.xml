<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2025-08-13T18:25:16+02:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Zukane CTF</title><subtitle>CTF Writeups, mostly focused on crypto</subtitle><author><name>Zukane</name></author><entry><title type="html">dripfeed (DREAM 2025)</title><link href="http://localhost:4000/dripfeed/" rel="alternate" type="text/html" title="dripfeed (DREAM 2025)" /><published>2025-08-09T13:00:00+02:00</published><updated>2025-08-09T13:00:00+02:00</updated><id>http://localhost:4000/dripfeed</id><content type="html" xml:base="http://localhost:4000/dripfeed/"><![CDATA[<h5 id="challenge-source">Challenge source</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
<span class="n">e</span> <span class="o">=</span> <span class="mh">0x10001</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">768</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"DREAM{???????????????????}"</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">d</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">dinv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="n">hint1</span> <span class="o">=</span> <span class="n">dinv</span><span class="o">&gt;&gt;</span><span class="n">z</span>
<span class="n">hint2</span> <span class="o">=</span> <span class="n">d</span><span class="o">&gt;&gt;</span><span class="n">z</span>
<span class="n">hint3</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="n">dinv</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">z</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">c</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">N</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">hint1</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">hint2</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">hint3</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>as well as the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># c = 22157594335444536824539804957503224316011530105000213270082208221066593944954014666682649028694133674560156641233395573360668940167815220144267273966287820743390179842825813921564442940898448403649268126138366346541999383516847671392288475450503228921663055710261222736364832390636399799464290497677394001206519642230355468553180304124754273599272037090190669770012042290863893500557064375980418378974146770317534675349918371288413139540568026717131002910661522889107223072629684473816850628927719500755853803826053326864257172197282550241873511858288263828888477514571946188043879000715780664003346592804294011506971
# N = 25959541354095379330014211523736588310397407563027174748207817754002783083191533477890701227080867897432606754059572855046962831514143019657762820875501757389522439963278185424652050988351722479628525750386024849935812556785023617595192645219002837901875925863581668399339831969660066794677364550759132546080418952727814971975516789298857515890709426151641917337099113196461301621097058914304208257653769808452628154352488765790619868730683895851799316355220677011268783490458072512607009187871657751973095691749268293154373565622703034299847474396773677657530377712298202962607412888316384251050171382195892089032357
# hint1 = 15464998351280885049978241250677908550052088921543412055926782552569730114201666247473246055105315399223369010505411177494944031761554111167815968593847467862816540005306296674691731101951155559188695276576391852694850824877331682887724674655622324597900452774223029587809308492341771478213616624501365158861467752871506595868846315715135486074129927582766119159732319777572491731729171
# hint2 = 7029540180149905451539102727640301157454585448744864593652215724504532500936678968396248056235311937620576932024119332483872809008873452228603492327252210340060398181762267906930140059244295569523008698632999425529950595502067137205887611567798060711937625579291545624591051982915725104082620929153365192057370102698459062120006997479591134423962335183745677834764356654024492868260852
# hint3 = 190722270955073623160671606729858536606154237775586896348182992398405372984126236409160453609793655987256674610721019302148710014962419023950073167692224689931891238034456934018927853575507080194214703887834623936620950946151655803
</code></pre></div></div>

<p>We are given three hints about the RSA private key d.</p>

<h5 id="recovering-d">Recovering d</h5>

<p>Challenges involving partial information leaks are often solved by using coppersmith’s small roots method. The information given in this challenge is:</p>

<ul>
  <li>The MSBs of $d$ (1280/2048 bits)</li>
  <li>The MSBs of $d^{-1}$ (1280/2048 bits)</li>
  <li>The LSBs of the sum $d + d^{-1}$ (768/2048 bits)</li>
</ul>

<p>We can set up equations for these hints with the unknowns:</p>

\[\large \begin{align}
\nonumber d &amp;= 2^{768} \cdot \text{hint2} + x \\
\nonumber d^{-1} &amp;= 2^{768} \cdot \text{hint1} + y \\
\nonumber x+y &amp;= \text{hint3}
\end{align}\]

<p>We can utilize $hint_{3}$ to eliminate the variable $y$:</p>

\[\large \begin{align}
\nonumber d^{-1} &amp;= 2^{768} \cdot \text{hint1} + y \\
\nonumber d^{-1} &amp;= 2^{768} \cdot \text{hint1} + \text{hint3} - x 
\end{align}\]

<p>However, we must take into consideration that $hint_{3} \equiv d+d^{-1} \bmod 2^{768}$. There may be an extra $2^{768}$ term in $d^{-1}$ depending on the carry bit. In the case of the handout, this term is present:</p>

\[\large d^{-1} = 2^{768} \cdot \text{hint1} + \text{hint3} - x\]

<p>With an expression for $d$ and $d^{-1}$ in terms of $x$, we can set up the following univariate polynomial:</p>

\[\large d \cdot d^{-1} - 1\equiv 0 \mod N\]

<p>The root $x$ has an upper bound of $2^{768}$. This univariate case can easily be solved in SageMath:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">z</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>

<span class="n">d</span>    <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
<span class="n">dinv</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint1</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hint3</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">dinv</span><span class="o">-</span><span class="mi">1</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">monic</span><span class="p">().</span><span class="n">small_roots</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>
</code></pre></div></div>

<p>And with the root recovered, $d$ can be reconstructed, letting us decrypt the ciphertext:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">N</span><span class="p">)))</span>
<span class="c1"># b'DREAM{sm4ll_r00ts_2_sm4ll}'
</span></code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">c</span> <span class="o">=</span> <span class="mi">22157594335444536824539804957503224316011530105000213270082208221066593944954014666682649028694133674560156641233395573360668940167815220144267273966287820743390179842825813921564442940898448403649268126138366346541999383516847671392288475450503228921663055710261222736364832390636399799464290497677394001206519642230355468553180304124754273599272037090190669770012042290863893500557064375980418378974146770317534675349918371288413139540568026717131002910661522889107223072629684473816850628927719500755853803826053326864257172197282550241873511858288263828888477514571946188043879000715780664003346592804294011506971</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">25959541354095379330014211523736588310397407563027174748207817754002783083191533477890701227080867897432606754059572855046962831514143019657762820875501757389522439963278185424652050988351722479628525750386024849935812556785023617595192645219002837901875925863581668399339831969660066794677364550759132546080418952727814971975516789298857515890709426151641917337099113196461301621097058914304208257653769808452628154352488765790619868730683895851799316355220677011268783490458072512607009187871657751973095691749268293154373565622703034299847474396773677657530377712298202962607412888316384251050171382195892089032357</span>
<span class="n">hint1</span> <span class="o">=</span> <span class="mi">15464998351280885049978241250677908550052088921543412055926782552569730114201666247473246055105315399223369010505411177494944031761554111167815968593847467862816540005306296674691731101951155559188695276576391852694850824877331682887724674655622324597900452774223029587809308492341771478213616624501365158861467752871506595868846315715135486074129927582766119159732319777572491731729171</span>
<span class="n">hint2</span> <span class="o">=</span> <span class="mi">7029540180149905451539102727640301157454585448744864593652215724504532500936678968396248056235311937620576932024119332483872809008873452228603492327252210340060398181762267906930140059244295569523008698632999425529950595502067137205887611567798060711937625579291545624591051982915725104082620929153365192057370102698459062120006997479591134423962335183745677834764356654024492868260852</span>
<span class="n">hint3</span> <span class="o">=</span> <span class="mi">190722270955073623160671606729858536606154237775586896348182992398405372984126236409160453609793655987256674610721019302148710014962419023950073167692224689931891238034456934018927853575507080194214703887834623936620950946151655803</span>

<span class="n">z</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>

<span class="n">d</span>    <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
<span class="n">dinv</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint1</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hint3</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">dinv</span><span class="o">-</span><span class="mi">1</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">monic</span><span class="p">().</span><span class="n">small_roots</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">)</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">hint2</span><span class="o">&lt;&lt;</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">N</span><span class="p">)))</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Coppersmith small roots" /><category term="RSA" /><summary type="html"><![CDATA[Challenge source]]></summary></entry><entry><title type="html">L-iptic Curve Gimmick (DREAM 2025)</title><link href="http://localhost:4000/liptic-curve-gimmick/" rel="alternate" type="text/html" title="L-iptic Curve Gimmick (DREAM 2025)" /><published>2025-08-09T13:00:00+02:00</published><updated>2025-08-09T13:00:00+02:00</updated><id>http://localhost:4000/liptic-curve-gimmick</id><content type="html" xml:base="http://localhost:4000/liptic-curve-gimmick/"><![CDATA[<h5 id="challenge-overview">Challenge Overview</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6364136223846793005</span><span class="o">*</span><span class="n">state</span> <span class="o">+</span> <span class="mi">1442695040888963407</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">&gt;&gt;</span><span class="mi">32</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"DREAM{?????????????????????????????????}"</span>

<span class="c1"># mix it up!
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1337</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">()</span><span class="o">*</span><span class="n">G</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">()</span><span class="o">*</span><span class="n">G</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"P</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> = E(</span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">x</span><span class="p">()</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">y</span><span class="p">()</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>

<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"iv = '</span><span class="si">{</span><span class="n">iv</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"ct = '</span><span class="si">{</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
</code></pre></div></div>

<p>As well as the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P1 = E(122037775221140048457289031201689495704, 122951420735275891082341998031602353733)
P2 = E(184410941665585900129539390660771625087, 171416669794932710291436536477699627840)
P3 = E(273827286896900834170681338812413416705, 75421249071279152991789476076300962651)
iv = '3d7c4da2defd1b78a0feccbb553dd4da'
ct = '081393130914bdd8c625786160f8de0dfd0dd5a4f3c2ca946b803cfe565082849827c9c0794db358ee81bc734f0fb361'
</code></pre></div></div>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The encryption script creates an Elliptic Curve with some non-standard curve parameters.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
</code></pre></div></div>

<p>The first step is often to investigate properties of the curve parameters. In our case, it turns out that the curve order is quite smooth:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">factor</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">order</span><span class="p">())</span>
<span class="mi">11</span> <span class="o">*</span> <span class="mi">117101</span> <span class="o">*</span> <span class="mi">457517</span> <span class="o">*</span> <span class="mi">682657</span> <span class="o">*</span> <span class="mi">1814651</span> <span class="o">*</span> <span class="mi">6542287</span> <span class="o">*</span> <span class="mi">60704299</span>
</code></pre></div></div>

<p>A smooth curve order makes the discrete logarithm easy to solve by using a subgroup attack, for example by using the baby-step giant-step method.</p>

<p>The script also generates an initial state, hashes the state with SHA256 to generate a key, and generates an initialization vector. The key and IV are later used to encrypt the flag.</p>

<p>The encryption script also defines a Linear Congruential Generator</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6364136223846793005</span><span class="o">*</span><span class="n">state</span> <span class="o">+</span> <span class="mi">1442695040888963407</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">state</span><span class="o">&gt;&gt;</span><span class="mi">32</span>
</code></pre></div></div>

<p>An LCG is a pseudo-random number generator which updates the state by multiplying, adding and then reducing modulo some number. We are given the LCG parameters, but the returned state is shifted by 32 bytes, giving us only half of the state. The LCG is iterated $1337$ times, before giving us three leaks:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">()</span><span class="o">*</span><span class="n">G</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"P</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> = E(</span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">x</span><span class="p">()</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">P</span><span class="p">.</span><span class="n">y</span><span class="p">()</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
<span class="c1"># P1 = E(122037775221140048457289031201689495704, 122951420735275891082341998031602353733)
# P2 = E(184410941665585900129539390660771625087, 171416669794932710291436536477699627840)
# P3 = E(273827286896900834170681338812413416705, 75421249071279152991789476076300962651)
</span></code></pre></div></div>

<p>We have to use these points to recover the initial state of the LCG, which we can hash to recover the AES encryption key and decrypt the flag.</p>

<h5 id="implementing-the-solution">Implementing the solution</h5>

<p>Like previously mentioned, the smooth order of the elliptic curve means that the discrete logarithm problem is easy to solve with a subgroup attack. We begin by defining our known values:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">117101</span><span class="p">,</span> <span class="mi">457517</span><span class="p">,</span> <span class="mi">682657</span><span class="p">,</span> <span class="mi">1814651</span><span class="p">,</span> <span class="mi">6542287</span><span class="p">,</span> <span class="mi">60704299</span><span class="p">]</span> <span class="c1"># factor(E.order())
</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">122037775221140048457289031201689495704</span><span class="p">,</span> <span class="mi">122951420735275891082341998031602353733</span><span class="p">)</span>
<span class="n">P2</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">184410941665585900129539390660771625087</span><span class="p">,</span> <span class="mi">171416669794932710291436536477699627840</span><span class="p">)</span>
<span class="n">P3</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">273827286896900834170681338812413416705</span><span class="p">,</span> <span class="mi">75421249071279152991789476076300962651</span><span class="p">)</span>
</code></pre></div></div>

<p>The subgroup attack works by solving the discrete log for each individual factor, then combining the results with the Chinese Remainder Theorem.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">bsgs</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">primes</span><span class="p">):</span>
    <span class="n">dlogs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fac</span> <span class="ow">in</span> <span class="n">primes</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Iteration for </span><span class="si">{</span><span class="n">fac</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">order</span><span class="p">()</span> <span class="o">//</span> <span class="n">fac</span>
        <span class="n">dlog</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">Q</span><span class="p">,</span> <span class="n">t</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>
        <span class="n">dlogs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dlog</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">crt</span><span class="p">(</span><span class="n">dlogs</span><span class="p">,</span> <span class="n">primes</span><span class="p">)</span>
</code></pre></div></div>

<p>By running this function on each $P_{1},P_{2},P_{3}$ and the curve’s generator point $G$, we can recover the three outputs of the <code class="language-plaintext highlighter-rouge">LCG()</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">truncated_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">bsgs</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">factors</span><span class="p">)</span> <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="p">[</span><span class="n">P1</span><span class="p">,</span><span class="n">P2</span><span class="p">,</span><span class="n">P3</span><span class="p">]]</span>
<span class="c1"># [1939624097, 3628133847, 3055123311]
</span></code></pre></div></div>

<p>These bit shifted states, or rather <code class="language-plaintext highlighter-rouge">truncated</code> states, can actually be used along with the LCG parameters to recover the complete states. Implementations for a <code class="language-plaintext highlighter-rouge">truncated state recovery attack</code> exist online, for example in https://github.com/jvdsn/crypto-attacks/blob/master/attacks/lcg/truncated_state_recovery.py. The details of this attack can be a bit complicated, but using the function is quite plug-and-play.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/lcg/truncated_state_recovery.py
</span><span class="k">def</span> <span class="nf">truncated_lcg_attack</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">diff_bit_length</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">s</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">diff_bit_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">**</span> <span class="n">i</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">QQ</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">truncated_lcg_attack</span><span class="p">(</span><span class="n">truncated_states</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">,</span> <span class="mi">6364136223846793005</span><span class="p">,</span> <span class="mi">1442695040888963407</span><span class="p">)</span>
<span class="c1"># [8330622065471768203, 15582716220711197886, 13121654707256889525]
</span></code></pre></div></div>

<p>With the full states recovered, we can construct a function to perform the inverse steps of the LCG. The encryption script performed $1337$ iterations, then $3$ more for the elliptic curve points. We can pick the first recovered state and step back 1338 iterations:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">M</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span>
<span class="n">A</span>  <span class="o">=</span> <span class="mi">6364136223846793005</span>
<span class="n">C</span>  <span class="o">=</span> <span class="mi">1442695040888963407</span>
<span class="n">Ainv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="n">M</span>
<span class="k">def</span> <span class="nf">inverse_LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ainv</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span> <span class="o">-</span> <span class="n">C</span><span class="p">))</span> <span class="o">%</span> <span class="n">M</span>
    <span class="k">return</span> <span class="n">state</span>

<span class="n">state0</span> <span class="o">=</span> <span class="p">[</span><span class="n">inverse_LCG</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1338</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<p>Finally, we can hash <code class="language-plaintext highlighter-rouge">state0</code> to get the AES-CBC encryption key, and decrypt the flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state0</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">)),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
<span class="c1"># DREAM{E_1n_LCG_st4nd5_4_Ell1pt1c_Curv3s}
</span></code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">unpad</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">289938057806527723758225206013420438469</span> 
<span class="n">a</span> <span class="o">=</span> <span class="mi">131472054804376335219486973894036812363</span> 
<span class="n">b</span> <span class="o">=</span> <span class="mi">168821582640259041697285427337782028716</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">117101</span><span class="p">,</span> <span class="mi">457517</span><span class="p">,</span> <span class="mi">682657</span><span class="p">,</span> <span class="mi">1814651</span><span class="p">,</span> <span class="mi">6542287</span><span class="p">,</span> <span class="mi">60704299</span><span class="p">]</span> <span class="c1"># factor(E.order())
</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">122037775221140048457289031201689495704</span><span class="p">,</span> <span class="mi">122951420735275891082341998031602353733</span><span class="p">)</span>
<span class="n">P2</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">184410941665585900129539390660771625087</span><span class="p">,</span> <span class="mi">171416669794932710291436536477699627840</span><span class="p">)</span>
<span class="n">P3</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">273827286896900834170681338812413416705</span><span class="p">,</span> <span class="mi">75421249071279152991789476076300962651</span><span class="p">)</span>
<span class="n">iv</span> <span class="o">=</span> <span class="s">'3d7c4da2defd1b78a0feccbb553dd4da'</span>
<span class="n">ct</span> <span class="o">=</span> <span class="s">'081393130914bdd8c625786160f8de0dfd0dd5a4f3c2ca946b803cfe565082849827c9c0794db358ee81bc734f0fb361'</span>

<span class="k">def</span> <span class="nf">bsgs</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">primes</span><span class="p">):</span>
    <span class="n">dlogs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fac</span> <span class="ow">in</span> <span class="n">primes</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Iteration for </span><span class="si">{</span><span class="n">fac</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">order</span><span class="p">()</span> <span class="o">//</span> <span class="n">fac</span>
        <span class="n">dlog</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">Q</span><span class="p">,</span> <span class="n">t</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>
        <span class="n">dlogs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dlog</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">crt</span><span class="p">(</span><span class="n">dlogs</span><span class="p">,</span> <span class="n">primes</span><span class="p">)</span>

<span class="n">truncated_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">bsgs</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">factors</span><span class="p">)</span> <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="p">[</span><span class="n">P1</span><span class="p">,</span><span class="n">P2</span><span class="p">,</span><span class="n">P3</span><span class="p">]]</span>

<span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/lcg/truncated_state_recovery.py
</span><span class="k">def</span> <span class="nf">truncated_lcg_attack</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">diff_bit_length</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">s</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">diff_bit_length</span><span class="p">)</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">**</span> <span class="n">i</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">QQ</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="n">states</span> <span class="o">=</span> <span class="n">truncated_lcg_attack</span><span class="p">(</span><span class="n">truncated_states</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">,</span> <span class="mi">6364136223846793005</span><span class="p">,</span> <span class="mi">1442695040888963407</span><span class="p">)</span>

<span class="n">M</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span>
<span class="n">A</span>  <span class="o">=</span> <span class="mi">6364136223846793005</span>
<span class="n">C</span>  <span class="o">=</span> <span class="mi">1442695040888963407</span>
<span class="n">Ainv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">%</span><span class="n">M</span>
<span class="k">def</span> <span class="nf">inverse_LCG</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ainv</span> <span class="o">*</span> <span class="p">(</span><span class="n">state</span> <span class="o">-</span> <span class="n">C</span><span class="p">))</span> <span class="o">%</span> <span class="n">M</span>
    <span class="k">return</span> <span class="n">state</span>

<span class="n">state0</span> <span class="o">=</span> <span class="p">[</span><span class="n">inverse_LCG</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1338</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">state0</span><span class="p">).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">)),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Elliptic Curve" /><category term="LCG" /><category term="Truncated attack" /><summary type="html"><![CDATA[Challenge Overview]]></summary></entry><entry><title type="html">mvm sum problem (DREAM 2025)</title><link href="http://localhost:4000/mvm-sum-problem/" rel="alternate" type="text/html" title="mvm sum problem (DREAM 2025)" /><published>2025-08-09T13:00:00+02:00</published><updated>2025-08-09T13:00:00+02:00</updated><id>http://localhost:4000/mvm-sum-problem</id><content type="html" xml:base="http://localhost:4000/mvm-sum-problem/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>
<span class="kn">import</span> <span class="nn">secrets</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"DREAM{???????????????????????????????????????????????????????????????}"</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">secrets</span><span class="p">.</span><span class="n">randbits</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">secrets</span><span class="p">.</span><span class="n">randbits</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">ai</span><span class="o">*</span><span class="n">si</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="n">A_mod</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ai</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"A = </span><span class="si">{</span><span class="n">A_mod</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"b = </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"t = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"iv = '</span><span class="si">{</span><span class="n">iv</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"ct = '</span><span class="si">{</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
</code></pre></div></div>

<p>as well as the output in <code class="language-plaintext highlighter-rouge">output.txt</code></p>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The encryption script generates an $n \times n$ matrix $A$ and a vector $s$, then calculates:</p>

\[\large x = \sum_{i=0}^{n}a_{i} s_{i}\]

<p>for each row $a_{i}$ in $A$. The user is then given the following:</p>

\[\large \begin{align}
\nonumber A_{mod} &amp;\equiv A \mod p \\
\nonumber b &amp;\equiv x \mod p \\
\nonumber t &amp;= x &gt;&gt; 48
\end{align}\]

<p>The secret vector $s$ is concatenated, then hashed to produce the AES-CBC key which encrypts the flag.</p>

<h5 id="recovering-p">Recovering p</h5>

<p>This already almost seems like a subset sum problem, but only the most significant bits of $x$ are given. It also almost looks like a modular subset sum problem, but the modulo $p$ is not given. However, with both $b$ and $t$ given, we can set up an <code class="language-plaintext highlighter-rouge">AGCD</code> or an “Approximate Greatest Common Divisor” instance to recover the modulo $p$:</p>

\[\large \begin{align}
\nonumber b &amp;= x \mod p \\
\nonumber b &amp;= x + k \cdot p \\
\nonumber b - x &amp;= k \cdot p
\end{align}\]

<p>we are not given $x$ exactly, but $x = t \cdot 2^{48} + r$ for some lower bits remainder $r &lt; 2^{48}$. So, the AGCD instance is:</p>

\[\large b_{i} - t_{i} \cdot 2^{48} = k_{i} \cdot p + r_{i}\]

<p>We can use the orthogonal lattice AGCD implementation from https://github.com/jvdsn/crypto-attacks/blob/master/attacks/acd/ol.py to solve for $p$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/acd/ol.py
</span><span class="k">def</span> <span class="nf">AGCD</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">rho</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">submatrix</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)).</span><span class="n">right_kernel</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">an_element</span><span class="p">()</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">symmetric_mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r0</span><span class="p">)</span> <span class="o">//</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">symmetric_mod</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="o">-</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">ri</span> <span class="o">&lt;</span> <span class="n">R</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">r</span>
        
<span class="n">y</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ti</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="n">bi</span> <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">AGCD</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">48</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<h5 id="recovering-s">Recovering s</h5>

<p>With the modulus $p$ recovered, we now have a multiple modular subset sum problem:</p>

\[\large b\equiv \sum_{i=0}^{n} a_{i} s_{i} \mod p\]

<p>for each row $a$ in $A$. With $b$, $A$ and $p$, we can use MMSSP to solve for $s$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># https://hackmd.io/@L4m/B1Vpr_vK0
</span><span class="k">def</span> <span class="nf">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">multi</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">modul</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">multi</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">multi</span><span class="p">).</span><span class="n">T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">multi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">tmp_</span> <span class="o">=</span>  <span class="n">Matrix</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_</span> <span class="o">+</span> <span class="p">[</span><span class="n">N</span><span class="o">*</span><span class="n">modul</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="n">_</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp_</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</code></pre></div></div>

<p>With the secret vector $s$ recovered, decryption becomes trivial. The bits are concatenated, hashed, and then the resulting key is used for AES-CBC decryption:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">]).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">())),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
<span class="c1"># DREAM{AGCD_4nd_MvMSSP_2_m4ny_4bbr3v14t10ns_but_pl34s3_d3l3t3_GPT5_n0w}
</span></code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>
<span class="kn">import</span> <span class="nn">secrets</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">hashlib</span><span class="p">,</span> <span class="n">ast</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">unpad</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"output.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">A</span>  <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">b</span>  <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">t</span>  <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"'"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"'"</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">symmetric_mod</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="n">m</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># https://github.com/jvdsn/crypto-attacks/blob/master/attacks/acd/ol.py
</span><span class="k">def</span> <span class="nf">AGCD</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">rho</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span>
        <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">submatrix</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)).</span><span class="n">right_kernel</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">an_element</span><span class="p">()</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">symmetric_mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r0</span><span class="p">)</span> <span class="o">//</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">symmetric_mod</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="o">-</span><span class="n">R</span> <span class="o">&lt;</span> <span class="n">ri</span> <span class="o">&lt;</span> <span class="n">R</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">r</span>

<span class="c1"># https://hackmd.io/@L4m/B1Vpr_vK0
</span><span class="k">def</span> <span class="nf">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">multi</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">modul</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">multi</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">multi</span><span class="p">).</span><span class="n">T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">multi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">tmp_</span> <span class="o">=</span>  <span class="n">Matrix</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_</span> <span class="o">+</span> <span class="p">[</span><span class="n">N</span><span class="o">*</span><span class="n">modul</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="n">_</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp_</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">y</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ti</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-</span> <span class="n">bi</span> <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Solving AGCD..."</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">AGCD</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">48</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Recovered p: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Solving MMSSP..."</span><span class="p">)</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">Multiple_Modular_Subset_Sum_Problem</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Potential solution: </span><span class="si">{</span><span class="n">sol</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">]).</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">()</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">ct</span><span class="p">.</span><span class="nb">hex</span><span class="p">())),</span><span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
<span class="c1"># DREAM{AGCD_4nd_MvMSSP_2_m4ny_4bbr3v14t10ns_but_pl34s3_d3l3t3_GPT5_n0w}
</span></code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="AGCD" /><category term="Subset sum problem" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Diamond Ticket (idekCTF 2025)</title><link href="http://localhost:4000/diamond-ticket/" rel="alternate" type="text/html" title="Diamond Ticket (idekCTF 2025)" /><published>2025-08-02T12:00:00+02:00</published><updated>2025-08-02T12:00:00+02:00</updated><id>http://localhost:4000/diamond-ticket</id><content type="html" xml:base="http://localhost:4000/diamond-ticket/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Some magic from Willy Wonka
</span><span class="n">p</span> <span class="o">=</span> <span class="mi">170829625398370252501980763763988409583</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">164164878498114882034745803752027154293</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">125172356708896457197207880391835698381</span>

<span class="k">def</span> <span class="nf">chocolate_generator</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>

<span class="c1">#The diamond ticket is hiding inside chocolate
</span><span class="n">diamond_ticket</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">diamond_ticket</span><span class="p">)</span> <span class="o">==</span> <span class="mi">26</span>
<span class="k">assert</span> <span class="n">diamond_ticket</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s">"idek{"</span>
<span class="k">assert</span> <span class="n">diamond_ticket</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="sa">b</span><span class="s">"}"</span>
<span class="n">diamond_ticket</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">diamond_ticket</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">flag_chocolate</span> <span class="o">=</span> <span class="n">chocolate_generator</span><span class="p">(</span><span class="n">diamond_ticket</span><span class="p">)</span>
<span class="n">chocolate_bag</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#Willy Wonka are making chocolates
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1337</span><span class="p">):</span> <span class="c1"># 1337 random szám
</span>    <span class="n">chocolate_bag</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">getRandomRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

<span class="c1">#And he put the golden ticket at the end
</span><span class="n">chocolate_bag</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag_chocolate</span><span class="p">)</span> <span class="c1"># az utolsó a flag
</span>
<span class="c1">#Augustus ate lots of chocolates, but he can't eat all cuz he is full now :D
</span><span class="n">remain</span> <span class="o">=</span> <span class="n">chocolate_bag</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="c1"># az első 4 random szám, az utolsó a flag
</span>
<span class="c1">#Compress all remain chocolates into one
</span><span class="n">remain_bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">bit_length</span><span class="p">()</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="s">"big"</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">remain</span><span class="p">])</span> 

<span class="c1">#The last chocolate is too important, so Willy Wonka did magic again
</span><span class="n">P</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">Q</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s">"idek{this_is_a_fake_flag_lolol}"</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">c1</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="c1"># A small gift
</span>
<span class="c1">#How can you get it ?
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">N</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">c1</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">c2</span> <span class="o">=</span> <span class="si">}</span><span class="s">"</span><span class="p">)</span> 
</code></pre></div></div>

<p>As well as the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>N = 85494791395295332945307239533692379607357839212287019473638934253301452108522067416218735796494842928689545564411909493378925446256067741352255455231566967041733698260315140928382934156213563527493360928094724419798812564716724034316384416100417243844799045176599197680353109658153148874265234750977838548867
c1 = 27062074196834458670191422120857456217979308440332928563784961101978948466368298802765973020349433121726736536899260504828388992133435359919764627760887966221328744451867771955587357887373143789000307996739905387064272569624412963289163997701702446706106089751532607059085577031825157942847678226256408018301
c2 = 30493926769307279620402715377825804330944677680927170388776891152831425786788516825687413453427866619728035923364764078434617853754697076732657422609080720944160407383110441379382589644898380399280520469116924641442283645426172683945640914810778133226061767682464112690072473051344933447823488551784450844649
</code></pre></div></div>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>This challenge consists of multiple parts. Firstly, we are given two RSA ciphertexts of the same message with the same modulus. The encrypted message is <code class="language-plaintext highlighter-rouge">remain_bytes</code>, which consists of five concatenated elements of <code class="language-plaintext highlighter-rouge">chocolate_bag</code>. Four of these are random numbers, while the final element is <code class="language-plaintext highlighter-rouge">flag_chocolate</code>.</p>

<p><code class="language-plaintext highlighter-rouge">flag_chocolate</code> is the flag output of the <code class="language-plaintext highlighter-rouge">chocolate_generator(m)</code> function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">chocolate_generator</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
</code></pre></div></div>

<p>We must recover <code class="language-plaintext highlighter-rouge">flag_chocolate</code> from the RSA output, and then recover the message $m$ from the equation</p>

\[\large a^{m} + b^{m} \mod p\]

<p>Where $m$ is the 20-byte plaintext flag</p>

<h5 id="recovering-flag_chocolate">Recovering flag_chocolate</h5>

<p>Like previously mentioned, we are given two RSA samples of the same message, encrypted with different exponents but the same modulus. This makes the plaintext susceptible to an RSA common modulus attack. We can use the implementation from <code class="language-plaintext highlighter-rouge">jvdsn</code>’s repo: https://github.com/jvdsn/crypto-attacks/blob/master/attacks/rsa/common_modulus.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">xgcd</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p1</span> <span class="o">*</span> <span class="n">p2</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">).</span><span class="n">nth_root</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
</code></pre></div></div>

<p>We can simply input the parameters from the source code, and we easily recover <code class="language-plaintext highlighter-rouge">flag_chooclate</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span> <span class="o">=</span> <span class="mi">85494791395295332945307239533692379607357839212287019473638934253301452108522067416218735796494842928689545564411909493378925446256067741352255455231566967041733698260315140928382934156213563527493360928094724419798812564716724034316384416100417243844799045176599197680353109658153148874265234750977838548867</span>
<span class="n">c1</span> <span class="o">=</span> <span class="mi">27062074196834458670191422120857456217979308440332928563784961101978948466368298802765973020349433121726736536899260504828388992133435359919764627760887966221328744451867771955587357887373143789000307996739905387064272569624412963289163997701702446706106089751532607059085577031825157942847678226256408018301</span>
<span class="n">c2</span> <span class="o">=</span> <span class="mi">30493926769307279620402715377825804330944677680927170388776891152831425786788516825687413453427866619728035923364764078434617853754697076732657422609080720944160407383110441379382589644898380399280520469116924641442283645426172683945640914810778133226061767682464112690072473051344933447823488551784450844649</span>
<span class="n">e1</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s">"idek{this_is_a_fake_flag_lolol}"</span><span class="p">)</span>
<span class="n">e2</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">remain_bytes</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">attack</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">e1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">e2</span><span class="p">,</span><span class="n">c2</span><span class="p">))</span>
<span class="n">remain</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">16</span><span class="p">],</span> <span class="s">"big"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">remain_bytes</span><span class="p">),</span> <span class="mi">16</span><span class="p">)]</span>
<span class="n">flag_chocolate</span> <span class="o">=</span> <span class="n">remain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># 99584795316725433978492646071734128819
</span></code></pre></div></div>

<h5 id="recovering-the-original-m">Recovering the original m</h5>

<p>With <code class="language-plaintext highlighter-rouge">flag_chocolate</code> recovered, we now must recover the original flag from the equation. From here on, we denote <code class="language-plaintext highlighter-rouge">flag_chocolate</code> as $S$.</p>

\[\large S \equiv a^{m} + b^{m} \mod p\]

<p>Firstly, we notice that $p$ is a prime. We therefore work in the finite field $\mathbb{F}_{p}$. In SageMath, we can check the order $r$ of the field:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">p</span>  <span class="o">=</span> <span class="mi">170829625398370252501980763763988409583</span>
<span class="p">....:</span> <span class="n">a</span>  <span class="o">=</span> <span class="mi">164164878498114882034745803752027154293</span>
<span class="p">....:</span> <span class="n">b</span>  <span class="o">=</span> <span class="mi">125172356708896457197207880391835698381</span>
<span class="p">....:</span> <span class="n">F</span>  <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">multiplicative_order</span><span class="p">()</span>
<span class="mi">85414812699185126250990381881994204791</span>
</code></pre></div></div>

<p>It turns out, the order of the field is surprisingly smooth:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">factor</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">multiplicative_order</span><span class="p">())</span>
<span class="mi">40841</span> <span class="o">*</span> <span class="mi">50119</span> <span class="o">*</span> <span class="mi">51193</span> <span class="o">*</span> <span class="mi">55823</span> <span class="o">*</span> <span class="mi">57809</span> <span class="o">*</span> <span class="mi">61991</span> <span class="o">*</span> <span class="mi">63097</span> <span class="o">*</span> <span class="mi">64577</span>
</code></pre></div></div>

<p>This means calculating discrete logs is quite easy. We can calculate the discrete log</p>

\[\large b = a^{k} \mod p\]

<p>for some $k$. Afterwards, we can rewrite our equation to:</p>

\[\large S \equiv a^{m} + a^{mk} \mod p\]

<p>The discrete log is easily calculable in SageMath, and since the order is smooth, it is almost instant:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">multiplicative_order</span><span class="p">()</span>
<span class="n">sage</span><span class="p">:</span> <span class="n">k</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">ord</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
<span class="c1"># 73331
</span></code></pre></div></div>

<p>The exponent $k = 73331$, which seems intentional considering it is $13337$ backwards. We denote $a^{m}$ as $x$, and we are now left with the polynomial:</p>

\[\large x + x^{k} - S \equiv 0 \mod p\]

<p>By finding the root of this polynomial, we can find $a^{m} \bmod p$, where we can again solve for the discrete log, retrieving $m$. However, simply attempting <code class="language-plaintext highlighter-rouge">f.roots(multiplicities=False)</code> in SageMath is not enough. I used the <code class="language-plaintext highlighter-rouge">Cantor - Zassnehaus</code> method to find the root:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">R</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">^</span><span class="n">k</span> <span class="o">-</span> <span class="n">flag_chocolate</span>

<span class="k">def</span> <span class="nf">unique_root</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">characteristic</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">random_element</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">poly</span><span class="p">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">power_mod</span><span class="p">(</span><span class="n">g</span><span class="p">,(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">poly</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="n">gcd</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">poly</span><span class="p">.</span><span class="n">degree</span><span class="p">():</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">h</span>  
            <span class="k">if</span> <span class="n">poly</span><span class="p">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  

<span class="n">root</span> <span class="o">=</span> <span class="n">unique_root</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  
<span class="c1"># 126961729658296101306560858021273501485
</span></code></pre></div></div>

<p>With the root $a^{m} \bmod p$ recovered, we can now recover $m$ using the discrete log:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">m</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">ord</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>  
<span class="c1"># 4807895356063327854843653048517090061
</span></code></pre></div></div>

<p>However, the recovered $m$ is not the complete plaintext. The original plaintext is 20 bytes, or rather 159 bits (because of leading 0 bit in ascii) while our modulus $p$ is 128 bits. To recover the complete 160 bit plaintext flag, we must lift the modulus and brute-force the missing factor $k$:</p>

\[\large \text{flag} = m + k \cdot r\]

<p>To verify if the flag is correct (or at least a candidate), we can check whether all flag bytes are printable ascii (between 32 and 126). With a 127 bit modulus $r$ and a 160 bit plaintext, the missing factor $k$ has an upper bound of $2^{33}$. This is doable in python/SageMath, but can be done a lot faster in a low-level language like c++ or rust. I wrote a brute-force code in c++ which iterates over possible values $k$ and prints the flag candidates:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>idek{ cm &amp;d@05 CS*q_[6Xxo}, k = 2164788270
idek{"pVJWCNmgg59#/c,A1lf}, k = 2301835951
idek{**}iVY9U:VhDtYv|Z@Un}, k = 2818307047
idek{+MUks($7Mgr}k^M9EMB0}, k = 2894242741
idek{,uMCt7xQoGqB+=Vkz"X0}, k = 2971516341
idek{-'0v|lsh/#JFnY?_!S\S}, k = 3017960554
idek{-;dC^#LP]I\3ke*iKIzV}, k = 3023235135
idek{-{=G(2|N955PXau;%,;"}, k = 3039904979
idek{9nRCVJsLMOij?QU/&amp;Dj4}, k = 3838593233
idek{=rL&gt;7&gt;`HH?z dwF#\Rsb}, k = 4106985107
idek{&gt;Xs\C7)bg1"_CB5p('| }, k = 4167075141
idek{&gt;`6D\-v^1DVo9nAbY{f?}, k = 4169101534
idek{@cL5&amp;a3iu~~jwMu~?68`}, k = 4303584005
idek{A-;4;6kR&amp;xjp"ebkaFYf}, k = 4356306351
idek{ALZ&gt;fE\}Lu,\6ku;5v/S}, k = 4364431722
idek{Aqcll#(*wLKg{k: 9x!a}, k = 4374101324
idek{D=7q7ZmjJU+/_SET(k&lt;Z}, k = 4560995163
idek{DjeT|t!M&amp;o#~TYeKTaL^}, k = 4572790903
idek{ETJ|+J+~B{q;f1$cJdO?}, k = 4633858014
idek{F\eth:*"=Oq5qXM0@I(Q}, k = 4702812636
idek{GGqO`:j0, OVhGk6`QI=}, k = 4764180304
idek{H+@B~2[q{UtzIEEU+&lt;7r}, k = 4823658243
idek{J$\Gu~.)Be{/#`@Y@a"7}, k = 4955536038
idek{L[&amp;RdOPDT2*D}q?Oi^Xu}, k = 5103517656
idek{N`(&lt;}~b*iHSmtz4'X68g}, k = 5238501878
idek{OH&amp;F`@GGUpsVMHkX![hM}, k = 5299072192
idek{P5bxoo)'46];&gt;`])&gt;)pE}, k = 5361011336
idek{Q.=k;. PCu,q#}OZ}|f6}, k = 5425984351
idek{TK%_6N?GvA@z.F Vvi$P}, k = 5634046613
idek{T}bLK\y7=7h"EKU&amp;!@PU}, k = 5647163128
idek{W)pA[}X(cS&gt;`w16l'cYn}, k = 5825761255
idek{Y6'g2eA?&lt;DfH$33f}:+@}, k = 5962757925
idek{YoFMQ?|I!,U'?hAYTwL`}, k = 5977671429
idek{^Swy+98nqf3F#M5 ZD- }, k = 6304603205
idek{a_DUV.bwgVg0G5=Q1Z+B}, k = 6508199347
idek{dX5Z:`_B:w E?2g`A96&gt;}, k = 6706871703
idek{d}Okl]'GAP^Re#-aPEHM}, k = 6716558528
idek{hdmhF2o7XO#XIY=&lt;7&amp;a[}, k = 6977415586
idek{iD(*_@q"aQ 6&gt;H#H' Mw}, k = 7035828582
idek{kV*_rGI-Q]z8z{+A[-v&lt;}, k = 7174207241
idek{l=Mt0@&amp;;3]+))wOQxxLW}, k = 7234554246
idek{n }W~-LJ(qb&lt;\kw4aR,#}, k = 7360708378
idek{ng0qo1rmR2_jS[;,Q1UM}, k = 7379167168
idek{o-Z4t_oZ[_.Fng} W0`&lt;}, k = 7430905097
idek{tks_f0r_ur_t1ck3t_xD}, k = 7781310273 &lt;- our flag
idek{u]aAv}2(KI~?.yrgmhxS}, k = 7844474986
idek{w_"knU](04jH_hi*&lt;.xy}, k = 7978609908
idek{zxZmPiv]iZ,1fSH|9_m,}, k = 8185709465
idek{~&gt;AkP(C2`p-DWPSe2=_t}, k = 8437894545
</code></pre></div></div>

<p>With $k = 7781310273$ we recover our flag: <code class="language-plaintext highlighter-rouge">idek{tks_f0r_ur_t1ck3t_xD}</code> !</p>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="RSA" /><category term="Common Modulus attack" /><category term="Diophantine" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">SHA-CTR (CERT.PL 2025)</title><link href="http://localhost:4000/SHA-CTR/" rel="alternate" type="text/html" title="SHA-CTR (CERT.PL 2025)" /><published>2025-07-15T13:00:00+02:00</published><updated>2025-07-15T13:00:00+02:00</updated><id>http://localhost:4000/SHA-CTR</id><content type="html" xml:base="http://localhost:4000/SHA-CTR/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given the source code for a remote instance:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha512</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">([(</span><span class="n">aa</span> <span class="o">^</span> <span class="n">bb</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)])</span>


<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">nonce</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">block_size</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">//</span> <span class="mi">8</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="p">.</span><span class="n">batched</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)):</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="mi">010</span><span class="si">}</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">keystream</span> <span class="o">=</span> <span class="n">sha512</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="n">nonce</span> <span class="o">+</span> <span class="n">counter</span><span class="p">).</span><span class="n">digest</span><span class="p">()</span>
        <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">keystream</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">block</span><span class="p">)))</span>
    <span class="k">return</span> <span class="sa">b</span><span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_ciphertext</span><span class="p">(</span><span class="n">nonce</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.bmp"</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">nonce</span> <span class="o">=</span> <span class="n">binascii</span><span class="p">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"nonce:"</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">get_ciphertext</span><span class="p">(</span><span class="n">nonce</span><span class="p">)).</span><span class="n">decode</span><span class="p">())</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>as well as an example_flag.bmp image.</p>

<h5 id="length-extension">Length extension</h5>

<p>The encryption service implements a custom stream cipher using SHA512. We have the ability to encrypt the flag.bmp file with a chosen nonce. The plaintext data is split into blocks of size 64, and for each block, a keystream is generated and XORed with the block:</p>

\[\large \begin{align}
\nonumber keystream_{i} &amp;= SHA512(key \space \| \space nonce \space \| \space ctr_{i}) \\
\nonumber ct _{i} &amp;= keystream_{i} \oplus block_{i}
\end{align}\]

<p>Using SHA512 in this fashion is dangerous, as it opens up the possibility for a length extension attack. A length extension attack allows a user to calculate the hash $Hash(secret \space | \space message)$ if the length of the <code class="language-plaintext highlighter-rouge">secret</code> is known, and the <code class="language-plaintext highlighter-rouge">message</code> is known. If we can generate the hash (keystream) for each of the predictable counters, even without knowing the key, we can decrypt the encrypted flag image. In our case, this <code class="language-plaintext highlighter-rouge">message</code> is comprised of the chosen nonce and the known counter. In addition to this, SHA512 includes some internal padding since it handles 128-byte chunks at a time.</p>

<p>We begin by sending an empty nonce <code class="language-plaintext highlighter-rouge">b''</code> in the first round. The encryption service will generate a keystream by hashing:</p>

\[\large keystream_{0} = SHA512(key \space \| \space ctr_{0} \space \| \space padding)\]

<p>We have a 32 byte key and a 10 byte counter, which means we have 86 bytes of padding being hashed. This $keystream_{0}$ will be a vital piece of information later. We can denote this keystream or hash as $H_{0}$. On the second (and last) query, we set the nonce to $(ctr_{0} \space | \space padding)$. The encryption service will then generate a keystream by hashing:</p>

\[\large keystream_{0} = SHA512(key \space \| \space ctr_{0} \space \| \space padding_{0} \space \| \space ctr_{i} \space \| \space padding_{i})\]

<p>Now, the data to be hashed has surpassed 128 bytes in length. Internally, SHA512 will digest the first block $key \space | \space ctr_{0} \space | \space padding_{0}$, update the internal state, then digest the second block $ctr_{i} \space | \space padding_{i}$. The updated internal state will be $H_{0}$. If we are able to recover this $H_{0}$, we can set the known internal state of a SHA512 copy locally, and process each $i$ possible second blocks. This way, we are able to recover all keystreams and hence decrypt the encrypted flag by XOR.</p>

<h5 id="attack-implementation">Attack implementation</h5>

<p>The attack hinges on knowing $H_{0}$ or rather $keystream_{0}$. By sending in an empty nonce to the encryption service, we receive</p>

\[\large ct_{0} = pt_{0} \oplus H_{0}\]

<p>If we knew the first plaintext block of the flag, then $H_{0}$ would be recoverable. Luckily for us, the challenge gave us an example_flag.bmp file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xxd -p -l 64 example_flag.bmp
424dee3b0000000000003600000028000000c40000001a00000001001800
00000000b83b000000000000000000000000000000000000ffffffffffff
ffffffff
</code></pre></div></div>

<p>The BMP header consists of magic bytes, dimension fields, size fields, and some <code class="language-plaintext highlighter-rouge">ffffffffff</code> pixel values at the end (white pixels). This is all predictable information, as the flag will most likely have the same dimensions, the same size (can be verified by the ciphertext size) and also include white pixels in that position. Therefore, with high likelihood, the first plaintext block of the example flag, and the actual flag, is the same.</p>

<p>This way, we can recover $H_{0}$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">known_plain</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span>
    <span class="s">"424dee3b0000000000003600000028000000c40000001a00000001001800"</span>
    <span class="s">"00000000b83b000000000000000000000000000000000000ffffffffffff"</span>
    <span class="s">"ffffffff"</span>
<span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"nonce:"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">""</span><span class="p">)</span> <span class="c1"># empty nonce
</span><span class="n">cipher0</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span> <span class="c1"># get ciphertext
</span><span class="n">state_ints</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">cipher0</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="n">known_plain</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span> <span class="c1"># xor 
</span></code></pre></div></div>

<p>$H_{0}$ is split up into <code class="language-plaintext highlighter-rouge">state_ints</code> to be later processed as the SHA512 internal state. From here, we can prepare the second step. Padding in SHA2 is structured like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\x80 + many \x00 + 16-byte length field 
</code></pre></div></div>

<p>We recall that we have 86 bytes of padding, since the counter is 10 bytes and the key is 32 bytes. With the <code class="language-plaintext highlighter-rouge">\x80</code> padding “header” and the 16 byte length field, we are left with 69 null-bytes. We construct the padding and nonce like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">KEY_LEN</span>      <span class="o">=</span> <span class="mi">32</span>
<span class="n">CTR_LEN</span>      <span class="o">=</span> <span class="mi">10</span>
<span class="n">first_ctr</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"0"</span> <span class="o">*</span> <span class="n">CTR_LEN</span>
<span class="n">pad</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x80</span><span class="s">"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">69</span> <span class="o">+</span> <span class="p">((</span><span class="n">KEY_LEN</span> <span class="o">+</span> <span class="n">CTR_LEN</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">nonce</span> <span class="o">=</span> <span class="n">first_ctr</span> <span class="o">+</span> <span class="n">pad</span>
</code></pre></div></div>

<p>After sending the nonce, we receive the corresponding encrypted flag.bmp. This data has to be handled in blocks of 64. For each block, we generate the predictable counter $ctr_{i}$, then we generate it’s corresponding padding (now 118 bytes since the second block consists of just the counter), before the block is fed to the internal SHA512 copy with the <code class="language-plaintext highlighter-rouge">state_ints</code> from $H_{0}$:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">second_block</span><span class="p">(</span><span class="n">counter</span><span class="p">):</span>
    <span class="n">total_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">KEY_LEN</span> <span class="o">+</span> <span class="n">CTR_LEN</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="n">CTR_LEN</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="k">return</span> <span class="n">counter</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x80</span><span class="s">"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">101</span> <span class="o">+</span> <span class="n">total_bits</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="k">for</span> <span class="n">block_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">),</span> <span class="n">BLOCK_SIZE</span><span class="p">):</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">block_index</span><span class="o">//</span><span class="n">BLOCK_SIZE</span><span class="si">:</span><span class="mi">010</span><span class="si">}</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">ks_words</span> <span class="o">=</span> <span class="n">sha512_compress</span><span class="p">(</span><span class="n">second_block</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="n">state_ints</span><span class="p">)</span>
    <span class="n">keystream</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">ks_words</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">sha512_compress()</code> functions is a boilerplate SHA512 implementation in python from here: https://github.com/KelCodesStuff/Cryptographic-Algorithms/blob/42441605679ee0aa9ad94611c21512cab93ea559/src/sha512.py</p>

<p>With the keystream for each block, we are able to easily recover the plaintext bytes through XOR. The complete plaintext byte-array is written to <code class="language-plaintext highlighter-rouge">flag.bmp</code>, which reveals the flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ecsc25{never_cross_the_streams}
</code></pre></div></div>

<h5 id="solve-script">Solve script</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># sha512 implementation from https://github.com/KelCodesStuff/Cryptographic-Algorithms/blob/42441605679ee0aa9ad94611c21512cab93ea559/src/sha512.py
</span><span class="n">K</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mh">0x428a2f98d728ae22</span><span class="p">,</span> <span class="mh">0x7137449123ef65cd</span><span class="p">,</span> <span class="mh">0xb5c0fbcfec4d3b2f</span><span class="p">,</span> <span class="mh">0xe9b5dba58189dbbc</span><span class="p">,</span>
    <span class="mh">0x3956c25bf348b538</span><span class="p">,</span> <span class="mh">0x59f111f1b605d019</span><span class="p">,</span> <span class="mh">0x923f82a4af194f9b</span><span class="p">,</span> <span class="mh">0xab1c5ed5da6d8118</span><span class="p">,</span>
    <span class="mh">0xd807aa98a3030242</span><span class="p">,</span> <span class="mh">0x12835b0145706fbe</span><span class="p">,</span> <span class="mh">0x243185be4ee4b28c</span><span class="p">,</span> <span class="mh">0x550c7dc3d5ffb4e2</span><span class="p">,</span>
    <span class="mh">0x72be5d74f27b896f</span><span class="p">,</span> <span class="mh">0x80deb1fe3b1696b1</span><span class="p">,</span> <span class="mh">0x9bdc06a725c71235</span><span class="p">,</span> <span class="mh">0xc19bf174cf692694</span><span class="p">,</span>
    <span class="mh">0xe49b69c19ef14ad2</span><span class="p">,</span> <span class="mh">0xefbe4786384f25e3</span><span class="p">,</span> <span class="mh">0x0fc19dc68b8cd5b5</span><span class="p">,</span> <span class="mh">0x240ca1cc77ac9c65</span><span class="p">,</span>
    <span class="mh">0x2de92c6f592b0275</span><span class="p">,</span> <span class="mh">0x4a7484aa6ea6e483</span><span class="p">,</span> <span class="mh">0x5cb0a9dcbd41fbd4</span><span class="p">,</span> <span class="mh">0x76f988da831153b5</span><span class="p">,</span>
    <span class="mh">0x983e5152ee66dfab</span><span class="p">,</span> <span class="mh">0xa831c66d2db43210</span><span class="p">,</span> <span class="mh">0xb00327c898fb213f</span><span class="p">,</span> <span class="mh">0xbf597fc7beef0ee4</span><span class="p">,</span>
    <span class="mh">0xc6e00bf33da88fc2</span><span class="p">,</span> <span class="mh">0xd5a79147930aa725</span><span class="p">,</span> <span class="mh">0x06ca6351e003826f</span><span class="p">,</span> <span class="mh">0x142929670a0e6e70</span><span class="p">,</span>
    <span class="mh">0x27b70a8546d22ffc</span><span class="p">,</span> <span class="mh">0x2e1b21385c26c926</span><span class="p">,</span> <span class="mh">0x4d2c6dfc5ac42aed</span><span class="p">,</span> <span class="mh">0x53380d139d95b3df</span><span class="p">,</span>
    <span class="mh">0x650a73548baf63de</span><span class="p">,</span> <span class="mh">0x766a0abb3c77b2a8</span><span class="p">,</span> <span class="mh">0x81c2c92e47edaee6</span><span class="p">,</span> <span class="mh">0x92722c851482353b</span><span class="p">,</span>
    <span class="mh">0xa2bfe8a14cf10364</span><span class="p">,</span> <span class="mh">0xa81a664bbc423001</span><span class="p">,</span> <span class="mh">0xc24b8b70d0f89791</span><span class="p">,</span> <span class="mh">0xc76c51a30654be30</span><span class="p">,</span>
    <span class="mh">0xd192e819d6ef5218</span><span class="p">,</span> <span class="mh">0xd69906245565a910</span><span class="p">,</span> <span class="mh">0xf40e35855771202a</span><span class="p">,</span> <span class="mh">0x106aa07032bbd1b8</span><span class="p">,</span>
    <span class="mh">0x19a4c116b8d2d0c8</span><span class="p">,</span> <span class="mh">0x1e376c085141ab53</span><span class="p">,</span> <span class="mh">0x2748774cdf8eeb99</span><span class="p">,</span> <span class="mh">0x34b0bcb5e19b48a8</span><span class="p">,</span>
    <span class="mh">0x391c0cb3c5c95a63</span><span class="p">,</span> <span class="mh">0x4ed8aa4ae3418acb</span><span class="p">,</span> <span class="mh">0x5b9cca4f7763e373</span><span class="p">,</span> <span class="mh">0x682e6ff3d6b2b8a3</span><span class="p">,</span>
    <span class="mh">0x748f82ee5defb2fc</span><span class="p">,</span> <span class="mh">0x78a5636f43172f60</span><span class="p">,</span> <span class="mh">0x84c87814a1f0ab72</span><span class="p">,</span> <span class="mh">0x8cc702081a6439ec</span><span class="p">,</span>
    <span class="mh">0x90befffa23631e28</span><span class="p">,</span> <span class="mh">0xa4506cebde82bde9</span><span class="p">,</span> <span class="mh">0xbef9a3f7b2c67915</span><span class="p">,</span> <span class="mh">0xc67178f2e372532b</span><span class="p">,</span>
    <span class="mh">0xca273eceea26619c</span><span class="p">,</span> <span class="mh">0xd186b8c721c0c207</span><span class="p">,</span> <span class="mh">0xeada7dd6cde0eb1e</span><span class="p">,</span> <span class="mh">0xf57d4f7fee6ed178</span><span class="p">,</span>
    <span class="mh">0x06f067aa72176fba</span><span class="p">,</span> <span class="mh">0x0a637dc5a2c898a6</span><span class="p">,</span> <span class="mh">0x113f9804bef90dae</span><span class="p">,</span> <span class="mh">0x1b710b35131c471b</span><span class="p">,</span>
    <span class="mh">0x28db77f523047d84</span><span class="p">,</span> <span class="mh">0x32caab7b40c72493</span><span class="p">,</span> <span class="mh">0x3c9ebe0a15c9bebc</span><span class="p">,</span> <span class="mh">0x431d67c49c100d4c</span><span class="p">,</span>
    <span class="mh">0x4cc5d4becb3e42b6</span><span class="p">,</span> <span class="mh">0x597f299cfc657e2a</span><span class="p">,</span> <span class="mh">0x5fcb6fab3ad6faec</span><span class="p">,</span> <span class="mh">0x6c44198c4a475817</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">right_rotate</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">n</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span>

<span class="k">def</span> <span class="nf">sha512_compress</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">hash_state</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

    <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">80</span>
    <span class="n">w</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'&gt;16Q'</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">80</span><span class="p">):</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">15</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">15</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">15</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">19</span><span class="p">)</span> <span class="o">^</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">61</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hash_state</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">80</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="o">^</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="o">^</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span> <span class="o">&amp;</span> <span class="n">f</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="o">~</span><span class="n">e</span> <span class="o">&amp;</span> <span class="n">g</span><span class="p">)</span>
        <span class="n">temp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">ch</span> <span class="o">+</span> <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span> <span class="o">^</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span> <span class="o">^</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">39</span><span class="p">)</span>
        <span class="n">maj</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">s0</span> <span class="o">+</span> <span class="n">maj</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">temp1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">+</span> <span class="n">temp2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span>

    <span class="n">hash_state</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffffffff</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hash_state</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">hash_state</span>




<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">remote</span><span class="p">,</span> <span class="n">xor</span>

<span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span>   <span class="o">=</span> <span class="s">"shactr.ecsc25.hack.cert.pl"</span><span class="p">,</span> <span class="mi">5203</span>
<span class="n">BLOCK_SIZE</span>   <span class="o">=</span> <span class="mi">64</span>
<span class="n">KEY_LEN</span>      <span class="o">=</span> <span class="mi">32</span>
<span class="n">CTR_LEN</span>      <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># xxd -p -l 64 example_flag.bmp
</span><span class="n">known_plain</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span>
    <span class="s">"424dee3b0000000000003600000028000000c40000001a00000001001800"</span>
    <span class="s">"00000000b83b000000000000000000000000000000000000ffffffffffff"</span>
    <span class="s">"ffffffff"</span>
<span class="p">)</span>
<span class="n">file_size</span> <span class="o">=</span> <span class="mh">0x3bee</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"nonce:"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">""</span><span class="p">)</span>
<span class="n">cipher0</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>

<span class="n">state_ints</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">cipher0</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="n">known_plain</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
<span class="n">first_ctr</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"0"</span> <span class="o">*</span> <span class="n">CTR_LEN</span>
<span class="c1"># 0x80 + many 0x00 + 16 bytes length-field
</span><span class="n">pad</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x80</span><span class="s">"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">69</span> <span class="o">+</span> <span class="p">((</span><span class="n">KEY_LEN</span> <span class="o">+</span> <span class="n">CTR_LEN</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">nonce</span> <span class="o">=</span> <span class="n">first_ctr</span> <span class="o">+</span> <span class="n">pad</span>

<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"nonce:"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">nonce</span><span class="p">.</span><span class="nb">hex</span><span class="p">().</span><span class="n">encode</span><span class="p">())</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># ctr(i) \| padding
</span><span class="k">def</span> <span class="nf">second_block</span><span class="p">(</span><span class="n">counter</span><span class="p">):</span>
    <span class="n">total_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">KEY_LEN</span> <span class="o">+</span> <span class="n">CTR_LEN</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="n">CTR_LEN</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="c1"># 0x80 + many 0x00 + 16 bytes length-field
</span>    <span class="k">return</span> <span class="n">counter</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x80</span><span class="s">"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">101</span> <span class="o">+</span> <span class="n">total_bits</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="n">plaintext</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">))</span>
<span class="k">for</span> <span class="n">block_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">),</span> <span class="n">BLOCK_SIZE</span><span class="p">):</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">block_index</span><span class="o">//</span><span class="n">BLOCK_SIZE</span><span class="si">:</span><span class="mi">010</span><span class="si">}</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">ks_words</span> <span class="o">=</span> <span class="n">sha512_compress</span><span class="p">(</span><span class="n">second_block</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="n">state_ints</span><span class="p">)</span>
    <span class="n">keystream</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">ks_words</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">byte_index</span><span class="p">,</span> <span class="p">(</span><span class="n">ct_byte</span><span class="p">,</span> <span class="n">keystream_byte</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cipher</span><span class="p">[</span><span class="n">block_index</span><span class="p">:</span><span class="n">block_index</span><span class="o">+</span><span class="n">BLOCK_SIZE</span><span class="p">],</span> <span class="n">keystream</span><span class="p">)):</span>
        <span class="n">plaintext</span><span class="p">[</span><span class="n">block_index</span> <span class="o">+</span> <span class="n">byte_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_byte</span> <span class="o">^</span> <span class="n">keystream_byte</span>

<span class="nb">open</span><span class="p">(</span><span class="s">"flag.bmp"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"flag.bmp written"</span><span class="p">)</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="SHA2" /><category term="Length extension" /><category term="Stream cipher" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Mancity (CryptoCTF 2025)</title><link href="http://localhost:4000/mancity/" rel="alternate" type="text/html" title="Mancity (CryptoCTF 2025)" /><published>2025-07-13T12:00:00+02:00</published><updated>2025-07-13T12:00:00+02:00</updated><id>http://localhost:4000/mancity</id><content type="html" xml:base="http://localhost:4000/mancity/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">flag</span> <span class="kn">import</span> <span class="n">flag</span>

<span class="k">def</span> <span class="nf">man</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="s">''</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">B</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s">'0'</span><span class="p">:</span>
                        <span class="n">M</span> <span class="o">+=</span> <span class="s">'01'</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">M</span> <span class="o">+=</span> <span class="s">'11'</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">keygen</span><span class="p">(</span><span class="n">nbit</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="n">nbit</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">man</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="s">'1'</span> <span class="o">*</span> <span class="n">nbit</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                                <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span>

<span class="n">nbit</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">keygen</span><span class="p">(</span><span class="n">nbit</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">n</span>
<span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1234567891</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'n = </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'c = </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>  
</code></pre></div></div>

<p>as well as output.txt:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n = 147170819334030469053514652921356515888015711942553338463409772437981228515273287953989706666936875524451626901247038180594875568558137526484665015890594045767912340169965961750130156341999306808017498374501001042628249176543370525803456692022546235595791111819909503496986338431136130272043196908119165239297
c = 77151713996168344370880352082934801122524956107256445231326053049976568087412199358725058612262271922128984783428798480191211811217854076875727477848490840660333035334309193217618178091153472265093622822195960145852562781183839474868269109313543427082414220136748700364027714272845969723750108397300867408537     
</code></pre></div></div>

<p>This is an RSA-like implementation with some funky key generation</p>

<h5 id="source-code-analysis">Source code analysis</h5>

<p>The encryption script implements a Manchester encoding scheme in the function <code class="language-plaintext highlighter-rouge">man()</code>. The number passed to this function is converted to bits, and each bit is replaced with either <code class="language-plaintext highlighter-rouge">01</code> or <code class="language-plaintext highlighter-rouge">11</code>. The resulting bitstream is converted back into an integer.</p>

<p>The key generation algorithm produces a 256-bit prime integer $p$, which is used to generate both RSA prime factors. One is generated by passing $p$ to <code class="language-plaintext highlighter-rouge">man()</code>, resulting in a 512-bit integer, while the other prime is generated by appending 256 bits to $p$’s bitstream. This tells us a lot about the structure of the prime factors.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r: ?1?1?1?1?1?1?1?1...?1?1?1?1?1?1?1?1 
q: ????????????????...1111111111111111
</code></pre></div></div>

<p>Since half of the prime factor $q$ is known, recovering the prime using coppersmith is a promising idea. However, even with 50% consecutive bits, the approach failed. Another approach may be to use branch and prune, since 50% of both primes are known and are scattered in $r$, but this also did not work out, probably due to $q$ missing too many consecutive bits.</p>

<p>Instead, we take advantage of the prime factor’s unique structure and relationship with the modulus $n$. First, for clarity, I will refer to the prime factors $q$ and $r$ as $p$ and $q$ respectively, due to the way the encryption script reuses variable names and returns the factors from the keygen algorithm</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p: ????????????????...1111111111111111
q: ?1?1?1?1?1?1?1?1...?1?1?1?1?1?1?1?1 
</code></pre></div></div>

<p>We can represent $p$ as the following:</p>

\[\large p = 2^{256}\cdot x + 2^{256}-1\]

<p>for some unknown $x$ (upper bits). Taking $p$ modulo $2^{256}$, we get:</p>

\[\large p = -1 \mod 2^{256}\]

<p>Which means:</p>

\[\large \begin{align}
\nonumber n = p \cdot q \mod 2^{256} \\
\nonumber n = -1 \cdot q \mod 2^{256} \\
\nonumber n = -q \mod 2^{256} \\
\nonumber -n = q \mod 2^{256}
\end{align}\]

<p>So by taking $-n \mod 2^{256}$, we are able to recover the bottom $256$ bits of $q$. Remember, $q$ (r) was generated using the Manchester encoding. The $256$ bottom bits of $q$ include the $128$ least significant bits of the random prime. Since $p$ and $q$ are generated using the same prime, this leaks another $128$ bits of $p$, for a total of $384$. With 75% of a prime factor’s bits, the primes are recovered from coppersmith in a trivial manner.</p>

<h5 id="recovering-the-prime-factors">Recovering the prime factors</h5>

<p>Recovering 75% of $p$’s bits can be done like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rlow</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">256</span>
<span class="n">rbits</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">rlow</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>

<span class="c1"># Undoing manchester encoding
</span><span class="n">qlow</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rbits</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">qlow</span> <span class="o">+=</span> <span class="n">rbits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">qlow</span> <span class="o">+=</span> <span class="s">"1"</span><span class="o">*</span><span class="mi">256</span>
<span class="n">leak</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">qlow</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>With the leaked value, the prime is instantly recovered using <code class="language-plaintext highlighter-rouge">cuso</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">T</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s">"x"</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">384</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">leak</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span>           <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">],</span>
    <span class="n">bounds</span>              <span class="o">=</span> <span class="p">{</span><span class="n">T</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="p">)},</span>
    <span class="n">modulus</span>             <span class="o">=</span> <span class="s">"p"</span><span class="p">,</span>     
    <span class="n">modulus_multiple</span>    <span class="o">=</span> <span class="n">n</span><span class="p">,</span>   
    <span class="n">modulus_lower_bound</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">511</span><span class="p">,</span> 
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"CuSO found no root"</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"p"</span><span class="p">]</span>
</code></pre></div></div>

<p>From here, its just regular RSA decryption</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"p"</span><span class="p">]</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">p</span>
<span class="k">assert</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="n">n</span>

<span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">d</span>   <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
<span class="n">m</span>   <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="c1"># CCTF{M4nch3sReR_c0D!ng_wI7H_RSA}
</span></code></pre></div></div>

<h5 id="solve-script">Solve script</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cuso</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">147170819334030469053514652921356515888015711942553338463409772437981228515273287953989706666936875524451626901247038180594875568558137526484665015890594045767912340169965961750130156341999306808017498374501001042628249176543370525803456692022546235595791111819909503496986338431136130272043196908119165239297</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">77151713996168344370880352082934801122524956107256445231326053049976568087412199358725058612262271922128984783428798480191211811217854076875727477848490840660333035334309193217618178091153472265093622822195960145852562781183839474868269109313543427082414220136748700364027714272845969723750108397300867408537</span>
<span class="n">e</span> <span class="o">=</span> <span class="mi">1234567891</span>

<span class="n">M</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">256</span>
<span class="n">rlow</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">%</span><span class="n">M</span>
<span class="n">rbits</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">rlow</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>

<span class="n">qlow</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rbits</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">qlow</span> <span class="o">+=</span> <span class="n">rbits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">qlow</span> <span class="o">+=</span> <span class="s">"1"</span><span class="o">*</span><span class="mi">256</span>
<span class="n">leak</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">qlow</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s">"x"</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">384</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">leak</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span>           <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">],</span>
    <span class="n">bounds</span>              <span class="o">=</span> <span class="p">{</span><span class="n">T</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="p">)},</span>
    <span class="n">modulus</span>             <span class="o">=</span> <span class="s">"p"</span><span class="p">,</span>     
    <span class="n">modulus_multiple</span>    <span class="o">=</span> <span class="n">n</span><span class="p">,</span>   
    <span class="n">modulus_lower_bound</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">511</span><span class="p">,</span> 
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"CuSO found no root"</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"p"</span><span class="p">]</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">p</span>
<span class="k">assert</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="n">n</span>

<span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">d</span>   <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
<span class="n">m</span>   <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="c1"># CCTF{M4nch3sReR_c0D!ng_wI7H_RSA}
</span></code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="RSA" /><category term="Coppersmith small roots" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Phony (CryptoCTF 2025)</title><link href="http://localhost:4000/phony/" rel="alternate" type="text/html" title="Phony (CryptoCTF 2025)" /><published>2025-07-13T12:00:00+02:00</published><updated>2025-07-13T12:00:00+02:00</updated><id>http://localhost:4000/phony</id><content type="html" xml:base="http://localhost:4000/phony/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge we are given the following encryption script, as well as a host and port to connect to.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">os</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">flag</span> <span class="kn">import</span> <span class="n">flag</span>

<span class="k">def</span> <span class="nf">die</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">pr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">pr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">" "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">sc</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">keygen</span><span class="p">(</span><span class="n">nbit</span><span class="p">):</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">getPrime</span><span class="p">(</span><span class="n">nbit</span> <span class="o">+</span> <span class="p">(</span><span class="n">nbit</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">border</span> <span class="o">=</span> <span class="s">"┃"</span>
        <span class="n">pr</span><span class="p">(</span>        <span class="s">"┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓"</span><span class="p">)</span>
        <span class="n">pr</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="s">" Welcome to the Phoney crypto-system task, a nice cryptosystem   "</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>
        <span class="n">pr</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="s">" that's so good, it's theoretically unbreakable because it exists"</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>
        <span class="n">pr</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="s">" only in the realm of imagination!! Try the get the long flag :-)"</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>
        <span class="n">pr</span><span class="p">(</span>        <span class="s">"┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛"</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">flag</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span> <span class="o">+</span> <span class="n">flag</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)))</span>
        <span class="n">nbit</span> <span class="o">=</span> <span class="mi">512</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">keygen</span><span class="p">(</span><span class="n">nbit</span><span class="p">)</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">r</span><span class="p">,</span> <span class="n">inverse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1234567891</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">pr</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">border</span><span class="si">}</span><span class="s"> Options: </span><span class="se">\n</span><span class="si">{</span><span class="n">border</span><span class="si">}</span><span class="se">\t</span><span class="s">[E]ncrypt the flag! </span><span class="se">\n</span><span class="si">{</span><span class="n">border</span><span class="si">}</span><span class="se">\t</span><span class="s">[P]ublic information </span><span class="se">\n</span><span class="si">{</span><span class="n">border</span><span class="si">}</span><span class="se">\t</span><span class="s">[Q]uit"</span><span class="p">)</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">sc</span><span class="p">().</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s">'e'</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">n</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                        <span class="n">pr</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">c</span> <span class="o">=</span> <span class="si">}</span><span class="s">'</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ans</span> <span class="o">==</span> <span class="s">'p'</span><span class="p">:</span>
                        <span class="n">pr</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">n</span> <span class="o">=</span> <span class="si">}</span><span class="s">'</span><span class="p">)</span>
                        <span class="n">pr</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">s</span> <span class="o">=</span> <span class="si">}</span><span class="s">'</span><span class="p">)</span>
                        <span class="n">pr</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">q</span> <span class="o">%</span> <span class="n">p</span> <span class="o">=</span> <span class="si">}</span><span class="s">'</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ans</span> <span class="o">==</span> <span class="s">'q'</span><span class="p">:</span>
                        <span class="n">die</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="s">"Quitting..."</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">die</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="s">"Bye..."</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>  
</code></pre></div></div>

<p>By connecting to the host, we are given some parameters:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c = 6869860867050333958899459281380169365224860725191141490075681906921285491146868469402924407937586752602837270188417362698698432410645612767176659341773981474956667075905162196530581138090668035380527629936507938083351225221764373058697174991005915834617167971014590329567873587411280896708327508300000380436210779160971169732950060789651351851118197920235412555409856566771235934800199725530146544692622204638420681024709553733579632544440316928742635345488552585477308018879605401386083632773124260425537471704361270484
n = 7593182903146811406435471791518649687495414242882290735012260860376531253817852809889056324416625293328336902814033416817885049198231261658575996571173050362548418752191140228401121790728216545279595354039266794764391641456534625225792086731913555135968347381141768054313651417425174249608933255246607612139992917832326481150388513002349951254458456726813282961483706607801158152631829134593355178831985262912282527824542674089294563518520637393822269227734326318416000202832970945614787755290083730313250861320246580607
s = 408090971571018322541813922483180473677053198626231795703512988713148003287852666320118777537915800591251623270019431071055073761901852807133561327188793849601691060300945653929089492414728804506355613740171489217849409547504090029963007153700898456243760945317209450011285770935513349812984386394905043517448605752738202406721452527001589670740463592746693105274845
q % p = 9306850992856150821106831016751373801819672057267955676046215879463293889689158245940844448621629363248578706865630660666356930840954191009944889404229867
</code></pre></div></div>

<h5 id="recovering-the-prime-factors">Recovering the prime factors</h5>

<p>The service leaks three pieces of information besides the ciphertext $c$:</p>
<ul>
  <li>the composite modulus $n = p \cdot q \cdot r$</li>
  <li>the integer $s = p + p^{-1}_{qr}$</li>
  <li>the residue $r \equiv q \bmod p$</li>
</ul>

<p>Because $s = p + p^{-1}_{\;qr}$ we have</p>

\[\large
\begin{align}
\nonumber p^{-1}_{\;qr} &amp;= s-p \\
\nonumber (s-p)\,p &amp;\equiv 1\mod{qr}
\end{align}\]

<p>Multiplying by $p$ gives a relation that is zero modulo $n$:</p>

\[\large
\begin{align}
\nonumber p\bigl((s-p)p-1\bigr) &amp;\equiv 0 \mod{n} \\
\nonumber f(p)=p^{3}-s\,p^{2}+p &amp;\equiv 0\mod{n}
\end{align}\]

<p>The prime $p$ is only $512$ bits, while $n$ is about $1728$ bits, so $p$ is a small root of the monic cubic</p>

\[\large f(x)=x^{3}-s\,x^{2}+x\mod{n}\]

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s">'x'</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">s</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">520</span><span class="p">)}</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="p">],</span>         
    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
    <span class="n">modulus</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>               
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"no root found"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"p = </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="c1">#x</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="c1"># p = 0xda7a510e37d4c24fbed858e74371c3b199b7163f04e87be5cc36345419443a48ae80c16a4634b2754b543326e30ac45d35e13a20274a94bd662ea96f7d7121b9
</span></code></pre></div></div>

<p>Once $p$ is known, the extra leak $q\bmod p$ lets us write</p>

\[\large
\begin{align}
\nonumber q &amp;= p \cdot k + r \\
\nonumber r &amp;= q \bmod p
\end{align}\]

<p>Here $k &lt; 2^{64}$ because $q$ is $576$ bits, only $64$ bits longer than $p$.  Substituting into $n$ shows that the linear polynomial</p>

\[\large g(k)=p\,k+r\equiv 0 \mod{q}\]

<p>This can also be easily solved using <code class="language-plaintext highlighter-rouge">cuso</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">q_mod_p</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)}</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span>        <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">],</span>
    <span class="n">bounds</span>           <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span>
    <span class="n">modulus</span>          <span class="o">=</span> <span class="s">"q"</span><span class="p">,</span>    
    <span class="n">modulus_multiple</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="n">p</span><span class="p">,</span>      
    <span class="n">modulus_lower_bound</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">560</span>  
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"no root found"</span>

<span class="n">q</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"q"</span><span class="p">])</span> 
</code></pre></div></div>

<p>From here, its just standard RSA decryption.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">q</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"q"</span><span class="p">])</span> 
<span class="n">r</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="n">e</span>   <span class="o">=</span> <span class="mi">1234567891</span>
<span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">d</span>   <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="s">"</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b'ax\x90\xda\xea\xefa\x9f\xce\xb8&amp;n\x85~\xf4\xbe\xef|\x9eF\xc4x\xa039\xf1\x8a=\xdf\x10\x17\x96\x97\xe3h@\xb6\xae\xea\xf3\x84K\x03\x9a\xb4\xe6i\xd8\x04CCTF{c0UlD_b3_ReCoVEr3d_v!4_Coppersmiths_m3ThOd?}_(\x9a\x9e\x9b,\xbb\xde\x15\xf3\x0fP\x1e\xbc\xd5C\x1au\x1b3d\x18\x15X$^\x83\x17\xbd\xa3&amp;\xb9\xa7H\xe0\x19Y\xf7\x8f0`\xd6J`\xf7\xd22\xfb\xd8'
</code></pre></div></div>

<p>So the flag is <code class="language-plaintext highlighter-rouge">CCTF{c0UlD_b3_ReCoVEr3d_v!4_Coppersmiths_m3ThOd?}</code></p>

<h5 id="solve-script">Solve script</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cuso</span>

<span class="n">c</span> <span class="o">=</span> <span class="mi">6869860867050333958899459281380169365224860725191141490075681906921285491146868469402924407937586752602837270188417362698698432410645612767176659341773981474956667075905162196530581138090668035380527629936507938083351225221764373058697174991005915834617167971014590329567873587411280896708327508300000380436210779160971169732950060789651351851118197920235412555409856566771235934800199725530146544692622204638420681024709553733579632544440316928742635345488552585477308018879605401386083632773124260425537471704361270484</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">7593182903146811406435471791518649687495414242882290735012260860376531253817852809889056324416625293328336902814033416817885049198231261658575996571173050362548418752191140228401121790728216545279595354039266794764391641456534625225792086731913555135968347381141768054313651417425174249608933255246607612139992917832326481150388513002349951254458456726813282961483706607801158152631829134593355178831985262912282527824542674089294563518520637393822269227734326318416000202832970945614787755290083730313250861320246580607</span>
<span class="n">s</span> <span class="o">=</span> <span class="mi">408090971571018322541813922483180473677053198626231795703512988713148003287852666320118777537915800591251623270019431071055073761901852807133561327188793849601691060300945653929089492414728804506355613740171489217849409547504090029963007153700898456243760945317209450011285770935513349812984386394905043517448605752738202406721452527001589670740463592746693105274845</span>
<span class="n">q_mod_p</span> <span class="o">=</span> <span class="mi">9306850992856150821106831016751373801819672057267955676046215879463293889689158245940844448621629363248578706865630660666356930840954191009944889404229867</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s">'x'</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">s</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">520</span><span class="p">)}</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="p">],</span>         
    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
    <span class="n">modulus</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>               
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"no root found"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"p = </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="c1">#x</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">q_mod_p</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)}</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span>        <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">],</span>
    <span class="n">bounds</span>           <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span>
    <span class="n">modulus</span>          <span class="o">=</span> <span class="s">"q"</span><span class="p">,</span>    
    <span class="n">modulus_multiple</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="n">p</span><span class="p">,</span>      
    <span class="n">modulus_lower_bound</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">560</span>  
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"no root found"</span>

<span class="n">q</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"q"</span><span class="p">])</span> 
<span class="n">r</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="n">e</span>   <span class="o">=</span> <span class="mi">1234567891</span>
<span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">d</span>   <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="s">"</span><span class="p">))</span>
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="RSA" /><category term="Coppersmith small roots" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Lowkey RSA (L3AK 2025)</title><link href="http://localhost:4000/lowkey-rsa/" rel="alternate" type="text/html" title="Lowkey RSA (L3AK 2025)" /><published>2025-07-11T12:00:00+02:00</published><updated>2025-07-11T12:00:00+02:00</updated><id>http://localhost:4000/lowkey-rsa</id><content type="html" xml:base="http://localhost:4000/lowkey-rsa/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">gen_primes</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SIZE</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">random_prime</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">:</span> 
            <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span>
            <span class="k">if</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span>

<span class="n">nbits</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">flag</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"L3AK{&lt;REDACTED&gt;}"</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">RealField</span><span class="p">(</span><span class="n">nbits</span><span class="p">)</span>
<span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">gen_primes</span><span class="p">(</span><span class="n">nbits</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
<span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">N_s</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">N_ss</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>   
<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N_ss</span><span class="o">-</span><span class="mi">49</span><span class="o">*</span><span class="n">N_s</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="mi">170</span><span class="o">*</span><span class="n">N_s</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">phi</span><span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="n">phi</span><span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"e = </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s">N = </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="se">\n</span><span class="s">c = </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>As well as output.txt</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>e = 370641246943654763647982436393968410523035056803076571952063446221981054741105804986870907803130391736840420704227524827167178043545763070520011423497365360567040835216714988776285676818833967899487393611410406708467049153990487431775151667103817558875154145780446157545062795321820537740212495675608976163877567007753523774447008611976905578477758365862741282887079873779055623972564793977884741350325450634869927603664722967323341473363320613467433998603537242156610765948379449307405122629600556105209482040761323271134932553579828576227233549741862990693111061962892676568398083446001891012661453694340879845386900986024512140441823076068075531089610607812090402852586184229193699718454197060072575595570232588935191272416546819793045623275550409871218062357273309812154110783534714662063322116568964675372602159108306251453500390105034890229052958512010283429459687714879084097494098542745605324460172680461006303552579466987732938596341830436505942616479890554056163452471835707573885837976471753073413505028206370632139586750855217201926605743452826397576584492732225029497982216694648573014796836126574081158869231364821712046050068243878660143909750030922147254462228826952501087389154612318844202411291844150163167021
N = 10222014062768125922601962004686361136447658578111413896046596746110249358112354000488449664371774177977274016313103826803116662735101208575040021998413602496525815373151213550295992813258424882626853824039678993334143891154760939712139640336395595628492284893024078520796288685014103193630287988814952604029
c = 4323184196594280140760873888779221921406692838206184372853784052006066772207175604399047711017170078453742445880600303200397632746051500194774569530024097959399922254605516672962219900174336028512116159752401576376530557036245218800162889461620882177398454137759956927838320086276276377067055171421259852996
</code></pre></div></div>

<p>The encryption script implements an unusual RSA-like scheme where:</p>

\[\large \phi(n) = (p^{4}-1)\cdot(q^{4}-1)\]

<h5 id="recovering-phi">Recovering phi</h5>

<p>We begin by expanding phi like so:</p>

\[\large \begin{align}
\nonumber \phi(n) &amp;= (p^{4}-1)\cdot(q^{4}-1) \\
\nonumber \phi(n) &amp;= N^{4}-(p^{4}+q^{4}) + 1
\end{align}\]

<p>We rewrite $p^{4}+q^{4}$:</p>

\[\large p^{4}+q^{4} = (p^{2}+q^{2})^{2}-2N^{2}\]

<p>Which means:</p>

\[\large \phi(n) = N^{4}-(p^{2}+q^{2})^{2} + 2N^{2} + 1\]

<p>We refer to $p^{2}+q^{2}$ as the variable $u$. With $\phi(n)$ expanded, we can look at the following equation from the code:</p>

\[\large
\begin{align}
\nonumber (\phi-d) \cdot e &amp;= 1 &amp;\mod \phi \\
\nonumber -d \cdot e &amp;= 1 &amp;\mod \phi \\ 
\nonumber d \cdot e &amp;= -1 &amp;\mod \phi  \\
\nonumber d \cdot e +1&amp;= 0 &amp;\mod \phi \\
\nonumber e \cdot d + 1&amp;= k\cdot \phi \\
\nonumber e \cdot d + 1 - k\cdot \phi &amp;= 0 \\
\nonumber 1 - k\cdot \phi &amp;= 0 &amp;\mod e  \\
\nonumber 1 - k\cdot (N^{4}-(p^{2}+q^{2})^{2} + 2N^{2} + 1) &amp;= 0 &amp;\mod e \\
\nonumber 1 - k\cdot (N^{4}-u^{2} + 2N^{2} + 1) &amp;= 0 &amp;\mod e
\end{align}\]

<p>With this polynomial, we can recover $k$ and $u$ using a bivariate coppersmith’s attack. We will have to know the bounds for both $k$ and $u$. 
Looking at $e \cdot d + 1 = k\cdot \phi$ again, we know $\phi$ and $e$ have around the same bit size, which means $d$ and $k$ will have around the same bit size. In the source code, we can see that:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N_ss</span><span class="o">-</span><span class="mi">49</span><span class="o">*</span><span class="n">N_s</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="mi">170</span><span class="o">*</span><span class="n">N_s</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>so $k$ is bound by $t$. And since $u = (p^{2}+q^{2})$, we know $u$ is bounded by around $2N$. With all of this information, we can solve the bivariate polynomial in $k,u$ with coppersmith’s small roots:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">P</span><span class="p">.</span><span class="o">&lt;</span><span class="n">k</span><span class="p">,</span><span class="n">u</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">ZZ</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">^</span><span class="mi">4</span> <span class="o">-</span> <span class="n">u</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">small_roots</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="p">(</span><span class="n">isqrt</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">),</span> <span class="n">m</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">"resultants"</span><span class="p">,</span> <span class="n">lattice_reduction</span><span class="o">=</span><span class="n">flatter</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">k</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<p>With $k$ and $u$, we recover $\phi = N^{4}-u^{2} + 2N^{2} + 1$ and $d$:</p>

\[\large d = \frac{k\cdot \phi-1}{e}\]

<p>And with the private key $d$ recovered, the encrypted flag $c$ can be decrypted:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">phi</span><span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">)))</span>
<span class="c1"># L3AK{L0wK3y_Th1S_RSA_i5_kiNda_ScuFf3D_LmA0}
</span></code></pre></div></div>

<h5 id="solve-script">Solve script</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">'~/tools/coppersmith/lbc/lattice-based-cryptanalysis/lbc_toolkit/problems/small_roots.sage'</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">'~/tools/coppersmith/lbc/lattice-based-cryptanalysis/lbc_toolkit/common/flatter.sage'</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">'~/tools/coppersmith/lbc/lattice-based-cryptanalysis/lbc_toolkit/common/systems_solvers.sage'</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">inverse</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="n">e</span> <span class="o">=</span> <span class="mi">370641246943654763647982436393968410523035056803076571952063446221981054741105804986870907803130391736840420704227524827167178043545763070520011423497365360567040835216714988776285676818833967899487393611410406708467049153990487431775151667103817558875154145780446157545062795321820537740212495675608976163877567007753523774447008611976905578477758365862741282887079873779055623972564793977884741350325450634869927603664722967323341473363320613467433998603537242156610765948379449307405122629600556105209482040761323271134932553579828576227233549741862990693111061962892676568398083446001891012661453694340879845386900986024512140441823076068075531089610607812090402852586184229193699718454197060072575595570232588935191272416546819793045623275550409871218062357273309812154110783534714662063322116568964675372602159108306251453500390105034890229052958512010283429459687714879084097494098542745605324460172680461006303552579466987732938596341830436505942616479890554056163452471835707573885837976471753073413505028206370632139586750855217201926605743452826397576584492732225029497982216694648573014796836126574081158869231364821712046050068243878660143909750030922147254462228826952501087389154612318844202411291844150163167021</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10222014062768125922601962004686361136447658578111413896046596746110249358112354000488449664371774177977274016313103826803116662735101208575040021998413602496525815373151213550295992813258424882626853824039678993334143891154760939712139640336395595628492284893024078520796288685014103193630287988814952604029</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">4323184196594280140760873888779221921406692838206184372853784052006066772207175604399047711017170078453742445880600303200397632746051500194774569530024097959399922254605516672962219900174336028512116159752401576376530557036245218800162889461620882177398454137759956927838320086276276377067055171421259852996</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">RealField</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="n">N_s</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">N_ss</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>   
<span class="n">t</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">N_ss</span><span class="o">-</span><span class="mi">49</span><span class="o">*</span><span class="n">N_s</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="mi">170</span><span class="o">*</span><span class="n">N_s</span><span class="p">))</span>

<span class="n">P</span><span class="p">.</span><span class="o">&lt;</span><span class="n">k</span><span class="p">,</span><span class="n">u</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">ZZ</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">^</span><span class="mi">4</span> <span class="o">-</span> <span class="n">u</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">small_roots</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="p">(</span><span class="n">isqrt</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">),</span> <span class="n">m</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">"resultants"</span><span class="p">,</span> <span class="n">lattice_reduction</span><span class="o">=</span><span class="n">flatter</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">k</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">k</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">ZZ</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">N</span><span class="o">^</span><span class="mi">4</span> <span class="o">-</span> <span class="n">u</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">phi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">e</span>
<span class="k">assert</span> <span class="n">e</span><span class="o">*</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">k</span><span class="o">*</span><span class="n">phi</span>

<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">phi</span><span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">)))</span>
<span class="c1"># L3AK{L0wK3y_Th1S_RSA_i5_kiNda_ScuFf3D_LmA0}
</span></code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="RSA" /><category term="Coppersmith small roots" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Secret^2 (L3AK 2025)</title><link href="http://localhost:4000/secret-squared/" rel="alternate" type="text/html" title="Secret^2 (L3AK 2025)" /><published>2025-07-11T12:00:00+02:00</published><updated>2025-07-11T12:00:00+02:00</updated><id>http://localhost:4000/secret-squared</id><content type="html" xml:base="http://localhost:4000/secret-squared/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge we are given the following encryption script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span> <span class="k">as</span> <span class="n">b2l</span>

<span class="n">secret_1</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">b2l</span><span class="p">(</span><span class="sa">b</span><span class="s">'&lt;Redacted 1&gt;'</span><span class="p">))</span>
<span class="n">secret_2</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">b2l</span><span class="p">(</span><span class="sa">b</span><span class="s">'&lt;Redacted 2&gt;'</span><span class="p">))</span>

<span class="k">assert</span> <span class="n">secret_1</span><span class="p">.</span><span class="n">nbits</span><span class="p">()</span> <span class="o">==</span> <span class="mi">271</span>
<span class="k">assert</span> <span class="n">secret_2</span><span class="p">.</span><span class="n">nbits</span><span class="p">()</span> <span class="o">==</span> <span class="mi">247</span>

<span class="n">real_secret</span> <span class="o">=</span> <span class="n">Mod</span><span class="p">(</span><span class="n">secret_1</span><span class="p">,</span><span class="mi">2</span><span class="o">^</span><span class="mi">1337</span> <span class="o">+</span> <span class="mi">1337</span><span class="p">)</span><span class="o">/</span><span class="n">secret_2</span> <span class="o">+</span> <span class="mi">1337</span><span class="o">^</span><span class="mi">1337</span>
<span class="n">not_secret_anymore</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">real_secret</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">not_secret_anymore</span><span class="p">)</span>

<span class="c1"># assert flag  == b"L3AK{" + secret_1 + secret_2 + b"}"
# 0xaf67951fc756caf05e1cb834854880fa6b3919aa390a42a3f2cdcc1943b959192cebea290e4bbe41b517056b95903e9f6ec10d490fdde72cf17a7ab3e65d61fc9c0a750dc20d52626f78c7200744fb9bcc0e7b9f33dd5a83df5d05de7258404b5c56ced4b57e63ab0c7c4761ce76d789734d705e8e137a2000c678c5b90b1df6169499ef39184622d4f83a03985ba8038fdb05aae52d5f2c04f8b8f7a4ac2a54b3d0be67c71752
</span></code></pre></div></div>

<h5 id="setting-up-the-bivariate-polynomial">Setting up the bivariate polynomial</h5>

<p>The encryption script gives us:</p>

\[\large x \equiv \left( \frac{s_{1}}{s_{2}}+k \right)^{2} \mod n\]

<p>Where we define $k$ and $n$ as:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">1337</span> <span class="o">+</span> <span class="mi">1337</span>
<span class="n">k</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">1337</span><span class="p">,</span><span class="mi">1337</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></div>

<p>Expanding the square, we get:</p>

\[\large x \equiv \frac{s_{1}^{2}}{s_{2}^{2}} + 2 \cdot k\cdot \frac{s_{1}}{s_{2}} + k^{2} \mod n\]

<p>Multiplying both sides with $s_{2}^{2}$, we eliminate the fractions and rearrange to zero:</p>

\[\large \begin{align}
\nonumber x \equiv \frac{s_{1}^{2}}{s_{2}^{2}} + 2 \cdot k\cdot \frac{s_{1}}{s_{2}} + k^{2} \mod n \\
\nonumber x s_{2}^{2} \equiv s_{1}^{2} + 2 k s_{1} s_{2} + s_{2}^{2} k^{2} \mod n \\
\nonumber s_{1}^{2} + 2 k s_{1} s_{2} + s_{2}^{2} k^{2}- x s_{2}^{2} \equiv 0 \mod n \\
\nonumber s_{1}^{2} + 2 k s_{1} s_{2} + s_{2}^{2}(k^{2}- x) \equiv 0 \mod n
\end{align}\]

<p>This is a bivariate polynomial with small roots $s_{1}$ and $s_{2}$ which are bound by $2^{271}$ and $2^{247}$ respectively.</p>

<h5 id="solving-with-coppersmith">Solving with coppersmith</h5>

<p>This bivariate polynomial can easily be solved using coppersmith. To do this, I will use <code class="language-plaintext highlighter-rouge">cuso</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="n">s1</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">s1</span><span class="o">*</span><span class="n">s2</span> <span class="o">+</span> <span class="n">s2</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="p">],</span>
    <span class="n">bounds</span><span class="o">=</span> <span class="p">{</span>
	    <span class="n">s1</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">271</span><span class="p">),</span>
	    <span class="n">s2</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">247</span><span class="p">),</span>
	<span class="p">},</span>
    <span class="n">modulus</span><span class="o">=</span><span class="n">n</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"no roots found"</span>
<span class="n">s1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">s1</span><span class="p">])</span>
<span class="n">s2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">s2</span><span class="p">])</span>
</code></pre></div></div>

<p>with $s_{1}$ and $s_{1}$ recovered, we can easily decode the flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"L3AK{"</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">s1</span><span class="si">:</span><span class="n">x</span><span class="si">}{</span><span class="n">s2</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="s">').decode()</span><span class="si">}</span><span class="s">"</span> <span class="o">+</span> <span class="s">"}"</span><span class="p">)</span>
<span class="c1"># L3AK{Squ4R1ng_mY_s3cr3t_w4Snt_5m4rT_b1Vari4Te_p0lyN0MiaLs_4r3_s0Lvabl3}
</span></code></pre></div></div>

<h5 id="solve-script">Solve script</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span>
<span class="kn">import</span> <span class="nn">cuso</span>

<span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s">"s1 s2"</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="mh">0xaf67951fc756caf05e1cb834854880fa6b3919aa390a42a3f2cdcc1943b959192cebea290e4bbe41b517056b95903e9f6ec10d490fdde72cf17a7ab3e65d61fc9c0a750dc20d52626f78c7200744fb9bcc0e7b9f33dd5a83df5d05de7258404b5c56ced4b57e63ab0c7c4761ce76d789734d705e8e137a2000c678c5b90b1df6169499ef39184622d4f83a03985ba8038fdb05aae52d5f2c04f8b8f7a4ac2a54b3d0be67c71752</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">1337</span> <span class="o">+</span> <span class="mi">1337</span>
<span class="n">k</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">1337</span><span class="p">,</span><span class="mi">1337</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">s1</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">s1</span><span class="o">*</span><span class="n">s2</span> <span class="o">+</span> <span class="n">s2</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">cuso</span><span class="p">.</span><span class="n">find_small_roots</span><span class="p">(</span>
    <span class="n">relations</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="p">],</span>
    <span class="n">bounds</span><span class="o">=</span> <span class="p">{</span>
	    <span class="n">s1</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">270</span><span class="p">,</span> <span class="mi">2</span><span class="o">^</span><span class="mi">271</span><span class="p">),</span>
	    <span class="n">s2</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">246</span><span class="p">,</span> <span class="mi">2</span><span class="o">^</span><span class="mi">247</span><span class="p">),</span>
	<span class="p">},</span>
    <span class="n">modulus</span><span class="o">=</span><span class="n">n</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">roots</span><span class="p">,</span> <span class="s">"no roots found"</span>
<span class="n">s1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">s1</span><span class="p">])</span>
<span class="n">s2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">s2</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"L3AK{"</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">s1</span><span class="si">:</span><span class="n">x</span><span class="si">}{</span><span class="n">s2</span><span class="si">:</span><span class="n">x</span><span class="si">}</span><span class="s">').decode()</span><span class="si">}</span><span class="s">"</span> <span class="o">+</span> <span class="s">"}"</span><span class="p">)</span>
<span class="c1"># L3AK{Squ4R1ng_mY_s3cr3t_w4Snt_5m4rT_b1Vari4Te_p0lyN0MiaLs_4r3_s0Lvabl3}
</span></code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Coppersmith small roots" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry><entry><title type="html">Curveware (HTB Business CTF 2025)</title><link href="http://localhost:4000/curveware/" rel="alternate" type="text/html" title="Curveware (HTB Business CTF 2025)" /><published>2025-05-26T13:00:00+02:00</published><updated>2025-05-26T13:00:00+02:00</updated><id>http://localhost:4000/curveware</id><content type="html" xml:base="http://localhost:4000/curveware/"><![CDATA[<h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given a set of encrypted files, and an elf binary:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── business-ctf-2025-dev
│   ├── crypto
│   │   ├── curveware
│   │   │   ├── flag.txt.vlny0742e9337a
│   │   │   ├── poc.py.vlnyc2b7865f66
│   │   │   ├── README.md.vlnya68395585b
│   │   │   └── task.txt.vlnyde7ca30df0
│   │   ├── early-bird
│   │   │   ├── flag.txt.vlny4a13aac40e
│   │   │   ├── README.md.vlny1d615936ca
│   │   │   └── task.txt.vlny152e012de7
│   │   ├── hidden-handshake
│   │   │   ├── flag.txt.vlny483931d01c
│   │   │   ├── README.md.vlnyda959133e7
│   │   │   └── task.txt.vlny37927847f9
│   │   ├── phoenix-zero-trust
│   │   │   ├── flag.txt.vlny42db696fd5
│   │   │   ├── README.md.vlnyd38f3522f4
│   │   │   └── task.txt.vlny383594e3ef
│   │   └── transcoded
│   │       ├── flag.txt.vlny048404e260
│   │       ├── README.md.vlnyd323bde76d
│   │       └── task.txt.vlnye5c611e15a
│   ├── README.md.vlny311cf84811
│   └── scenario.md.vlnycba760a47c
└── curveware

&gt; file curveware
curveware: PE32+ executable (console) x86-64, for MS Windows, 15 sections
</code></pre></div></div>

<p>This looks like a ransomware challenge. Based on the challenge title, it likely involves elliptic curves in some way. To find out what encryption has been used, and what cryptographic weakness can be used to decrypt the files, we have to reverse engineer the elf binary.</p>

<h5 id="reverse-engineering">Reverse engineering</h5>

<p>By disassembling the binary in Ghidra, we can get some insight into what encryption routine has been used on the files. The main function begins by calling the function <code class="language-plaintext highlighter-rouge">GetCurveParameters(local_9e8)</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">GetCurveParameters</span><span class="p">(</span><span class="n">undefined8</span> <span class="n">param_1</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
  <span class="n">longlong</span> <span class="n">local_10</span><span class="p">;</span>
  
  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">ec_get_curve_params_by_type</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">import_params</span><span class="p">(</span><span class="n">param_1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function essentially just calls <code class="language-plaintext highlighter-rouge">ec_get_curve_params_by_type(4,&amp;local_10)</code> with curve type 4 and then instantiates the curve params with <code class="language-plaintext highlighter-rouge">import_params(param_1)</code>. One approach may be to investigate which elliptic curve corresponds to type 4 in a lookup table, but inspecting <code class="language-plaintext highlighter-rouge">ec_get_curve_params_by_type</code> reveals the curve in question:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span> <span class="nf">ec_get_curve_params_by_type</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">,</span><span class="n">undefined8</span> <span class="o">*</span><span class="n">param_2</span><span class="p">){</span>
  <span class="n">undefined8</span> <span class="n">uVar1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">local_c</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">((</span><span class="n">param_1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">!=</span> <span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">uVar1</span> <span class="o">=</span> <span class="n">local_strlen</span><span class="p">(</span><span class="s">"SECP256R1"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_c</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">local_c</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="o">*</span><span class="n">param_2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secp256r1_str_params</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">uVar1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So the program uses <code class="language-plaintext highlighter-rouge">secp256r1</code>, also known as <code class="language-plaintext highlighter-rouge">P-256</code>. We can retrieve the curve parameters from https://neuromancer.sk/std/secg/secp256r1 later. After loading the curve parameters, the main function generates a 32-byte random value <code class="language-plaintext highlighter-rouge">local_bc8</code> by calling <code class="language-plaintext highlighter-rouge">get_random(local_bc8,0x20)</code>. Afterwards, the program begins traversing the sub-directories and processes the files in <code class="language-plaintext highlighter-rouge">process_directory(pcVar5,lVar1,local_bc8,local_1578)</code>. Here, the 32-byte key <code class="language-plaintext highlighter-rouge">local_bc8</code> is passed as an argument. Also, the curve parameters <code class="language-plaintext highlighter-rouge">local_1578</code> are passed as well.</p>

<p><code class="language-plaintext highlighter-rouge">process_directory</code> is a recursive function which further traverses sub-directories, handling one directory at a time. The most notable parts of the function include:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">process_directory</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">param_1</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">param_2</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_3</span><span class="p">,</span><span class="n">undefined8</span> <span class="o">*</span><span class="n">param_4</span><span class="p">){</span>
<span class="p">[...]</span>
	<span class="n">DVar3</span> <span class="o">=</span> <span class="n">GetFileSize</span><span class="p">(</span><span class="n">hFile</span><span class="p">,(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="n">lpBuffer_00</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">((</span><span class="n">ulonglong</span><span class="p">)(</span><span class="n">DVar3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">BVar4</span> <span class="o">=</span> <span class="n">ReadFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span><span class="n">lpBuffer_00</span><span class="p">,</span><span class="n">DVar3</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_1e4</span><span class="p">,(</span><span class="n">LPOVERLAPPED</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BVar4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">encrypt_data</span><span class="p">(</span><span class="n">lpBuffer_00</span><span class="p">,</span><span class="n">local_1e4</span><span class="p">,</span><span class="n">param_3</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_1d8</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_1dc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_1d0</span><span class="p">);</span>
	<span class="n">lVar11</span> <span class="o">=</span> <span class="n">local_1d0</span><span class="p">;</span>
	<span class="n">lpBuffer</span> <span class="o">=</span> <span class="n">local_1d8</span><span class="p">;</span>
	<span class="n">DVar3</span> <span class="o">=</span> <span class="n">local_1dc</span><span class="p">;</span>
	<span class="n">sign_data</span><span class="p">(</span><span class="n">local_1c8</span><span class="p">,</span><span class="n">param_4</span><span class="p">,</span><span class="n">param_3</span><span class="p">,</span><span class="n">local_1d8</span><span class="p">,</span><span class="n">local_1dc</span><span class="p">,</span><span class="n">local_1d0</span><span class="p">);</span>
<span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This section essentially reads in a file into the buffer <code class="language-plaintext highlighter-rouge">lpBuffer_00</code>, before calling the encryption routine <code class="language-plaintext highlighter-rouge">encrypt_data(lpBuffer_00,local_1e4,param_3,&amp;local_1d8,&amp;local_1dc,&amp;local_1d0)</code>. The variable <code class="language-plaintext highlighter-rouge">param_3</code> corresponds to the 32-byte key that was generated earlier. The encryption routine is as follows:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">encrypt_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param_1</span><span class="p">,</span><span class="n">uint</span> <span class="n">param_2</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_3</span><span class="p">,</span><span class="n">longlong</span> <span class="o">*</span><span class="n">param_4</span><span class="p">,</span><span class="n">uint</span> <span class="o">*</span><span class="n">param_5</span><span class="p">,</span> <span class="n">undefined8</span> <span class="o">*</span><span class="n">param_6</span><span class="p">){</span>
<span class="p">[...]</span>
  <span class="n">sha256</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span><span class="n">param_2</span><span class="p">);</span>
  <span class="n">uVar5</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulonglong</span><span class="p">)</span><span class="n">param_2</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="n">uVar4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">param_4</span> <span class="o">+</span> <span class="n">uVar5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">uVar6</span><span class="p">;</span>
    <span class="n">uVar5</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulonglong</span><span class="p">)</span><span class="n">uVar4</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">uVar3</span> <span class="o">!=</span> <span class="n">uVar4</span><span class="p">);</span>
  <span class="n">get_random</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_158</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
  <span class="n">AES_init_ctx_iv</span><span class="p">(</span><span class="n">local_148</span><span class="p">,</span><span class="n">param_3</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_158</span><span class="p">);</span>
  <span class="n">AES_CBC_encrypt_buffer</span><span class="p">(</span><span class="n">local_148</span><span class="p">,</span><span class="o">*</span><span class="n">param_4</span><span class="p">,</span><span class="o">*</span><span class="n">param_5</span><span class="p">);</span>
<span class="p">[...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The plaintext <code class="language-plaintext highlighter-rouge">param_1</code> is hashed using SHA256. The hashed plaintext is saved into <code class="language-plaintext highlighter-rouge">param_6</code>. Then, a 16-byte random IV  is generated with <code class="language-plaintext highlighter-rouge">get_random(&amp;local_158,0x10)</code> and is passed to <code class="language-plaintext highlighter-rouge">AES_init_ctx_iv()</code> along with the 32-byte encryption key <code class="language-plaintext highlighter-rouge">param_3</code>. The plaintext is encrypted, and the IV is appended to the ciphertext before returning.</p>

<p>Back in the <code class="language-plaintext highlighter-rouge">process_directory</code> function, the ciphertext is signed with <code class="language-plaintext highlighter-rouge">sign_data(local_1c8,param_4,param_3,local_1d8,local_1dc,local_1d0)</code>. Crucially, the AES key <code class="language-plaintext highlighter-rouge">param_3</code> is passed to this function along with the ciphertext <code class="language-plaintext highlighter-rouge">local_1d8</code>, curve parameters <code class="language-plaintext highlighter-rouge">param_4</code> and plaintext hash <code class="language-plaintext highlighter-rouge">local_1d0</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">sign_data</span><span class="p">(</span><span class="n">longlong</span> <span class="n">param_1</span><span class="p">,</span><span class="n">longlong</span> <span class="n">param_2</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_3</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_4</span><span class="p">,</span> <span class="n">undefined4</span> <span class="n">param_5</span><span class="p">,</span><span class="n">undefined8</span> <span class="n">param_6</span><span class="p">){</span>
<span class="p">[...]</span>
  <span class="n">sha256</span><span class="p">(</span><span class="n">param_4</span><span class="p">,</span><span class="n">param_5</span><span class="p">,</span><span class="n">local_678</span><span class="p">);</span>
  <span class="n">nn_init_from_buf</span><span class="p">(</span><span class="n">local_428</span><span class="p">,</span><span class="n">local_678</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
  <span class="n">nn_init_from_buf</span><span class="p">(</span><span class="n">local_578</span><span class="p">,</span><span class="n">param_3</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
  <span class="n">nn_init_from_buf</span><span class="p">(</span><span class="n">local_5e8</span><span class="p">,</span><span class="n">param_6</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
<span class="p">[...]</span>
  <span class="n">prj_pt_mul</span><span class="p">(</span><span class="n">local_1c8</span><span class="p">,</span><span class="n">local_5e8</span><span class="p">,</span><span class="n">param_2</span> <span class="o">+</span> <span class="mh">0x560</span><span class="p">);</span>
  <span class="n">prj_pt_to_aff</span><span class="p">(</span><span class="n">local_2d8</span><span class="p">,</span><span class="n">local_1c8</span><span class="p">);</span>
  <span class="n">nn_mod_sub</span><span class="p">(</span><span class="n">local_3b8</span><span class="p">,</span><span class="n">local_428</span><span class="p">,</span><span class="n">local_2d8</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_658</span><span class="p">);</span>
  <span class="n">nn_modinv_fermat</span><span class="p">(</span><span class="n">local_508</span><span class="p">,</span><span class="n">local_578</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_658</span><span class="p">);</span>
  <span class="n">nn_mod_sub</span><span class="p">(</span><span class="n">local_498</span><span class="p">,</span><span class="n">local_5e8</span><span class="p">,</span><span class="n">local_3b8</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_658</span><span class="p">);</span>
  <span class="n">nn_mod_mul</span><span class="p">(</span><span class="n">local_348</span><span class="p">,</span><span class="n">local_508</span><span class="p">,</span><span class="n">local_498</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_658</span><span class="p">);</span>
  <span class="n">nn_export_to_buf</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">local_3b8</span><span class="p">);</span>
  <span class="n">nn_export_to_buf</span><span class="p">(</span><span class="n">param_1</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="n">local_348</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This signing routine essentially performs a series of computations like follows:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sha256(param_4,param_5,local_678)</code> is the SHA256 of the ciphertext</li>
  <li><code class="language-plaintext highlighter-rouge">nn_init_from_buf(local_428,local_678,0x20)</code> loads the ciphertext hash $z$ to <code class="language-plaintext highlighter-rouge">local_428</code></li>
  <li><code class="language-plaintext highlighter-rouge">nn_init_from_buf(local_578,param_3,0x20)</code> loads the AES key $d$ to <code class="language-plaintext highlighter-rouge">local_578</code></li>
  <li><code class="language-plaintext highlighter-rouge">nn_init_from_buf(local_5e8,param_6,0x20)</code> loads the nonce $k$ (plaintext hash) to <code class="language-plaintext highlighter-rouge">local_5e8</code></li>
  <li><code class="language-plaintext highlighter-rouge">prj_pt_mul(local_1c8,local_5e8,param_2 + 0x560)</code> calculates $R = k \cdot G$</li>
  <li><code class="language-plaintext highlighter-rouge">prj_pt_to_aff(local_2d8,local_1c8)</code> gets the affine coordinate $R.x$</li>
  <li><code class="language-plaintext highlighter-rouge">nn_mod_sub(local_3b8,local_428,local_2d8,&amp;local_658)</code> calculates $r = (z - R.x) \mod n$</li>
  <li><code class="language-plaintext highlighter-rouge">nn_modinv_fermat(local_508,local_578,&amp;local_658)</code> calculates $d^{-1} \mod n$</li>
  <li><code class="language-plaintext highlighter-rouge">nn_mod_sub(local_498,local_5e8,local_3b8,&amp;local_658)</code> calculates $k - r \mod n$</li>
  <li><code class="language-plaintext highlighter-rouge">nn_mod_mul(local_348,local_508,local_498,&amp;local_658)</code> calculates $s = (k-r)\cdot d^{-1} \mod n$</li>
</ul>

<p>Where $n$ is the curve order of <code class="language-plaintext highlighter-rouge">secp256r1</code>. The signature, consisting of values $(r,s)$, are returned by the function. The signing process looks similar to ECDSA, but it is not the same. We have $k = r+sd$ while ECDSA uses $k = s^{-1}(z+rd)$</p>

<p>Returning to <code class="language-plaintext highlighter-rouge">process_directory</code>, the function does some final crucial steps:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="n">_Memory</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">lVar11</span> <span class="o">+</span> <span class="mh">0x1b</span><span class="p">);</span>
<span class="o">*</span><span class="p">(</span><span class="n">undefined1</span> <span class="o">*</span><span class="p">)(</span><span class="n">_Memory</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined1</span> <span class="o">*</span><span class="p">)(</span><span class="n">lVar11</span> <span class="o">+</span> <span class="mh">0x1f</span><span class="p">);</span>
<span class="n">_Source</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mh">0xb</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">puVar12</span> <span class="o">=</span> <span class="n">_Memory</span><span class="p">;</span>
<span class="n">pcVar10</span> <span class="o">=</span> <span class="n">_Source</span><span class="p">;</span>
<span class="k">do</span> <span class="p">{</span>
	<span class="n">uVar1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined1</span> <span class="o">*</span><span class="p">)</span><span class="n">puVar12</span><span class="p">;</span>
	<span class="n">pcVar15</span> <span class="o">=</span> <span class="n">pcVar10</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">puVar12</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)((</span><span class="n">longlong</span><span class="p">)</span><span class="n">puVar12</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">__mingw_snprintf</span><span class="p">(</span><span class="n">pcVar10</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="o">&amp;</span><span class="p">.</span><span class="n">rdata</span><span class="p">,</span><span class="n">uVar1</span><span class="p">);</span>
	<span class="n">pcVar10</span> <span class="o">=</span> <span class="n">pcVar15</span><span class="p">;</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pcVar15</span> <span class="o">!=</span> <span class="n">_Source</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
<span class="n">DVar5</span> <span class="o">=</span> <span class="n">SetFilePointer</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span><span class="mi">0</span><span class="p">,(</span><span class="n">PLONG</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="n">BVar4</span> <span class="o">=</span> <span class="n">WriteFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span><span class="n">local_1c8</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_1e0</span><span class="p">,(</span><span class="n">LPOVERLAPPED</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
<span class="n">BVar4</span> <span class="o">=</span> <span class="n">WriteFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span><span class="n">lpBuffer</span><span class="p">,</span><span class="n">DVar3</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_1e0</span><span class="p">,(</span><span class="n">LPOVERLAPPED</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>
<span class="n">pcVar10</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">lVar8</span> <span class="o">+</span> <span class="mh">0x11</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">strncpy</span><span class="p">(</span><span class="n">pcVar10</span><span class="p">,</span><span class="n">pcVar7</span><span class="p">,</span><span class="n">lVar8</span> <span class="o">+</span> <span class="mi">1U</span><span class="p">);</span>
<span class="n">sVar6</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pcVar10</span><span class="p">);</span>
<span class="n">builtin_strncpy</span><span class="p">(</span><span class="n">pcVar10</span> <span class="o">+</span> <span class="n">sVar6</span><span class="p">,</span><span class="s">".vlny"</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
<span class="n">strncat</span><span class="p">(</span><span class="n">pcVar10</span><span class="p">,</span><span class="n">_Source</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<span class="n">BVar4</span> <span class="o">=</span> <span class="n">MoveFileA</span><span class="p">(</span><span class="n">pcVar7</span><span class="p">,</span><span class="n">pcVar10</span><span class="p">);</span> 
</code></pre></div></div>

<p>This part essentially appends the suffix <code class="language-plaintext highlighter-rouge">.vlny</code> to the encrypted file’s filename, followed by 10 hex digits (5 bytes) of the plaintext hash. This is a critical part, as the plaintext hash is used as the nonce during the signing process, meaning we have a partial nonce leak for every signature. The 5 bytes correspond to the 40 least significant bits. This final part also writes the encrypted file contents, consisting of the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signing variable s (32 bytes)
signing variable r (32 bytes)
ciphertext 
IV (16 bytes)
</code></pre></div></div>

<h5 id="decrypting-files">Decrypting files</h5>

<p>With a solid overview over the encryption process, signing process, and the file structure, the cryptographic vulnerability becomes quite apparent. 40/256 bits are leaked for all 18 signatures, allowing for the recovery of the private key $d$ by setting up and solving a hidden number problem instance. Since the private key $d$ is used for both signing and AES encryption, recovering the original plaintext file contents becomes trivial.</p>

<p>Like mentioned earlier, the custom signing algorithm uses the equation:</p>

\[\large k = r + s\cdot d\]

<p>Since we have a partial leak of the nonce, we can rewrite to:</p>

\[\large \begin{align}
\nonumber leak + 2^{40} \cdot x &amp;\equiv r + s \cdot d \mod n\\
\nonumber s \cdot d - 2^{40}\cdot x &amp;\equiv leak - r \mod n \\
\nonumber 2^{40^{-1}} \cdot s \cdot d - x &amp;\equiv 2^{40^{-1}}(leak - r) \mod n \\
\nonumber x - 2^{40^{-1}}\cdot s\cdot d+2^{40^{-1}}(leak-r) &amp;\equiv 0 \mod n
\end{align}\]

<p>Which is precisely a hidden number problem instance: $\beta_{i} - t_{i} \cdot \alpha + a_{i} \equiv 0 \mod p$ with $t = 2^{40^{-1}}\cdot s$ and $a = 2^{40^{-1}}(leak-r)$</p>

<p>The private key $d$ can be recovered by running LLL on the following lattice:</p>

\[\large B' = \begin{bmatrix}
n &amp;  &amp;  &amp;  &amp;  &amp; \\
 &amp; n &amp;  &amp;  &amp;  &amp; \\
 &amp;  &amp; \ddots &amp;  &amp;  &amp; \\
 &amp;  &amp;  &amp; n &amp;  &amp; \\
t_{1} &amp; t_{2} &amp; \dots &amp; t_{m} &amp; 2^{40}/n  \\
a_{1} &amp; a_{2} &amp; \dots &amp; a_{m} &amp;  &amp; 2^{40}
\end{bmatrix}\]

<p>With short vector $\large u’ = (x_{1},\dots,x_{m},2^{40}d/n,-2^{40})$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">M</span> <span class="o">=</span> <span class="n">identity_matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">n</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">vector</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">vector</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">vector</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="n">B</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">vector</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="n">B</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">B</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="o">/</span><span class="n">B</span> <span class="o">%</span> <span class="n">n</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"d = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">break</span>
<span class="c1"># d = 0xc5120eda0305ce74a125b5bd727e4fee5a24457ab376b69578c179f8440881e0
</span></code></pre></div></div>

<p>With the private key recovered, the <code class="language-plaintext highlighter-rouge">flag.txt.vlny0742e9337a</code> file can be decrypted, giving us our flag!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTB{m4lw4r3_d3v3l0p3rs_sh0uld_sTuDy_m0r3_crypt0}
</code></pre></div></div>

<h5 id="solvesage">solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">unpad</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="n">n</span> <span class="o">=</span> <span class="mh">0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">40</span>     
<span class="n">Binv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>                   

<span class="n">root</span>  <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'business-ctf-2025-dev'</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">rglob</span><span class="p">(</span><span class="s">'*.vlny*'</span><span class="p">))</span>

<span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">leak</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">blob</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">()</span>
    <span class="n">r</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span>  <span class="p">:</span><span class="mi">32</span><span class="p">]))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">blob</span><span class="p">[</span><span class="mi">32</span><span class="p">:</span><span class="mi">64</span><span class="p">]))</span>
    <span class="n">leak</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="mi">16</span><span class="p">))</span>

<span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">leak</span><span class="p">):</span>
    <span class="n">t</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">Binv</span> <span class="o">*</span> <span class="n">si</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">a</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">Binv</span> <span class="o">*</span> <span class="p">(</span><span class="n">li</span> <span class="o">-</span> <span class="n">ri</span><span class="p">))</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>

<span class="n">M</span> <span class="o">=</span> <span class="n">identity_matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">n</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">vector</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">vector</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">vector</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="n">B</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">augment</span><span class="p">(</span><span class="n">vector</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="n">B</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">.</span><span class="n">LLL</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">B</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="o">/</span><span class="n">B</span> <span class="o">%</span> <span class="n">n</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"d = </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">break</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># curvewave flagfile
</span><span class="n">blob</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">()</span>
<span class="n">ct</span>  <span class="o">=</span> <span class="n">blob</span><span class="p">[</span><span class="mi">64</span><span class="p">:]</span>          
<span class="n">iv</span>  <span class="o">=</span> <span class="n">ct</span><span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
<span class="n">pt</span>  <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ct</span><span class="p">[:</span><span class="o">-</span><span class="mi">16</span><span class="p">]),</span> <span class="mi">16</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>   
</code></pre></div></div>]]></content><author><name>Zukane</name></author><category term="writeups" /><category term="Elliptic Curve" /><category term="Hidden Number Problem" /><category term="Ransomware" /><category term="Reverse Engineering" /><summary type="html"><![CDATA[Challenge overview]]></summary></entry></feed>