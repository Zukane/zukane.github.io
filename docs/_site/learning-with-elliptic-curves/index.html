<!DOCTYPE html>
<html lang="en">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Learning with Elliptic Curves (HelseCTF 2025) | Zukane CTF</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Learning with Elliptic Curves (HelseCTF 2025)" />
<meta name="author" content="Zukane" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Challenge overview" />
<meta property="og:description" content="Challenge overview" />
<link rel="canonical" href="https://zukane.github.io/learning-with-elliptic-curves/" />
<meta property="og:url" content="https://zukane.github.io/learning-with-elliptic-curves/" />
<meta property="og:site_name" content="Zukane CTF" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-03-09T11:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Learning with Elliptic Curves (HelseCTF 2025)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zukane"},"dateModified":"2025-03-09T11:00:00+01:00","datePublished":"2025-03-09T11:00:00+01:00","description":"Challenge overview","headline":"Learning with Elliptic Curves (HelseCTF 2025)","mainEntityOfPage":{"@type":"WebPage","@id":"https://zukane.github.io/learning-with-elliptic-curves/"},"url":"https://zukane.github.io/learning-with-elliptic-curves/"}</script>
<!-- End Jekyll SEO tag -->

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning with Elliptic Curves (HelseCTF 2025)</title>
    <link rel="stylesheet" href="/assets/css/obsidian-theme.css">
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <meta name="google-site-verification" content="dyMwt_XPwaeGY1MubEtKTorF4C368AHqIwugUO8c6P8" />
    <!-- MathJax configuration -->
    <script>
        window.MathJax = {
          tex: {
            packages: {'[+]': ['ams']},
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            tags: 'ams',
            // Optional: Enable automatic equation numbering (if desired)
            // equationNumbers: { autoNumber: "AMS" }
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
          }
        };
      </script>
      <script id="MathJax-script" async
              src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
      </script>
      
  </head>
  <body class="theme-dark">
    <header>
      <!-- Optionally, show a site title -->
      <h1><a href="/", style="color: #ff5757;">Zukane CTF</a></h1>
    </header>
    <div class="container">
      <!-- Display post title from front matter -->
      
        <h2 class="post-title">Learning with Elliptic Curves (HelseCTF 2025)</h2>
      
      
        <div class="post-tags">
            
            <a href="/tags/elliptic-curve/" class="tag">Elliptic Curve</a>
            
            <a href="/tags/ecdlp/" class="tag">ECDLP</a>
            
            <a href="/tags/lwe/" class="tag">LWE</a>
            
            <a href="/tags/lattice/" class="tag">Lattice</a>
            
        </div>
      

      <!-- Main content -->
      <h5 id="challenge-overview">Challenge overview</h5>

<p>In this CTF challenge, we are given the following python source code, along with the output.txt</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sage.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">hemmelig</span> <span class="kn">import</span> <span class="n">flagg</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">39761755302725183918693591729206126391094688519137850931996389197052105934335057950945885109127019315116708698582684135940731</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">37470413545164594923241940723449977961814431955261347161951289533994732796785078955994373335971437954627235171462939970255523</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">33862474237826219764283873646917712191796653587975971730267794592641857158089029148517141460472220490573591617494610494543421</span> 

<span class="n">gf</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"G = </span><span class="si">{</span><span class="n">G</span><span class="p">.</span><span class="n">xy</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">offentlig_nøkkel</span> <span class="o">=</span> <span class="p">[</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">flagg</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"offentlig_nøkkel = </span><span class="si">{</span><span class="p">[</span><span class="n">P</span><span class="p">.</span><span class="n">xy</span><span class="p">()</span> <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">offentlig_nøkkel</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">hemmelighet</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flagg</span><span class="p">]</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span>

<span class="n">resultat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span> <span class="o">*</span> <span class="n">h</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">offentlig_nøkkel</span><span class="p">,</span> <span class="n">hemmelighet</span><span class="p">))</span> <span class="o">+</span> <span class="n">error</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"resultat = </span><span class="si">{</span><span class="n">resultat</span><span class="p">.</span><span class="n">xy</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>This is a Learning with Errors type of challenge, but based on elliptic curve arithmetic. We are given the public key consisting of a random point on the curve $E$ for each character in the flag. We are also given point $resultat$ from the LWE-looking equation. The encryption is essentially:</p>

\[\large resultat = \left( \sum_{i=0}^{n-1} o_{i}\cdot h_{i} \right) + error\]

<p>But since $h_{i}$ is just a small integer value, and each point in the public key is computed as</p>

\[\large r_{i}\cdot G\]

<p>Where $r_{i}$ is a random integer, we can rewrite as</p>

\[\large resultat = \left( \sum_{i=0}^{n-1} r_{i}\cdot h_{i} + e\right) \cdot G\]

<p>This means we could potentially compute the discrete logarithm for $resultat$ to unwrap the elliptic curve arithmetic back into an integer equation. We can also compute the discrete logarithm of the public key points $o_{i}$ with respect to $G$ to recover $r_{i}$, which would leave us with an equation of the form</p>

\[\large X = \sum_{i=0}^{n-1} r_{i}\cdot h_{i}+e \mod order(G)\]

<p>The equation is a modular linear equation with small unknowns. We can utilize this solver: https://github.com/nneonneo/pwn-stuff/blob/main/math/solvelinmod.py, but we need to make some preparations first.</p>

<p>Normally, the discrete logarithm problem can be quite tricky to solve. However, in our case, the order of curve $E$ is very smooth:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sage</span><span class="p">:</span> <span class="n">factor</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">order</span><span class="p">())</span>
<span class="mi">2</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">11</span> <span class="o">*</span> <span class="mi">13</span> <span class="o">*</span> <span class="mi">19</span> <span class="o">*</span> <span class="mi">31</span> <span class="o">*</span> <span class="mi">59</span> <span class="o">*</span> <span class="mi">67</span> <span class="o">*</span> <span class="mi">79</span> <span class="o">*</span> <span class="mi">101</span> <span class="o">*</span> <span class="mi">103</span> <span class="o">*</span> <span class="mi">139</span> <span class="o">*</span> <span class="mi">179</span> <span class="o">*</span> <span class="mi">233</span> <span class="o">*</span> <span class="mi">241</span> <span class="o">*</span> <span class="mi">269</span> <span class="o">*</span> <span class="mi">271</span> <span class="o">*</span> <span class="mi">283</span><span class="o">^</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">419</span> <span class="o">*</span> <span class="mi">431</span> <span class="o">*</span> <span class="mi">439</span> <span class="o">*</span> <span class="mi">463</span> <span class="o">*</span> <span class="mi">509</span> <span class="o">*</span> <span class="mi">563</span> <span class="o">*</span> <span class="mi">571</span> <span class="o">*</span> <span class="mi">617</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">641</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">659</span> <span class="o">*</span> <span class="mi">691</span> <span class="o">*</span> <span class="mi">719</span> <span class="o">*</span> <span class="mi">733</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">739</span> <span class="o">*</span> <span class="mi">743</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">773</span> <span class="o">*</span> <span class="mi">797</span> <span class="o">*</span> <span class="mi">821</span> <span class="o">*</span> <span class="mi">823</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">829</span> <span class="o">*</span> <span class="mi">929</span> <span class="o">*</span> <span class="mi">937</span> <span class="o">*</span> <span class="mi">977</span>
</code></pre></div></div>

<p>meaning it is easy to solve with something like Pohlig-Hellman.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Computing discrete logs for public keys ..."</span><span class="p">)</span>
<span class="n">r_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">offentlig_nøkkel</span><span class="p">:</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>
	<span class="n">r_values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">order</span> <span class="o">=</span> <span class="n">G</span><span class="p">.</span><span class="n">order</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">resultat</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>
</code></pre></div></div>

<p>We can now begin to set up the equation for $X$ where we wish to solve for the unknown flag characters $h_{i}$.
Firstly, we must define some variables to represent the unknowns:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_values</span><span class="p">)</span>
<span class="n">flag_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">(</span><span class="sa">f</span><span class="s">"x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">e_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s">"e"</span><span class="p">)</span>
</code></pre></div></div>

<p>We can now express our equation as</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">equation</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">flag_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="n">e_var</span> <span class="o">==</span> <span class="n">X</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
</code></pre></div></div>

<p>Lastly, we need to define the bounds of possible values for the unknowns. We know $h_{i}$ are the numerical ascii codes for the flag characters, which means the possible values are between $0, 256$ (we could in reality assume that its between $32, 126$ for printable characters). And from the source code, we already know the error value $e$ is between $-1000, 1000$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="n">flag_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)}</span>
<span class="n">bounds</span><span class="p">[</span><span class="n">e_var</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># (min, expected, max)
</span></code></pre></div></div>

<p>And with everything set up, we can now utilize the linmod solver after it has been imported:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Solving modular linear equation using lattice reduction..."</span><span class="p">)</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">solve_linear_mod</span><span class="p">([</span><span class="n">equation</span><span class="p">],</span> <span class="n">bounds</span><span class="p">)</span>
<span class="n">recovered_flag</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="n">flag_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Recovered flag: </span><span class="si">{</span><span class="n">recovered_flag</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="c1">#Recovered flag: helsectf{Ell1pt15k3_kurv3r_3r_l1vet!}
</span></code></pre></div></div>

<h5 id="solvesage">Solve.sage</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">sage.all</span> <span class="kn">import</span> <span class="n">ZZ</span><span class="p">,</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">var</span>

<span class="c1"># Solver from: https://github.com/nneonneo/pwn-stuff/blob/main/math/solvelinmod.py
</span><span class="k">def</span> <span class="nf">_process_linear_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">guesses</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">rel</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">:</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">rel</span><span class="p">.</span><span class="n">operator</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">operator</span><span class="p">.</span><span class="n">eq</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s">"relation </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s">: not an equality relation"</span><span class="p">)</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel</span> <span class="o">-</span> <span class="n">rel</span><span class="p">.</span><span class="n">rhs</span><span class="p">()).</span><span class="n">lhs</span><span class="p">().</span><span class="n">expand</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">.</span><span class="n">variables</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"relation </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s">: variable </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s"> is not bounded"</span><span class="p">)</span>

        <span class="c1"># Fill in eqns block of B
</span>        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expr</span><span class="p">.</span><span class="n">degree</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"relation </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s">: equation is not linear in </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="n">expr</span><span class="p">.</span><span class="n">coefficient</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">coeff</span><span class="p">.</span><span class="n">is_constant</span><span class="p">():</span>
                <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"relation </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s">: coefficient of </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s"> is not constant (equation is not linear)"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">coeff</span><span class="p">.</span><span class="n">is_integer</span><span class="p">():</span>
                <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"relation </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s">: coefficient of </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s"> is not an integer"</span><span class="p">)</span>

            <span class="n">coeff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">%=</span> <span class="n">m</span>
            <span class="n">coeffs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>

        <span class="c1"># Shift variables towards their guesses to reduce the (expected) length of the solution vector
</span>        <span class="n">const</span> <span class="o">=</span> <span class="n">expr</span><span class="p">.</span><span class="n">subs</span><span class="p">({</span><span class="n">var</span><span class="p">:</span> <span class="n">guesses</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">const</span><span class="p">.</span><span class="n">is_constant</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"relation </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s">: failed to extract constant"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">const</span><span class="p">.</span><span class="n">is_integer</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"relation </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s">: constant is not integer"</span><span class="p">)</span>

        <span class="n">const</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">const</span> <span class="o">%=</span> <span class="n">m</span>

        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">solve_linear_mod</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_flatter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">lll_args</span><span class="p">):</span>
    <span class="s">"""Solve an arbitrary system of modular linear equations over different moduli.

    equations: A sequence of (lhs == rhs, M) pairs, where lhs and rhs are expressions and M is the modulus.
        M may be None to indicate that the equation is not modular.
    bounds: A dictionary of {var: B} entries, where var is a variable and B is the bounds on that variable.
        Bounds may be specified in one of three ways:
        - A single integer X: Variable is assumed to be uniformly distributed in [0, X] with an expected value of X/2.
        - A tuple of integers (X, Y): Variable is assumed to be uniformly distributed in [X, Y] with an expected value of (X + Y)/2.
        - A tuple of integers (X, E, Y): Variable is assumed to be bounded within [X, Y] with an expected value of E.
        All variables used in the equations must be bounded.
    verbose: set to True to enable additional output
    use_flatter: set to True to use [flatter](https://github.com/keeganryan/flatter), which is much faster
    lll_args: Additional arguments passed to LLL, for advanced usage.

    NOTE: Bounds are *soft*. This function may return solutions above the bounds. If this happens, and the result
    is incorrect, make some bounds tighter and try again.

    Tip: if you get an unwanted solution, try setting the expected values to that solution to force this function
    to produce a different solution.

    Tip: if your bounds are loose and you just want small solutions, set the expected values to zero for all
    loosely-bounded variables.

    &gt;&gt;&gt; k = var('k')
    &gt;&gt;&gt; # solve CRT
    &gt;&gt;&gt; solve_linear_mod([(k == 2, 3), (k == 4, 5), (k == 3, 7)], {k: 3*5*7})
    {k: 59}

    &gt;&gt;&gt; x,y = var('x,y')
    &gt;&gt;&gt; solve_linear_mod([(2*x + 3*y == 7, 11), (3*x + 5*y == 3, 13), (2*x + 5*y == 6, 143)], {x: 143, y: 143})
    {x: 62, y: 5}

    &gt;&gt;&gt; x,y = var('x,y')
    &gt;&gt;&gt; # we can also solve homogenous equations, provided the guesses are zeroed
    &gt;&gt;&gt; solve_linear_mod([(2*x + 5*y == 0, 1337)], {x: 5, y: 5}, guesses={x: 0, y: 0})
    {x: 5, y: -2}
    """</span>

    <span class="c1"># The general idea is to set up an integer matrix equation Ax=y by introducing extra variables for the quotients,
</span>    <span class="c1"># then use LLL to solve the equation. We introduce extra axes in the lattice to observe the actual solution x,
</span>    <span class="c1"># which works so long as the solutions are known to be bounded (which is of course the case for modular equations).
</span>    <span class="c1"># Scaling factors are configured to generally push the smallest vectors to have zeros for the relations, and to
</span>    <span class="c1"># scale disparate variables to approximately the same base.
</span>
    <span class="nb">vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">guesses</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">var_scale</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bound</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
                <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">xmin</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span><span class="s">"Bounds must be integers, 2-tuples or 3-tuples"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">guess</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Bound for variable </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s"> is invalid (</span><span class="si">{</span><span class="n">xmin</span><span class="o">=</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">guess</span><span class="o">=</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">xmax</span><span class="o">=</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
        <span class="n">var_scale</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">guess</span><span class="p">,</span> <span class="n">guess</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">guesses</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess</span>

    <span class="n">var_bits</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">prod</span><span class="p">(</span><span class="n">var_scale</span><span class="p">.</span><span class="n">values</span><span class="p">())))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
    <span class="n">mod_bits</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">prod</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">rel</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">equations</span> <span class="k">if</span> <span class="n">m</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"verbose: variable entropy: </span><span class="si">{</span><span class="n">var_bits</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> bits"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"verbose: modulus entropy: </span><span class="si">{</span><span class="n">mod_bits</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> bits"</span><span class="p">)</span>

    <span class="c1"># Extract coefficients from equations
</span>    <span class="n">equation_coeffs</span> <span class="o">=</span> <span class="n">_process_linear_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">guesses</span><span class="p">)</span>

    <span class="n">is_inhom</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">const</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">equation_coeffs</span><span class="p">)</span>
    <span class="n">mod_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">equation_coeffs</span> <span class="k">if</span> <span class="n">m</span><span class="p">)</span>

    <span class="n">NR</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">equation_coeffs</span><span class="p">)</span>
    <span class="n">NV</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_inhom</span><span class="p">:</span>
        <span class="c1"># Add one dummy variable for the constant term.
</span>        <span class="n">NV</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">mod_count</span> <span class="o">+</span> <span class="n">NV</span><span class="p">,</span> <span class="n">NR</span> <span class="o">+</span> <span class="n">NV</span><span class="p">)</span>

    <span class="c1"># B format (rows are the basis for the lattice):
</span>    <span class="c1"># [ mods:NRxNR 0
</span>    <span class="c1">#   eqns:NVxNR vars:NVxNV ]
</span>    <span class="c1"># eqns correspond to equation axes, fi(...) = yi mod mi
</span>    <span class="c1"># vars correspond to variable axes, which effectively "observe" elements of the solution vector (x in Ax=y)
</span>    <span class="c1"># mods and vars are diagonal, so this matrix is lower triangular.
</span>
    <span class="c1"># Compute maximum scale factor over all variables
</span>    <span class="n">S</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">var_scale</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Compute equation scale such that the bounded solution vector (equation columns all zero)
</span>    <span class="c1"># will be shorter than any vector that has a nonzero equation column
</span>    <span class="n">eqS</span> <span class="o">=</span> <span class="n">S</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">NR</span> <span class="o">+</span> <span class="n">NV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># If the equation is underconstrained, add additional scaling to find a solution anyway
</span>    <span class="k">if</span> <span class="n">var_bits</span> <span class="o">&gt;</span> <span class="n">mod_bits</span><span class="p">:</span>
        <span class="n">eqS</span> <span class="o">&lt;&lt;=</span> <span class="nb">int</span><span class="p">((</span><span class="n">var_bits</span> <span class="o">-</span> <span class="n">mod_bits</span><span class="p">)</span> <span class="o">/</span> <span class="n">NR</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">col_scales</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">mi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equation_coeffs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
            <span class="n">B</span><span class="p">[</span><span class="n">mod_count</span> <span class="o">+</span> <span class="n">vi</span><span class="p">,</span> <span class="n">ri</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">if</span> <span class="n">is_inhom</span><span class="p">:</span>
            <span class="n">B</span><span class="p">[</span><span class="n">mod_count</span> <span class="o">+</span> <span class="n">NV</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ri</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">B</span><span class="p">[</span><span class="n">mi</span><span class="p">,</span> <span class="n">ri</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">mi</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">col_scales</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">eqS</span><span class="p">)</span>

    <span class="c1"># Compute per-variable scale such that the variable axes are scaled roughly equally
</span>    <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
        <span class="n">col_scales</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span> <span class="o">//</span> <span class="n">var_scale</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="c1"># Fill in vars block of B
</span>        <span class="n">B</span><span class="p">[</span><span class="n">mod_count</span> <span class="o">+</span> <span class="n">vi</span><span class="p">,</span> <span class="n">NR</span> <span class="o">+</span> <span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">is_inhom</span><span class="p">:</span>
        <span class="c1"># Const block: effectively, this is a bound of 1 on the constant term
</span>        <span class="n">col_scales</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="n">B</span><span class="p">[</span><span class="n">mod_count</span> <span class="o">+</span> <span class="n">NV</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"verbose: scaling shifts:"</span><span class="p">,</span> <span class="p">[</span><span class="n">math</span><span class="p">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">col_scales</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"verbose: matrix dimensions:"</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">dimensions</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"verbose: unscaled matrix before:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">n</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_scales</span><span class="p">):</span>
        <span class="n">B</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">s</span>
    <span class="k">if</span> <span class="n">use_flatter</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">findall</span>
        <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">check_output</span>

        <span class="c1"># compile https://github.com/keeganryan/flatter and put it in $PATH
</span>        <span class="n">z</span> <span class="o">=</span> <span class="s">"[["</span> <span class="o">+</span> <span class="s">"]</span><span class="se">\n</span><span class="s">["</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">" "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="s">"]]"</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">([</span><span class="s">"flatter"</span><span class="p">],</span> <span class="nb">input</span><span class="o">=</span><span class="n">z</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">nrows</span><span class="p">(),</span> <span class="n">B</span><span class="p">.</span><span class="n">ncols</span><span class="p">(),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">findall</span><span class="p">(</span><span class="sa">b</span><span class="s">"-?</span><span class="se">\\</span><span class="s">d+"</span><span class="p">,</span> <span class="n">ret</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">LLL</span><span class="p">(</span><span class="o">**</span><span class="n">lll_args</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_scales</span><span class="p">):</span>
        <span class="n">B</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">s</span>

    <span class="c1"># Negate rows for more readable output
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">nrows</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">&gt;</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]):</span>
            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">is_inhom</span> <span class="ow">and</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"verbose: unscaled matrix after:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="n">n</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">B</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[:</span><span class="n">NR</span><span class="p">]):</span>
            <span class="c1"># invalid solution: some relations are nonzero
</span>            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">is_inhom</span><span class="p">:</span>
            <span class="c1"># Each row is a potential solution, but some rows may not carry a constant.
</span>            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span>
                        <span class="s">"verbose: zero solution"</span><span class="p">,</span>
                        <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">NR</span> <span class="o">+</span> <span class="n">vi</span><span class="p">]</span> <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">NR</span> <span class="o">+</span> <span class="n">vi</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">NR</span> <span class="o">+</span> <span class="n">vi</span><span class="p">]</span> <span class="o">+</span> <span class="n">guesses</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">res</span>


<span class="n">p</span> <span class="o">=</span> <span class="mi">39761755302725183918693591729206126391094688519137850931996389197052105934335057950945885109127019315116708698582684135940731</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">37470413545164594923241940723449977961814431955261347161951289533994732796785078955994373335971437954627235171462939970255523</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">33862474237826219764283873646917712191796653587975971730267794592641857158089029148517141460472220490573591617494610494543421</span> 

<span class="n">gf</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"G ="</span><span class="p">,</span> <span class="n">G</span><span class="p">.</span><span class="n">xy</span><span class="p">())</span>

<span class="n">offentlig_nokkel_coords</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">(</span><span class="mi">19344995651025956194741672391212032148363490396937400401146819955355580393176808369173184320136313448134647998758831966754736</span><span class="p">,</span><span class="mi">34020826004970877240134787872651656341416368729440458356772758698852519328204528888078873163885699991764853721479123610703057</span><span class="p">),(</span><span class="mi">38966172409616242154304141143709898301034470122461722607712942742033687783643301247009025399729745022556064024850518869451975</span><span class="p">,</span><span class="mi">5981020799362018596735936290285344387211688865092193941491931169619830103374376973760714068642118719362457727239510914584312</span><span class="p">),</span> <span class="p">(</span><span class="mi">7012878627760257841132118070607478265284965240349652309759124191322573986096551843751246689024934516739883838453379849725751</span><span class="p">,</span> <span class="mi">21649710842932323285463795978767807324556917210964041962739790237236275762823921746606063379573395895459130209397906892095198</span><span class="p">),(</span><span class="mi">16507820273786900224618748750477369369775435705316765856004067873105139579722596955551099931764203698774088259217970865323799</span><span class="p">,</span><span class="mi">9928713485305875739506130889554325411729009153463022555918280976553112545014442785040986950316547911895874494514074098917894</span><span class="p">),</span> <span class="p">(</span><span class="mi">14055726663591292873961297946052533592325700065779495995571239086780922293043115049640092519426435728577412970964860502584449</span><span class="p">,</span><span class="mi">30485748320816380831514092554721453382052900140209991279839693184940939803544687454557399278030782153436443843797878162131674</span><span class="p">),(</span><span class="mi">19284533584902441535038251888281949359237393762112655572077569950661307649081647225051558606183700516352557183155082396507339</span><span class="p">,</span><span class="mi">31789499814834902156506651897418657730851979924342092149083494301240879566203258318324279812405062325758883084316388028234579</span><span class="p">),(</span><span class="mi">28563743478892127827438135408124657877593631512851235793560586090530615354590467727997486849059095488933932291824423145715989</span><span class="p">,</span><span class="mi">25665200201155002744035128647945633598163319971421639263108985895408409856469875694440510114104190480548047704288193118501977</span><span class="p">),(</span><span class="mi">8237411227822132038206373512614285405591981546461995832779339333592557055834188155984551094441805050462771868300394115224375</span><span class="p">,</span> <span class="mi">9885852244328856561608785982938660796665507504121412998798975798901881787628711681405954967253476772481210173364953121589569</span><span class="p">),</span> <span class="p">(</span><span class="mi">21181985550811301835779112200376346636025418520808320184931262305958073757014994270429006350952950798310763860866304539428929</span><span class="p">,</span><span class="mi">6884701502844069177625971506999045981345995595705569692948922952369734751204260690491272933693975446873824249524309618970166</span><span class="p">),</span> <span class="p">(</span><span class="mi">6788587008462034943410368611241496145015831006919232554367954799108989568960420306961801801625921628580097121258960350700616</span><span class="p">,</span> <span class="mi">7635783031494681408229331516727445970079910973779703487539674574209624228670655658114668541055090475326537403610663421717055</span><span class="p">),</span> <span class="p">(</span><span class="mi">34698918716321067804863000464018663206020680011298961086526003259750622996268085071858633541035040445940040693707640153655632</span><span class="p">,</span><span class="mi">16384492064938169922484926227544844042674774692541434008770082166704569520085415713559690586140748815044546227319134849083937</span><span class="p">),(</span><span class="mi">10658974785580326054433035059311986417475084708116100695444229265131486566672126986110855036056235411708879953276778915747801</span><span class="p">,</span> <span class="mi">512033780990944074185563748626730709761992606831859714133668839103428371946017012458822632270307898211602256126273987669132</span><span class="p">),</span> <span class="p">(</span><span class="mi">8622011872253081660673091782773585822060637051075312656402567659535855409821932333482382411981983992572035293537198471300443</span><span class="p">,</span> <span class="mi">39022515826644233788881586619347250212977673395132189646832370764675062592750514668680322547648802196304673254653571721291831</span><span class="p">),</span> <span class="p">(</span><span class="mi">733746435861052343265423986364461942348676907044568071574314976256865094935712580652635360676426823887304743127942655669737</span><span class="p">,</span> <span class="mi">35699658584837934841721507175186736204106629480007391268786882614665034436247870540906673672955477842345407758711255421701272</span><span class="p">),(</span><span class="mi">37939426890774994620687639386442335504804214910213475108653073835175095782887561413623491816689117769855921083421601000351221</span><span class="p">,</span><span class="mi">35484662781609586835666968283377268002573421586505838429006735486351151941782347671265691433508246152630679857286434611823446</span><span class="p">),(</span><span class="mi">27671434794626920166815769310586909573137141964976057656198980121930015805040405450922076489265137388163898643646828570297312</span><span class="p">,</span><span class="mi">15804008446744328534974710571663042229605689599724078001882369669149290404107074338305844058792073815442376248853911841614426</span><span class="p">),(</span><span class="mi">20950482645513610873765064128356556647853383897087887862635288029551420919838051885419671413603809323953440287910086578994272</span><span class="p">,</span><span class="mi">13179730620551517421814470850730448699505360331488970430430199559692709864311666620597196650579997342340297429683266669665805</span><span class="p">),(</span><span class="mi">38209802766336036826548158011858091566763499319755339954976644987497178193491031815701219011999258731732565706983754522742860</span><span class="p">,</span><span class="mi">32075952411759489640105226466556224741572861015631622764015731585347955580393913886424341362200247972419249692718256292405497</span><span class="p">),(</span><span class="mi">29715879263362133992147038430203964295629513055492327942093840791136536190075611961658831084719071107836887811583662865879707</span><span class="p">,</span><span class="mi">13919539779082633178483137734805867250894605291219091326819707826267111628567784026617883661947346871050484166323317372092681</span><span class="p">),(</span><span class="mi">17596448059924478922611374900453610553302087678439808939152903825727511660677906979887680120862442594782190195990376480227247</span><span class="p">,</span><span class="mi">18848917550521531970852496369038841222855249240611234505174458309342823960300837116527482677611242707548544929064942808521326</span><span class="p">),(</span><span class="mi">11694674951617050896888126743690058647375337519424427182693314257629019803360357415031340224437750579664116587883003716347322</span><span class="p">,</span><span class="mi">23769034524399304221482377572880603810420827986816819410647124240381458717464137504868299950648504922208277820779862263213253</span><span class="p">),(</span><span class="mi">28044352636044165142531892612483278790309014066998469173880740484234864937824324353622678955699284335850641632696218607711105</span><span class="p">,</span><span class="mi">36852342519447641222459786922480459165554935411917926715070142361516598240249543218059044962301159233451421107516861058931350</span><span class="p">),(</span><span class="mi">39472716548612380290361977865584209019941773021001278034808705016371847732706310749561371415767551848024898140778002489761104</span><span class="p">,</span><span class="mi">13778771389568946804361056265311684945284062484739422530826916480764877337518958508982589095578772377611594544422376483705189</span><span class="p">),(</span><span class="mi">12383735787832868736512166373154971015290898726854325082693549282798933504244296605160216975903246810620642146814345310554245</span><span class="p">,</span><span class="mi">14606252906250500651763421535808607189949773824275233075682901325789088277988476921580364063054361211058708760529784757163069</span><span class="p">),(</span><span class="mi">7911163544792784677994220674429320832525623274395272821492773307062011009307739889205201720778512712202950737090638605306941</span><span class="p">,</span> <span class="mi">32328838849120475224173379425480516068696470208616385098516834929939549599336938286263319475085712307078669689264043940279300</span><span class="p">),(</span><span class="mi">6806084376297874363978666332947512148582907530266444061137669650799184257952980294236356891605898752326730504084259266607078</span><span class="p">,</span> <span class="mi">4086053235856464049299978367263407974062293925257987675966363058200510421805899650679492916373893962060529530866829744661115</span><span class="p">),</span> <span class="p">(</span><span class="mi">20068421201757796406821504148184756417915558249894999425509689063181453172284226606798981021385347488384527499616803388564798</span><span class="p">,</span><span class="mi">10471301146159400545932616687757275132945443353048424290724629816042012731619948044876834966798469450294545018272842518767039</span><span class="p">),(</span><span class="mi">37732339642517665660573396789456436211371585579156819026373871223024196528579359580573460397737420382889142185220947626429988</span><span class="p">,</span><span class="mi">35588564732766799911411770707054827045426121818169585798083508100212146760878114879993716618460747691986999221885780988213939</span><span class="p">),(</span><span class="mi">18994922082342729210669842066574295649621438440922345176100372319975853401945330951612964095074112154449538291135263645795633</span><span class="p">,</span><span class="mi">7421835481723385629627683542845775174176654429284456417903254652848254644501526524277397274456927128375951677872783186544197</span><span class="p">),</span> <span class="p">(</span><span class="mi">10936179747633490187048811205659632385493108913888571448351520692827861401235904055783909618959144801043869111517493064450813</span><span class="p">,</span><span class="mi">37767515592460780812692994627273499472840828310356287804193220268370806467963587115872332370607004725228518423275190521909036</span><span class="p">),(</span><span class="mi">15578363357360720656604318751099363826610190567191944249530552187368108247234937882283894395989015950625087477601990604613568</span><span class="p">,</span><span class="mi">12944764605838608945255892796385860090328827583817839716418744552699643658761977975421689813669953770928326326679477989760425</span><span class="p">),(</span><span class="mi">18465487551066678587591230816929918491636227429489142712426400860471604878959497312492289805250369784518246291043516743718314</span><span class="p">,</span><span class="mi">33048932538804853453137676161648323915507524602563070414028513687897002445778522892502931139172408593517572601654502257710179</span><span class="p">),(</span><span class="mi">36405447831709193796097960326620635017451602614074697050898363305471353306230658731010486585219737953570079593165399424640077</span><span class="p">,</span><span class="mi">39408299074343594603359628294024899354312805473493079470807758263096873347563725962734813169017704613381036169912740705802415</span><span class="p">),(</span><span class="mi">31489959783721349126832583793042849991821734712454827062803050435506164238311383809821966356053124230213468581001961871705240</span><span class="p">,</span><span class="mi">1370610624414638548357272623280330236940111440345356060614790482301844799622501923372464196490616842945705405162689484422131</span><span class="p">),</span> <span class="p">(</span><span class="mi">38410418347480905434105603211519555470978675975416499460761655754318826230236231759067316884038352846297919716523834617388809</span><span class="p">,</span><span class="mi">38373076908014641207743595020405645972279538291511910579173338937672642301553739809924261109302942930372828119645211569180371</span><span class="p">),(</span><span class="mi">18699249088920525263336529579250720339651996780233633707443800456666031211347230017240747302897271985757953958425270369197271</span><span class="p">,</span><span class="mi">15810499777345670198178975014724801539468143573738090921792268760133300634100091531087694924391974063121939953084474417068575</span><span class="p">),(</span><span class="mi">26959780058637657932043291551863273749284276382492090808843948794474433894425495846938331234168041540969970436897968026924422</span><span class="p">,</span> <span class="mi">1575063286522455595288872157965487016380397319130447521930183949162108900735380591336731890417444500695552903110119195898094</span><span class="p">)]</span>

<span class="n">offentlig_nøkkel</span> <span class="o">=</span> <span class="p">[</span><span class="n">E</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">offentlig_nokkel_coords</span><span class="p">]</span>
<span class="n">resultat</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="mi">20651818137470466933477728509072550437756475330872536030571099768051457046843355623709212804930440099044049040144879241690983</span><span class="p">,</span><span class="mi">35600016854460355091451342763877862314510764810503386770058531389353025412814465374425619239887352848890007571085094884466047</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Computing discrete logs for public keys ..."</span><span class="p">)</span>
<span class="n">r_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">offentlig_nøkkel</span><span class="p">:</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>
	<span class="n">r_values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">order</span> <span class="o">=</span> <span class="n">G</span><span class="p">.</span><span class="n">order</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">discrete_log</span><span class="p">(</span><span class="n">resultat</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s">"+"</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_values</span><span class="p">)</span>
<span class="n">flag_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">(</span><span class="sa">f</span><span class="s">"x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">e_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s">"e"</span><span class="p">)</span>

<span class="n">equation</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">r_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">flag_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="n">e_var</span> <span class="o">==</span> <span class="n">X</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="n">flag_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)}</span>
<span class="n">bounds</span><span class="p">[</span><span class="n">e_var</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Solving modular linear equation using lattice reduction..."</span><span class="p">)</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">solve_linear_mod</span><span class="p">([</span><span class="n">equation</span><span class="p">],</span> <span class="n">bounds</span><span class="p">)</span>
<span class="n">recovered_flag</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="n">flag_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Recovered flag: </span><span class="si">{</span><span class="n">recovered_flag</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Flag: <code class="language-plaintext highlighter-rouge">helsectf{Ell1pt15k3_kurv3r_3r_l1vet!}</code></p>

    </div>
    <footer>
      <p>&copy; 2025 Zukane</p>
    </footer>
  </body>
</html>
